# 中央处理器  
---  
## CPU的功能和基本结构  
### CPU的功能  
中央处理器CPU由运算器和控制器组成。其中，控制器的功能是负责协调并控制计算机各部件执行程序的指令序列，包括取指令、分析指令和执行指令；运算器的功能是对数据进行加工。CPU的具体功能包括：  
+ 指令控制。完成取指令、分析指令和执行指令的操作，即程序的顺序控制。  
+ 操作控制。一条指令的功能往往由若干操作信号的组合来实现。CPU管理并产生由内存取出的每条指令的操作信号，把各种操作信号送往相应的部件，从而控制这些部件按指令的要求进行动作。  
+ 时间控制。对各种操作加以时间上的控制。时间控制要为每条指令按时间顺序提供应有的控制信号。  
+ 数据加工。对数据进行算术和逻辑运算。  
+ 中断处理。对计算机运行过程中出现的异常情况和特殊情况进行处理。  

### CPU的基本结构  
在计算机系统中，中央处理器主要由运算器和控制器两大部分组成。  
#### 运算器  
运算器接收从控制器送来的命令并执行相应的动作，对数据进行加工和处理。运算器是计算机对数据进行加工处理的中心，它主要由算术逻辑单元ALU、暂存寄存器、累加寄存器ACC、通用寄存器组、程序状态字寄存器PSW、移位器、计数器CT等组成。  
+ 算术逻辑单元。主要功能是进行算术和逻辑运算。  
+ 暂存寄存器。用于暂存从主存读来的数据，该数据不能存放在通用寄存器中，否则会被破坏其原有内容。**暂存寄存器对应用程序员是透明的。**  
+ 累加寄存器。它是一个通用寄存器，用于暂时存放ALU运算的结果信息，可以作为加法运算的一个输入端。  
+ 通用寄存器组。如AX、BX、CX、DX、SP等，用于存放操作数（包括源操作数、目的操作数及中间结果）和各种地址信息等。SP是堆栈指针，用于指示栈顶的地址。  
+ 程序状态字寄存器。保留由算术逻辑运算指令或测试指令而建立的各种状态信息，如溢出标志OF、符合标志SF、零标志ZF、进位标志CF等。PSW中的这些位参与并决定微操作的形成。  
+ 移位器。对操作数或运算结果进行移位运算。  
+ 计数器。控制乘除运算的操作步数。  

#### 控制器  
控制器是整个系统的指挥中枢，在控制器的控制下，运算器、存储器和输入/输出设备等功能部件构成一个有机的整体，根据指令的要求指挥全机协调工作。控制器的基本功能是执行指令，每条指令的执行是由控制器发出的一组微操作实现的。  
控制器有硬布线控制器和微程序控制器两种类型。  
控制器由程序计数器PC、指令寄存器IR、指令译码器、存储器地址寄存器MAR、存储器数据寄存器MDR、时序系统和微操作信号发生器等组成。  
+ 程序计数器。用于指出下一条指令在主存中的存放地址。CPU根据PC的内容去主存中取指令。因程序中指令（通常）是顺序执行的，所以PC有自增功能。  
+ 指令寄存器。用于保存当前正在执行的那条指令。  
+ 指令译码器。仅对操作码字段进行译码，向控制器提供特定的操作信号。  
+ 存储器地址寄存器。用于存放要访问的主存单元的地址。  
+ 存储器数据寄存器。用于存放向主存写入的信息或从主存读出的信息。  
+ 时序系统。用于产生各种时序信号，它们都由统一时钟CLOCK分频得到。  
+ 微操作信号发生器。根据IR的内容（指令）、PSW的内容（状态信息）及时序信号，产生控制整个计算机系统所需的各种控制信号，其结构有组合逻辑型和存储逻辑型两种。  

控制器的工作原理是，根据指令操作码、指令的执行步骤（微操作序列）和条件信号来形成当前计算机各部件要用到的控制信号。计算机整机各硬件系统在这些控制信号的控制下协同运行，产生预期的执行结果。  

---  
## 指令执行过程  
### 指令周期  
CPU从主存中取出并执行一条指令的时间称为指令周期，不同指令的指令周期可能不同。指令周期常用若干机器周期来表示，一个机器周期又包含若干时钟周期（也称节拍或T周期，它是CPU操作的最基本单位）。每个指令周期内的机器周期数可以不等，每隔机器周期内的节拍数也可以不等。  
对于无条件转移指令`JMP X`，在执行时不需要访问主存，只包含取指阶段（包含取指和分析）和执行阶段，所以其指令周期仅包含取指周期和执行周期。  
对于间接寻址的指令，为了取操作数，需要先访问一次主存，取出有效地址，然后访问主存，取出操作数，所以还需包括间址周期。间址周期介于取指周期和执行周期之间。  
当CPU采用中断方式实现主机和I/O设备的信息交换时，CPU在每条指令执行结束前，都要发中断查询信号，若有中断需求，则CPU进入中断响应阶段，又称中断周期。一个完整的指令周期应包括**取指、间址、执行和中断**4个周期。  

|取指周期|间址周期|执行周期|中断周期|  
|---|---|---|---|  

上述4个工作周期都有CPU访存操作，只是访存的目的不同。取指周期是为了取指令，间址周期是为了取有效地址，执行周期是为了取操作数，中断周期是为了保存程序断点。  
**为了区分不同的工作周期，在CPU内设置4个标志触发器FE、IND、EX和INT，它们分别对应取指、间址、执行和中断周期，并以“1”状态表示有效，分别由1->FE、1->IND、1->EX和1->INT这4个信号控制。**  
### 指令周期的数据流  
数据流是根据指令要求依次访问的数据序列。在指令执行的不同阶段，要求依次访问的数据序列是不同的。而且对于不同的指令，它们的数据流往往也是不同的。  
#### 取指周期  
取指周期的任务是根据PC中的内容从主存中取出指令代码并存放在IR中。  
PC中存放的是指令的地址，根据此地址从内存单元中取出的是指令，并放在指令寄存器IR中，取指令的同时，PC加1。  
取指周期的数据流向如下：  
+ PC->MAR->地址总线->主存  
+ CU发出控制信号->控制总线->主存  
+ 主存->数据总线->MDR->IR  
+ CU发出读命令->PC内容加1  

#### 间址周期  
间址周期的任务是**取操作数的有效地址**（执行周期才取实际的操作数）。一次间址的过程：将指令中的地址码送到MAR并送至地址总线，此后CU向存储器发读命令，以获取有效地址并存至MDR。  
间址周期的数据流向如下：  
+ Ad(IR)（或MDR）->MAR->地址总线->主存（取指周期结束后指令在MDR中也有一份）  
+ CU发出读命令->控制总线->主存  
+ 主存->数据总线->MDR(存放有效地址)  

其中，Ad(IR)表示取出IR中存放的指令字的地址字段。  
#### 执行周期  
执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果。不同指令的执行周期操作不同，因此没有统一的数据流向。  
#### 中断周期  
中断周期的任务是处理中断请求。假设程序断点存入堆栈中，并用SP指示栈顶地址，而且进栈操作是先修改栈顶指针，后存入数据（不同的数据结构定义规则对应的操作不一样）。  
中断周期的数据流向如下：  
+ CU控制将SP减1,SP->MAR->地址总线->主存  
+ CU发出写命令->控制总线->主存  
+ PC->MDR->数据总线->主存(程序断点存入主存)  
+ CU（中断服务程序的入口地址）->PC  

### 指令执行方案  
一个指令周期通常要包括几个时间段（执行步骤），每个步骤完成指令的一部分功能，几个一次执行的步骤完成这条指令的全部功能。由于性能和硬件成本等考虑，可以选用3种不同的方案来安排指令的执行步骤。  
#### 单指令周期  
对所有指令都选用相同的执行时间来完成，称为单指令周期方案。此时每条指令都在固定的时钟周期内完成，指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。因此，指令周期取决于执行时间最长的指令的执行时间。对于那些本来可以在更短时间内完成的指令，要使用这个较长的周期来完成，会降低整个系统的运行速度。  
#### 多指令周期  
对不同类型的指令选用不同的执行步骤来完成，称为多指令周期方案。指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。但可选用不同个数的时钟周期来完成不同指令的执行过程，指令需要几个周期就为其分配几个周期，而不再要求所有指令占用相同的执行时间。  
#### 流水线方案  
指令之间可以是并行执行的方案，称为流水线方案，其追求的目标是力争在每个时钟脉冲周期完成一条指令的执行过程（只在理想状态下才能达到该效果）。这种方案通过在每个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。  

---  
## 数据通路的功能和基本结构  
### 数据通路的功能  
数据在功能部件之间传送的路径称为数据通路。路径上的部件称为数据通路部件，如ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等。数据通路描述了信息从什么地方开始，中间经过哪些寄存器或多路开关，最后传送到哪个寄存器，这些都需要加以控制。  
数据通路中专门进行数据运算的部件称为执行部件或功能部件。数据通路由控制部件控制。数据通路的功能是实现CPU内部的运算器与寄存器及寄存器之间的数据交换。  
### 数据通路的基本结构  
数据通路的基本结构主要有以下几种：  
+ CPU内部单总线方式  
  将所有寄存器的输入端和输出端都连接到一条公共通路上，这种结果比较简单，但数据传输存在较多的冲突现象，性能较低。连接各部件的总线只有一条时，称为单总线结构；CPU中有两条或更多的总线时，构成双总线结构或多总线结构。  
+ CPU内部三总线方式  
  将所有寄存器的输入端和输出端都连接到多条公共通路上，相比之下单总线中一个时钟只允许传一个数据，因而指令执行效率很低，因此采用多总线方式，同时在多个总线上传送不同的数据，提高效率。  
+ 专用数据通路方式  
  根据指令的执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高，但硬件量大。  

#### 寄存器之间的数据传送  
寄存器之间的数据传送可通过CPU内部总线完成。某寄存器AX的输出和输入分别由AXout和AXin控制。若把PC内容传至MAR，实现传送操作的流程和控制信号为：  
`PC->Bus`PCout有效，PC内容送总线  
`Bus->MAR`MARin有效，总线内容送MAR  
#### 主存和CPU之间的数据传送  
主存和CPU之间的数据传送也要借助CPU内部总线完成。现以CPU从主存读取说指令为例说明数据在数据通路中的传送过程。实现传送操作的流程及控制信号为：  
`PC->Bus->MAR`PCout和MARin有效，现行指令地址->MAR  
`1->R`CU发出读命令  
`MEM(MAR)->MDR`MDRin有效  
`MDR->Bus->IR`MDRout和IRin有效，现行指令->IR  
#### 执行算术或逻辑运算  
执行算术或逻辑操作时，由于ALU本身是没有任何内部存储功能的组合电路，因此如要执行加法运算，相加的两个数必须在ALU的两个输入端同时有效。暂存器Y即用于该目的。先将一个操作数经CPU内部总线送入暂存器Y保存，Y的内容在ALU的左输入端始终有效，再将另一个操作数经总线直接送到ALU的右输入端。这样两个操作数都送入了ALU，运算结果暂存在暂存器Z中。  
`Ad(IR)->Bus->MAR`MDRout和MARin有效  
`1->R`CU发读命令  
`MEM->数据线->MDR`操作数从存储器->数据线->MDR  
`MDR->Bus->Y`MDRout和Yin有效，操作数->Y  
`(ACC)+(Y)->Z`ACCout和ALUin有效，CU向ALU发加命令，结果->Z  
`Z->ACC`Zout和ACCin有效，结果->ACC  
数据通路结构直接影响CPU内各种信息的传送路径，数据通路不同，指令执行过程的微操作序列的安排也不同，它关系着微操作信号形成部件的设计。  

---  
## 控制器的功能和工作原理  
### 控制器的结构和功能  
计算机硬件系统的主要部件和连接关系：  
+ 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据。  
+ 输入设备和输出设备通过接口电路与总线相连接。  
+ 内存储器、输入设备和输出设备从地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其他部件传送数据。  
+ 控制器部件从数据总线接收指令信息，从运算器部件接收指令转移地址，送出指令地址到地址总线，还要向系统中的部件提供它们运行所需要的控制信息。  

控制器是计算机系统的指挥中心，控制器的主要功能有：  
+ 从主存中取出一条指令，并指出下一条指令在主存中的位置。  
+ 对指令进行译码或测试，产生相应的操作控制信号，以便启动规定的动作。  
+ 指挥并控制CPU、主存、输入和输出设备之间的数据流动方向。  

根据控制器产生微操作控制信号的方式的不同，控制器可分为硬布线控制器和微程序控制器，两类控制器中的PC和IR是相同的，但确定和表示执行步骤的方法以及给出控制各部件运行所需要的控制信号的方案时不同的。  
### 硬布线控制器  
硬布线控制器的基本原理是根据指令的要求、当前的时序及外部和内部的状态，按时间的顺序发送一系列微操作控制信号。它由复杂的组合逻辑门电路和一些触发器构成，因此又称组合逻辑控制器。  
#### 硬布线控制单元  
指令的操作码是决定控制单元发出不同操作命令（控制信号）的关键。为了简化控制单元（CU）的逻辑，将指令的操作码译码和节拍发生器从CU分离出来。  
CU的输入信号来源如下：  
+ 经指令译码器译码产生的指令信息。现行指令的操作码决定了不同指令在执行周期所需完成的不同操作，因此指令的操作码字段时控制单元的输入信号，它和时钟配合产生不同的控制信号。  
+ 时序系统产生的机器周期信号和节拍信号。为了使控制单元按一定的先后顺序、一定的节奏发出各个控制信号，控制单元必须受时钟控制，即一个时钟脉冲使控制单元发送一个操作命令，或发送一组需要同时执行的操作命令。  
+ 来自执行单元的反馈即标志。控制单元有时需要依赖CPU当前所处的状态产生控制信号。  
个别指令的操作不仅受操作码控制，还受状态标志控制，因此CU的输入来自操作码译码电路ID、节拍发生器及状态标志，其输出到CPU内部或外部控制总线上。  
#### 硬布线控制器的时序系统及微操作  
+ 时钟周期  
  用时钟信号控制节拍发生器，可以产生节拍，每个节拍的宽度正好对应一个时钟周期。在每个节拍内机器可以完成一个或几个需同时执行的操作。  
+ 机器周期  
  机器周期可视为所有指令执行过程中的一个基准时间。不同指令的操作不同，指令周期也不同。访问一次存储器的时间是固定的，因此通常以存取周期为基准时间，即内存中读取一个指令字的最短时间作为机器周期。在存储字长等于指令字长的前提下，取指周期也可视为机器周期。  
  在一个机器周期里可完成若干微操作，每个微操作都需一定的时间，可用时钟信号来控制产生每个微操作命令。  
+ 指令周期  
#### CPU的控制方式  
控制单元控制一条指令执行的过程，实质上是依次执行一个确定的微操作序列的过程。由于不同指令所对应的微操作数及复杂程度不同，因此每条指令和每隔微操作所需的执行时间也不同。主要有以下3种控制方式：  
+ 同步控制方式  
  所谓同步控制方式，是指系统有一个统一的时钟，所有的控制信号均来自这个同一的时钟信号。通常以最长的微操作序列和最烦琐的微操作作为标准，采取完全统一的、具有相同时间间隔和相同数目的节拍作为机器周期来运行不同的指令。  
+ 异步控制方式  
  异步控制方式不存在基准时标信号，各部件按自身固有的速度工作，通过应答方式进行联络。  
  异步控制方式的优点是运行速度快，缺点是控制电路比较复杂。  
+ 联合控制方式  
  联合控制方式是介于同步、异步之间的一种折中。这种方式对各种不同的指令的微操作实现大部分采用同步控制方式、小部分采用异步控制的方法。  
### 微程序控制器  
微程序控制器采用存储逻辑实现，也就是把微操作信号代码化，使每条机器指令转化称为一段微程序并存入一个专门的存储器（控制存储器）中，微操作控制信号由微指令产生。  
#### 微程序控制的基本概念  
**微程序设计思想就是将每条机器指令编写成一个微程序，每隔微程序包含若干微指令，每条微指令对应一个或几个微操作命令。** 这些微程序可以存放到一个控制存储器中，用寻址用户程序机器指令的办法来寻址每隔微程序中的微指令。目前，大多数计算机都采用微程序设计技术。  