# 存储系统  
---
## 存储器概述  
### 存储器的分类  
存储器种类繁多，可以从不同角度对存储器进行分类。  
+ 按在计算机中的作用（层次）分类  
  - 主存储器。简称主存，又称内存储器（内存），用来存放计算机运行期间所需的大量程序和数据，CPU可以直接随机地对其进行访问，也可以和高速缓冲存储器（Cache）及辅助存储器交换数据。其特点是容量小、存取速度较快、每位价格较高。  
  - 辅助存储器。简称辅存，又称外存储器（外存），是主存储器的后援存储器，用来存放当前暂时不用的程序和数据，以及一些需要永久性保存的信息，**它不能与CPU直接交换信息**。其特点是容量极大、存取速度较慢、单位成本低。  
  - 高速缓冲存储器。简称Cache，位于主存和CPU之间，用来存放正在执行的程序段和数据，以便CPU能够高速地使用它们。Cache的存取速度可与CPU的速度相匹配，但存储容量小、价格高。目前的高档计算机通常把它们制作在CPU中。  
+ 按存储介质分类  
按存储介质，存储器可分为磁表面存储器（磁盘、磁带）、磁心存储器半导体存储器（MOS型存储器、双极型存储器）和光存储器（光盘）。  
+ 按存取方式分类  
  - 随机存储器RAM。存储器的任何一个存储单元的内容都可以随机存取，而且存取时间与存储单元的物理位置无关。其优点是读写方便、使用灵活，主要用作主存或高速缓冲存储器。RAM可分为静态RAM（以触发器原理寄存信息）和动态RAM（以电容充电原理寄存信息）。  
  - 只读存储器ROM。存储器的内容只能随机读出而不能写入。信息一旦写入存储器就固定不变，即使断电，内容也不会丢失。因此，通常用它存放固定不变的程序、常数和汉字字库，甚至用于操作系统的固化。**它与随机存储器可共同作为主存的一部分，统一构成主存的地址域**。  
  由ROM派生出的存储器也包含可反复重写的类型，ROM和RAM的存取方式均为随机存取。广义上的只读存储器已可通过电擦除等方式进行写入，其“只读”的概念没有保留，但仍然保留了断电内容保留、随机读取特性，但其写入速度比读取速度慢得多。  
  - 串行访问存储器。对存储单元进行读/写操作时，需按其物理位置的先后顺序寻址，包括顺序存取存储器（如磁带）与直接存取存储器（如磁盘）。  
  顺序存取存储器的内容只能按某种顺序存取，存取时间的长短与信息在存储体上的物理位置有关，其特点是存取速度慢。直接存取存储器既不像RAM那样随机地访问任何一个存储单元，又不像顺序存取存储器那样完全按顺序存取，而是介于两者之间。存取信息时通过先寻找整个存储器中的某个小区域（如磁盘上的磁道），再在小区域内顺序查找。  
+ 按信息的可保存性分类  
断电后，存储信息即消失的存储器，称为易失性存储器，如RAM。断电后信息仍然保持的存储器，称为非易失性存储器，如ROM、磁表面存储器和光存储器。若某个存储单元所存储的信息被读出时，原存储信息被破坏，则称为破坏性读出；若读出时，被读单元原存储信息不被破坏，则称为非破坏性读出。具有破坏性读出性能的存储器，每次读出操作后，必须紧接一个再生的操作，以便恢复被破坏的信息。  
### 存储器的性能指标  
存储器有3个主要想性能指标，即存储容量、单位成本和存储速度。这三个指标相互制约，设计存储器系统所追求的目标就是大容量、低成本和高速度。  
+ 存储容量=存储字数×字长。存储字数表示存储器的地址空间大小，字长表示一次存储操作的数据量 
+ 单位成本。每位价格=总成本/总容量  
+ 存储速度。数据传输率=数据的宽度/存储周期  
  - 存取时间(T<sub>a</sub>)：存取时间是指从启动一次存储器操作到完成该操作所经历的时间，分为读出时间和写入时间。  
  - 存取周期(T<sub>m</sub>)：存取周期又称读写周期或访问周期。它是指存储器进行一次完整的读写操作所需的全部时间，即连续两次独立访问存储器操作（读或写操作）之间所需要的最小时间间隔。  
  - 主存带宽(B<sub>m</sub>)：主存带宽又称数据传输率，表示每秒从主存进出的信息的最大数量，单位为字/秒、字节/秒或位/秒。  

**存取时间不等于存储周期，通常存储周期大于存取时间。这是因为对任何一种存储器，在读写操作之后，总要有一段恢复内部状态的复原时间。** 对于破坏性读出的存储器，存储周期往往比存取时间大得多，甚至可达T<sub>m</sub>=2T<sub>a</sub>，因为存储器中的信息读出后需要马上进行再生。  

---  
## 存储器的层次化结构  
### 多级存储系统  
为了解决存储系统大容量、高速度和低成本3个相互制约的矛盾，在计算机系统中，通常采用多级存储器结构。  
实际上，存储系统层次结构主要体现在“Cache-主存”层次和“主存-辅存”层次。前者主要解决CPU和主存速度不匹配的问题，后者主要解决存储系统的容量问题。在存储体系中，Cache、主存能与CPU直接交换信息，辅存则要通过主存与CPU交换信息；主存与CPU、Cache、辅存都能交换信息。  
存储器层次结构的思想主要上一层的存储器作为低一层存储器的高速缓存。从CPU的角度看，“Cache-主存”层次速度接近于Cache，容量和价格却接近于主存。从“主存-辅存”层次分析，其速度接近于主存，容量和价格却接近于辅存。这就解决了速度、容量、成本这三者之间的矛盾，现代计算机系统几乎都采用这种三级存储系统。需要注意的是，**主存和Cache之间的数据调动是由硬件自动完成的，对所有程序员均是透明的；而主存和辅存之间的数据调动则是由硬件和操作系统共同完成的，对应用程序员是透明的。**  
在“主存-辅存”这一层次的不断发展中，逐渐形成了虚拟存储系统，在这个系统中程序员编程的地址范围与虚拟存储器的地址空间相对应。对具有虚拟存储器的计算机系统而言，编程时可用的地址空间远大于主存空间。  

---  
## 半导体随机存储器  
主存储器由DRAM实现，靠处理器的那一层（Cache）则由SRAM实现，它们都属于易失性存储器，只要电源被切断，原来保存的信息便会丢失。DRAM的每比特成本低于SRAM，速度也慢于SRAM，价格差异主要是因为制作DRAM需要更多的硅。而ROM属于非易失性存储器。  
### SRAM和DRAM  
#### SRAM的工作原理  
通常把存放一个二进制的物理器件称为存储元，它是存储器的最基本的构件。地址码相同的多个存储元构成一个存储单元。若干存储单元的集合构成存储体。静态随机存储器SRAM的存储元是用双稳态触发器（六晶体管MOS）来记忆信息的，因此即使信息被读出后，它仍保持其原状态而不需要再生（非破坏性读出）。  
SRAM的存取速度快，但集成度低，功耗较大，所以一般用来组成高速缓冲存储器。  
#### DRAM的工作原理  
与SRAM的存储原理不同，动态随机存储器（DRAM）是利用存储元电路中栅极电容上的电荷来存储信息的，DRAM的基本存储元通常只使用一个晶体管，所以它比SRAM的密度要高很多。DRAM采用地址复用技术，地址线是原来的1/2，且地址信号分行、列两次传送。  
相对于SRAM来说，DRAM具有容易集成、位价低、容量大和功耗低等优点，但DRAM的存取速度比SRAM的慢，一般用来组成大容量主存系统。  
DRAM电容上的电荷一般只能维持1-2ms，因此即使电源不断电，信息也会自动消失。为此，每隔一定时间必须刷新，通常取2ms，这个时间称为刷新周期。常用的刷新方式有3种：集中刷新、分散刷新和异步刷新。  
+ 集中刷新：指在一个刷新周期内，利用一段固定的时间，依次对存储器的所有行进行逐一再生，在此期间停止对存储器的读写操作，称为“四时间”，又称访存“死区”。  
集中刷新的优点是读写操作不受刷新工作的影响，因此系统的存取速度较高；缺点是在集中刷新期间（死区）不能访问存储器。  
+ 分散刷新：把对每行的刷新分散到各个工作周期中。这样，一个存储器的系统工作周期分为两部分：前半部分用于正常读、写或保持；后半部分用于刷新某一行。这种刷新方式增加了系统的存取周期。  
分散刷新的优点是没有死区；缺点是加长了系统的存取周期，降低了整机的速度。  
+ 异步刷新：异步刷新是前两种方法的结合，它既可缩短“死时间”，又能充分利用最大刷新间隔2ms的特点。具体做法是将刷新周期除以行数，得到两次刷新操作之间的时间间隔t，利用逻辑电路每隔时间t产生一次刷新请求。这样可以避免使CPU连续等待过长的时间，而且减少了刷新次数，从根本上提高了整机的工作效率。  
**若将刷新安排在不需要访问存储器的译码阶段，则既不会加长存取周期，又不会产生“死时间”，这事分散刷新方式的发展，也称为“透明刷新”**。  

DRAM的刷新需要注意以下问题：  
+ 刷新对CPU是透明的，即刷新不依赖于外部的访问。  
+ 动态RAM的刷新单位是行，因此刷新操作时仅需要行地址。  
+ 刷新操作类似于读操作，但又有所不同。刷新操作仅给栅极电容补充电荷，不需要信息输出。另外，刷新时不需要选片，即整个存储器中所有芯片同时被刷新。  

#### 存储器的读、写周期  
1. RAM的读周期  
从给出有效地址开始，到读出所选中单元的内容并在外部数据总线上稳定地出现所需的时间，称为读出时间（t<sub>A</sub>）。地址片选信号CS必须保持到数据稳定输出，t<sub>CO</sub>为片选的保持时间，在读周期中WE为高电平。  
读周期和读出时间是两个不同的概念，读周期（t<sub>RC</sub>）表示存储芯片进行两次连续读操作时必须间隔的时间，它总是大于等于读出时间。  
1. RAM的写周期  
要实现写操作，要求片选信号CS和写命令WE必须都为低电平。为使数据总线上的信息能够可靠地写入存储器，要求CS信号与WE信号相“与”的宽度至少为t<sub>W</sub>。  
为了保证在地址变化期间不会发生错误写入而破坏存储器的内容，WE信号在地址变化器件必须为高电平。为了保证有效数据的可靠写入，地址有效的时间至少应为t<sub>WC</sub>=t<sub>AW</sub>+t<sub>W</sub>+t<sub>WR</sub>。为了保证在WE和CS变为无效前能把数据可靠地写入，要求写入的数据必须在t<sub>DW</sub>以前在数据总线上已经稳定。  

### 只读存储器  
#### 只读存储器ROM的特点  
ROM和RAM都是支持随机存储器的存储器，其中SRAM和DRAM均为易失性半导体存储器。而ROM中一旦有了信息，就不能轻易改变，即使掉电也不会丢失，它在计算机系统中是只供读出的存储器。ROM器件有两个显著的优点：  
+ 结构简单，所以位密度比可读写存储器的高  
+ 具有非易失性，所以可靠性高  
#### ROM的类型  
根据制作工艺的不同，ROM可分为掩模式只读存储器MROM、一次可编程只读存储器PROM、可擦除可编程只读存储器EPROM、闪速存储器Flash Memory和固态硬盘Solid State Drivers。  
+ 掩模式只读存储器  
MROM的内容由半导体制造厂按照用户提出的要求在芯片的生产过程中直接写入，写入后任何人都无法改变其内容。优点是可靠性高，集成度高，价格便宜；缺点是灵活性差。  
+ 一次可编程只读存储器  
PROM是可以实现一次性编程的只读存储器。允许用户利用专门的设备（编程器）写入自己的程序，一旦写入，内容就无法改变。  
+ 可擦除可编程只读存储器  
EPROM不仅可以由用户利用编程器写入信息，而且可以对其内容进行多次改写。需要修改EPROM的内容时，先将其全部内容擦除，然后编程。EPROM可分为两个，即紫外线擦除UVEPROM和电擦除E<sup>2</sup>PROM。EPROM虽然既可读又可写，但它不能取代RAM，因为EPROM的编程次数有限，且写入时间过长。  
+ 闪速存储器  
Flash Memory是在EPROM和E<sup>2</sup>PROM的基础上发展起来的，其主要特点是既可在不加电的情况下长期保存信息，又能在线进行快速擦除与重写。闪存存储器既有EPROM的价格便宜、集中度高的优点，又有E<sup>2</sup>PROM电可擦除重写的特点，且擦除重写的速度快。  
+ 固态硬盘  
基于闪存的固态硬盘是用固态电子存储芯片阵列制成的硬盘，由控制单元和存储单元FLASH芯片组成。保留了Flash Memory长期保存信息、快速擦除和重写的特性。对比传统硬盘也具有读写速度快、低功耗的特性，缺点是价格较高。  
### 主存储器的基本组成  
主存储器是由一个个的记忆单元（存储元件）构成的存储矩阵（也称存储体）是存储器的核心部分。记忆单元是具有两种稳态的能表示二进制0和1的物理器件。为了存取存储体中的信息，必须对存储单元编号（也称编址）。编制单位是指具有相同地址的那些存储元件构成的一个单位，可以按字节编址，也可以按字编址。现代计算机通常采用字节编址方式，此时存储体内的一个地址中有1字节。  
指令执行过程中需要访问主存时，CPU首先把被访问单位的地址送到MAR中，然后通过地址线（单向）将主存地址送到主存中的地址寄存器，以便地址译码器进行译码选中相应单元，同时CPU将读写信号通过控制线送到主存的读写控制电路。如果是写操作，那么CPU同时将要写的信息送到MDR中，在读写控制逻辑电路的控制下，经数据线（双向）将信号写入选中的单元；如果是读操作，那么主存读出选中单元的内容到数据线，然后送到MDR中。**数据线的宽度与MDR的宽度相同，地址线的宽度与MAR的宽度相同。**  

---  
## 主存储器与CPU的连接  
### 连接原理  
+ 主存储器通过数据总线、地址总线和控制总线与CPU连接  
+ 数据总线的位数与工作频率的乘积正比于数据传输率  
+ 地址总线的位数决定了可寻址空间的最大范围  
+ 控制总线（读/写）指出总线周期的类型和本次输入/输出操作完成的时刻  
### 主存容量的扩展  
由于单个存储芯片的容量是有限的，它在字数或字长方面与实际存储器的要求都有差距，因此需要在字和位两方面进行扩充才能满足实际存储器的容量要求。通常采用位扩展法、字扩展法和字位同时扩展法来扩展主存容量。  
#### 位扩展法  
CPU的数据线数与存储芯片的数据位数不一定相等，此时必须对存储芯片扩位（即进行位扩展，用多个存储器件对字长进行扩充，增加存储字长），使其数据位数与CPU的数据线数相等。  
位扩展的连接方式是将多个存储芯片的地址端、片选端和读写控制端并联，数据端分别引出。  
**片选信号CS需连接到所有芯片**  
#### 字扩展法  
子扩展是指增加存储器中字的数量，而位数不变。字扩展将芯片的地址线、数据线、读写控制线相应并联，而由片选信号来区分各芯片的地址范围。  
**片选信号CS或采用译码器设计连接到需要使用的芯片**  
#### 字位同时扩展法  
实际上，存储器往往需要同时扩充字和位。字位同时扩展是指即增加存储字的数量，又增加存储字长。  
**片选信号CS或采用译码器设计连接到需要使用的芯片**  
### 存储芯片的地址分配和片选  
CPU要实现对存储单元的访问，首先要选择存储芯片，既进行片选；然后为选中的芯片依地址码选择相应的存储单元，以进行数据的存取，即进行字选。片内的字段通常是由CPU送出的N条低位地址线完成的，地址线直接接到所有存储芯片的地址输入端（N由片内存储容量2<sup>N</sup>决定）。片选信号的产生分为线选法和译码片选法。  
#### 线选法  
线选法用除片内寻址外的高位地址线直接（或经反相器）分别接至各个存储芯片的片选端，当某地址线的信息为“0”时，就选中与之对应的存储芯片。这些片选信号线每次寻址时只能一位有效，不允许同时有多位有效，这样才能保证每次只选中一个芯片或芯片组。  
优点：不需要地址译码器，线路简单。  
缺点：地址空间不连续，选片的地址线必须分时为低电平，不能充分利用系统的存储器空间，造成地址资源的浪费。  
#### 译码片选法  
译码片选法用除片内寻址外的高位地址线通过地址译码器芯片产生片选信号。  
### 存储器与CPU的连接  
#### 合理选择存储芯片  
要组成一个系统，选择存储芯片是第一步，主要指存储芯片的类型RAM或ROM和数量的选择。通常选用ROM存放系统程序、标准子程序和各类常数，RAM则是为用户编程而设置的。此外，在考虑芯片数量时，要尽量使连线简单、方便。  
#### 地址线的连接  
存储芯片的容量不同，其地址线数也不同，而CPU的地址线往往比存储芯片的地址线数要多。通常将CPU地址线的低位与存储芯片的地址线相连，以选择芯片中的某一单元（字选），这部分的译码是由芯片的片内逻辑完成的。而CPU地址线的高位则在扩充存储芯片时使用，用来选择存储芯片（片选），这部分译码由外接译码器逻辑完成。  
#### 数据线的连接  
CPU的数据线数与存储芯片的数据线数不一定相等，在相等时可直接相连；在不等时必须对存储芯片扩位，使其数据位数与CPU的数据线数相等。  
#### 读/写命令线的连接  
CPU读/写命令线一般可直接与存储芯片的读/写控制端相连，通常高电平为读，低电平为写。有些CPU的读/写命令线是分开的，均为低电平有效，此时CPU的读命令线应与存储芯片的允许读控制端相连，而CPU的写命令线则应与存储芯片的允许写控制端相连。  
#### 片选线的连接  
片选线的连接是CPU与存储芯片连接的关键。存储器由许多存储芯片叠加而成，哪一片被选中完全取决于该存储芯片的片选控制端CS能否接受到来自CPU的片选有效信号。  
片选有效信号与CPU的访存控制信号<span style="text-decoration:overline">MREQ</span>（低电平有效）有关，因为只有当CPU要求访问时，才要求选中存储芯片。若CPU访问I/O，则<span style="text-decoration:overline">MREQ</span>为高，表示不要求存储器工作。
