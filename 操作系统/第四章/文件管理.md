# 文件管理  
## 文件系统基础  
### 文件的概念  
1. 文件的定义  
文件是操作系统中的一个重要概念。文件是以计算机硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、程序等。在系统运行时，计算机以进程为基本单位进行资源的调度和分配；而在用户进行的输入、输出中，则以文件为基本单位。大多数应用程序的输入都是通过文件来实现的，其输出也都保存在文件中，以便信息的长期存储及将来的访问。当用户将文件用于应用程序的输入、输出时，还希望可以访问文件、修改文件和保存文件等，实现对文件的维护管理，这就需要系统提供一个文件管理系统，操作系统中文件系统就是用于实现用户的这些管理要求的。  
文件的组成：  
首先，文件中肯定包括一块存储空间，更准确的说，是存储空间中的数据；其次，由于操作系统要管理成千上万的数据，因此必定需要对这些数据进行划分，然后贴上“标签”，以便于分类和索引，所以文件必定包含分类和索引的信息；最后，不同的用户拥有对数据的不同访问权限，因此文件中一定含有一些关于访问权限的信息。  
从用户的角度看，文件系统是操作系统的重要部分之一。用户关心的是如何命名、分类和查找文件，如何保证文件数据的安全性及对文件可以进行哪些操作等，而对其中的细节，如文件如何存储在辅存上、如何管理文件辅存区域等关心甚少。  
文件系统提供了与二级存储相关的资源的抽象，让用户能在不了解文件的各种属性、文件存储介质的特征及文件在存储介质上的具体位置等情况下，方便快捷地使用文件。  
用于通过文件系统建立文件，提供应用程序的输入、输出，对资源进行管理。首先了解文件的结构，文件自底向上的定义如下：  
+ 数据项。数据项是文件系统中最低级的数据组织形式，可分以下两种类型。  
  - 基本数据项。用于描述一个对象的某种属性的一个值，如姓名、日期或证件号等，是数据中可命名的最小逻辑数据单位，即原子数据。  
  - 组合数据项。由多个基本数据项组成。  
+ 记录。记录是一组相关的数据项的集合，用于描述一个对象在某方面的属性。  
+ 文件。文件是指由创建者所定义的一组相关信息的集合，逻辑上可分为有结构文件和无结构文件两种。  
  - 有结构文件。文件由一组相似的记录组成，又称记录式文件。  
  - 无结构文件。无结构文件被视为一个字符流，又称流式文件。  
2. 文件的属性  
文件具有一定的属性，系统不同，属性也会有所不同，但通常都包括如下属性：  
+ 名称。文件名称唯一，以容易读取的形式保存。  
+ 标识符。标识文件系统内文件的唯一标签，通常为数字，是对人不可读的一个内部名称。  
+ 类型。被支持不同类型的文件系统所使用。  
+ 位置。指向设备和设备上文件的指针。  
+ 大小。文件当前大小（用字节、字或块表示），也可包含文件允许的最大值。  
+ 保护。对文件进行保护的访问控制信息。  
+ 时间、日期和用户标识。文件创建、上次修改和上次访问的相关信息，用于保护和跟踪文件的使用。  
**所有文件的信息都被保存在目录结构中，而目录结构保存在外存上。文件信息在需要时才调入内存。通常，目录条目包括文件名称及其唯一的标识符，而标识符定位其他属性的信息。**  
3. 文件的基本操作  
文件属于抽象数据类型。为了恰当地定义文件，需要考虑有关文件的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、删除和截断等操作。  
+ 创建文件。  
创建文件有两个必要步骤:  
  - 在文件系统中为文件找到空间  
  - 在目录中为新文件创建条目，该条目记录文件名称、在文件系统的位置及其他可能的信息。  
+ 写文件  
为了写文件，执行一个系统调用，指明文件名称和要写入文件的内容。对应给定文件名称，系统搜索目录以查找文件位置。系统必须为该文件维护一个写位置的指针。每当发生写操作时，便更新写指针。  
+ 读文件  
为了读文件，执行一个系统调用，指明文件名称和要读入文件块的内存位置。同时，需要搜索目录以找到相关的目录项，系统维护一个读位置的指针。每当发生读操作时，更新读指针。一个进程通常只对一个文件读或写，因此当前操作系统位置可作为每个进程当前文件位置的指针。由于读和写操作都使用了同一指针，因此节省了空间，也降低了系统复杂度。  
+ 文件重定位（文件寻址）  
按某条件搜索目录项，将当前文件位置设为给定值，并且不会读、写文件。  
+ 删除文件  
先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件所占用的存储空间。  
+ 截断文件  
允许文件所有属性不变，并删除文件内容，即将其长度设为0并释放其空间。  
这6个基本操作可以组合起来执行其他文件操作。  
4. 文件的打开与关闭  
因为许多文件操作都涉及为给定文件搜索相关目录条目，因此许多系统要求在首次使用文件时，使用系统调用open指明文件的属性（包括该文件在外存上的物理位置）从外存复制到内存打开文件表的一个表目中，并将该表目的编号（也称索引）返回给用户。操作系统维护一个包含所有打开文件信息的表（打开文件表，open-file table）。当用户需要一个文件操作时，可以通过该表的一个索引指定文件，因此忽略了搜索环节。当文件不再使用时，进程可以关闭它，操作系统从打开文件表中删除这一条目。  
大部分操作系统要求在文件使用之前就被显式地打开。操作open会根据文件名搜索目录，并将目录条目复制到打开文件表。若调用open的请求（创建、只读、读写、添加等）得到允许，则进程就可打开文件，而open通常返回一个指向打开文件表中的一个条目的指针。通过该指针进行所有I/O操作，以简化步骤并节省资源。  
**在open调用完成后，操作系统对该文件的任何操作都不再需要文件名，而只需要通过open调用返回的指针。**  
整个系统表包含进程相关信息，如文件在磁盘的位置、访问日期和大小。一个进程打开一个文件，系统打开文件表就会为打开的文件增加相应的条目。当另一个进程执行open时，只不过是在其进程打开表中增加一个条目，并指向整个系统表的相应条目。通常，系统打开文件表的每个文件时，还用一个文件打开计数器（open count），以记录多少进程打开了该文件。每个关闭操作close使count递减，当打开计数器为0时，表示该文件不再被使用，系统将回收分配给该文件的内存空间等资源。若文件被修改过，则将文件写回外存，并将系统打开文件表中的相应条目删除，最后释放文件的文件控制块FCB。  
每个打开文件都有如下关联信息：  
+ 文件指针  
系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。  
+ 系统打开计数  
文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间会不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。计数器跟踪打开和关闭的数量，计数为0时，系统关闭文件，删除该条目。  
+ 文件磁盘位置  
绝大多数文件操作都要求系统修改文件数据。该信息保存在内存中，以免每个操作都从磁盘中取出。  
+ 访问权限  
每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）。该信息保存在进程的打开文件表中，以便操作系统能够运行或拒绝之后的I/O请求。  

### 文件的逻辑结构  
文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构（又称文件的存储结构）是从实现观点出发看到的文件在外存上的存储组织形式。文件的逻辑结构与存储介质特性无关，但文件的物理结构与存储介质的特性有很大关系。文件的逻辑结构实际上是指在文件的内部，数据逻辑上是如何组织起来的。  
按逻辑结构，文件可划分为无结构文件和有结构文件两种。  
1. 无结构文件（流式文件）  
无结构文件是最简单的文件组织形式。无结构文件将数据按顺序组织成记录并几类、保存，它是有序相关信息项的集合，以字节为单位。由于无结构文件没有结构，而面对记录的访问只能通过穷举搜索的办法，故这种文件形式对大多数应用不适用。但字符流的无结构文件管理简单，用户可以方便对其进行操作。所以，那些对于基本信息单位操作不多的文件较适于采用字符流的无结构方式，如原程序文件、目标代码文件等。  
2. 有结构文件（记录式文件）  
有结构文件按记录的组织形式可以分为如下几种：  
+ 顺序文件  
文件中的记录一个接一个地顺序排列，记录通常是定长的，可以顺序存储或以链表形式存储，在访问时需要顺序搜索文件。顺序文件有以下两种结构：第一种是串结构，记录之间的顺序与关键字无关。通常的办法是由时间决定，即按存入时间的先后排列，最先存入的记录为第一条记录，其次存入的为第二条记录，以此类推。第二种是顺序结构，指文件中所有记录按关键字顺序排列。  
在对记录进行批量操作，即每次要读或写一大批记录时，顺序文件的效率是所有逻辑文件中最高的；此外，也只能顺序文件才能存储在磁带上，并能有效地工作，但顺序文件对查找、修改、增加和删除单条记录的操作比较困难。  
+ 索引文件  
对于定长记录文件，要查找第i条记录，可直接通过计算得出第i条记录相对于第一条记录的地址`Ai = i × L`，然而，对于可变长记录的文件，要查找第i条记录，必须顺序地查找前i-1条记录，从而获得相应记录的长度，进而算出第i条记录的首址。  
变长记录文件只能顺序查找，系统开销较大。为此，可以建立一张索引表以加快检索速度，**索引表本身是定长记录的顺序文件**。在记录很多或访问要求很高的文件中，需要引入索引以提供有效的访问。实际中，通过索引可以成百上千倍地提高访问速度。  
+ 索引顺序文件  
索引顺序文件是顺序和索引两种组织形式的结合。索引顺序文件将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中为每组中的第一条记录建立一个索引项，其中含有该记录关键字值和指向该记录的指针。  
对于含有N条记录的顺序文件，查找某关键字值的记录时，评价需要查找N/2次。在索引顺序文件中，假设N条记录分为N^(1/2)组，索引表中有N^(1/2)个表项，每组有N^(1/2)条记录，在查找某关键字值的记录时，先顺序查找索引表，需查找N^(1/2)/2次，然后在主文件中对应的组中顺序查找，也需要查找N^(1/2)/2次，因此共需要查找N^(1/2)次。显然，索引顺序文件提高了查找效率，若查找记录甚多，则可采用两级或多级索引。  
+ 直接文件或散列文件  
给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址。这种映射结构不同于顺序文件或索引文件，没有顺序的特性。散列文件有很高的存取速度，但是会存在冲突，即不同关键字的散列函数值相同。  
### 目录结构  
与文件管理系统和文件集合相关联的是文件目录，**它包含有关文件的信息如属性、位置和所有权等**，这些信息主要由操作系统进行管理。目录管理的基本要求：从用户角度看，目录在用户（应用程序）所需要的文件名和文件之间提供一种映射，所以目录管理要实现“按名存取”；目录存取的效率直接影响到系统的性能，所以要提高对目录的检索速度；在共享系统中，目录还需要提供用于用于控制访问文件的信息。此外，文件允许重名也是用户的合理和必然要求，目录管理通过树形结构来解决和实现。  
1. 文件控制块和索引节点  
与进程管理一样，为实现目录管理，操作系统中引入了文件控制块的数据结构。  
+ 文件控制块FCB  
文件控制块是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。  
FCB主要包含以下信息：  
  - 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。  
  - 存取控制信息，如文件存取权限等。  
  - 使用信息，如文件建立时间、修改时间等。  
+ 索引结点  
**在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项读出该文件的物理地址**。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需要调入内存。因此有的系统采用了文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为索引节点的数据结构，简称i结点。在文件目录中的每个目录项仅由文件名和指向该文件所对应的i结点的指针构成。  
存放在磁盘的索引结点称为磁盘索引结点，UNIX中的每个文件都有一个唯一的磁盘索引结点，主要包括以下几个方面：  
  - 文件主标识符，拥有该文件的个人或小组的标识符。  
  - 文件类型，包括普通文件、目录文件和特别文件。  
  - 文件存取权限，各类用户对该文件的存取权限。  
  - 文件物理地址，每个索引结点中含有13个地址项，即iaddr(0)~iaddr(12)，它们以直接或间接方式给出数据文件所在盘块的编号。  
  - 文件长度，以字节为单位。  
  - 文件链接计数，在本文件系统中所有指向该文件的文件名的指针计数。  
  - 文件存取时间，本文件最近被进程存取的时间、最近被修改的时间及索引结点最近被修改的时间。  
  文件被打开时，磁盘索引结点复制到内存的索引结点中，以便于使用。在内存索引结点中又增加了以下内容：  
  - 索引节点编号，用于标志内存索引结点。  
  - 状态，指示i节点是否上锁或被修改。  
  - 访问计数，每当有一进程要访问此i结点时，计数加1，访问结束减1。  
  - 逻辑设备号，文件所属文件系统的逻辑设备号。  
  - 链接指针，设置分别指向空闲链表和散列队列的指针。  
2. 目录结构  
+ 目录这个层次上所需要执行的操作：  
  - 搜索  
  当用户使用一个文件时，需要搜索目录，以找到该文件的对应目录项。  
  - 创建文件  
  当创建一个新文件时，需要在目录中增加一个目录项。  
  - 删除文件  
  当删除一个文件时，需要在目录中删除相应的目录项。  
  - 显示目录  
  用户可以请求显示目录的内容，如显示该用户目录中的所有文件及属性。  
  - 修改目录  
  某些文件属性保存在目录中，因而这些属性的变化需要改变相应的目录项。  
+ 操作时，考虑以下几种目录结构：  
  - 单级目录结构  
  在整个系统中只建立一张目录表，每个文件占一个目录项。当访问一个文件时，先按文件名在该目录中查找到相应的FCB，经合法性检查后执行相应的操作。当建立一个新文件时，必须先检索所有目录项以确保没有“重名” 的情况，然后在目录中增设一项，把FCB的全部信息保存在该项中。当删除一个文件时，先从该目录中找到该文件的目录项，回收该文件所占用的存储空间，然后清除该目录项。  
  单级目录结构实现了“按名存取”，但是存在查找速度缓慢、文件不允许重名的文件、不便于文件共享等缺点，而且对于多用户的操作系统显然是不适用的。  
  - 两级目录结构  
  单级目录很容易造成文件名称混淆的情况，因此可以采用两级方案，将文件目录分为主文件目录(Master File Directory)和用户文件目录(User File Directory)两级。  
  主文件目录项记录用户名及相应用户文件目录所在的存储位置。用户文件目录项记录该用户文件的FCB信息。当某用户欲对其文件进行访问时，只需搜索该用户对应的UFD，这既解决了不同用户文件的重名问题，又一定程度上保证了文件的安全。  
  两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但是两级目录结构缺乏灵活性，不能对文件分类。  
  - 多级目录结构（树形目录结构）  
  将两级目录结构的层次关系加以推广，就形成了多级目录结构，即树形目录结构。  
  用户要访问某个文件时，用文件的路径名标识文件，文件路径名是个字符串，由从根目录出发到所找文件通路上所有目录名与数据文件名用“/”链接而成。从根目录出发的路径称为绝对路径。当层次较多时，每次从根目录查询会浪费时间，于是加入了当前目录，进程对各文件的访问都是相对于当前目录进行的。当用户要访问某个文件时，使用相对路径标识文件，相对路径由从当前目录出发到所找文件通路上所有目录名与数据文件名用文件分隔符“/”链接而成。  
  树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够有效地进行文件的管理和保护。但是，在树形目录中查找一个文件时，需要按照路径名逐级访问中间结点，这就增加了磁盘访问次数，无疑将影响查询速度。  
  - 无环图目录结构  
  树形目录结构能便与实现文件分类，但不便于实现文件共享，为此在树形目录结构的基础上增加了一些指向同一结点的有向边，使整个目录成为一个有向无环图。引入无环图目录结构是为了实现文件共享。  
  当用户要求删除一个共享结点时，若系统只是简单地将它删除，则当另一共享用户需要访问时，会因无法找到这个文件而发生错误。为此，可为每个共享节点设置一个共享计数器，每当图中增加对该结点的共享链时，计数器加1；每当某用户提出删除结点时，计数器减1.每当共享计数器为0时，才真正删除该结点，否则仅删除请求用户的共享链。共享文件，只存在一个真正的文件，任何改变都会被其他用户所看见。  
  无环图目录结构方便地实现了文件的共享，但是的系统的管理变得更加复杂。  

### 文件共享  
文件共享使多个用户（进程）共享同一个文件，系统中只需要保留该文件的一个副本。若系统不能提供共享功能，则每个需要该文件的用户都要有各自的副本，会造成对存储空间的极大浪费。随着计算机技术的发展，文件共享的范围已由单机系统发展到多机系统，进而通过网络扩展到全球。这些文件的分享是通过分布式文件系统、远程文件系统、分布式信息系统实现的。这些系统允许多个客户通过C/S模型共享网络中的服务器文件。  
现代常用的两种文件共享方法如下：  
1. 基于索引结点的共享方式（硬链接）  
在树形结构的目录中，当有两个或多个用户要共享一个子目录或文件时，必须将共享文件或子目录链接到两个或多个用户的目录中，才能方便地找到该文件。  
在这种共享方式中，诸如文件的物理地址及其他的文件属性等信息，不再放在目录项中，而是放在索引节点当中。在文件目录中只设置文件名及指向索引结点的指针。在索引结点中还应有一个链接计数count，用于表示链接到本索引结点（即文件）上的用户目录项的数目。当count=2时，表示有两个用户目录项链接到本文件上，或者说有两个共享此文件。  
用户A创建一个新文件时，它便是该文件的所有者，只是将count置为1.用户B要共享此文件时，在用户B的目录中增加一个目录项，并设置一个指针指向该文件的索引结点。此时，文件主仍然是用户A，count=2。用户A不再需要此文件，不能将文件直接删除。因为所删除了文件，则必然也删除了该文件的索引结点，这样便会使用户B的指针悬空，而用户B可能正在此文件上执行写操作，此时用户B会无法访问到文件。因此用户A不能删除文件，只是将该文件的count减1，然后删除自己目录中相应的目录项。用户B仍然可以使用该文件。当count=0时，表示没有用户使用该文件，系统将负责删除该文件。  
2. 利用符号链实现文件共享（软链接）  
为使用户B能够共享用户A的一个文件F，可以由系统创建一个LINK类型的新文件，也取名为F，并将文件F写入用户B的目录中，以实现用户B的目录与文件F的链接。在新文件中包含被链接文件F的路径名，这样的链接方法被称为符号链接。  
新文件中的路径名只被视为符号链，当用户B要访问链接的文件F且正要读LINK类新文件时，操作系统根据新文件中的路径名去读该文件，从而实现用户B对文件F的共享。  
在利用符号链实现文件共享时，只有文件的拥有者才能拥有指向其索引结点的指针。而共享该文件的其他用户只有该文件的路径名，并不拥有指向其索引结点的指针。测氧，也就不会发生在文件主删除一个共享文件后留下一个悬空指针的情况。当文件的拥有者把一个共享文件删除后，其他用户通过符号链去访问它时，会出现访问失败，于是将符号链删除，此时不会产生任何影响。  
当然，利用符号链实现文件共享时仍然存在问题。当用户删除文件后再新建同名的文件，仍然可以被访问到，但访问的文件已经改变，从而导致错误。  
在符号链的共享方式中，当其他用户读共享文件时，需要根据文件路径名逐个地查找目录，直至找到该文件的索引结点。因此，每次访问时，都可能要多次的读盘，使得访问文件的开销变大并增加了启动磁盘的频率。此外，符号链的索引结点也要耗费一定的存储空间。  
**符号链接有一个很大的优点，即网络共享只需要提供该文件所在机器的网络地址及该机器中的文件路径。**  
上述两种链接方式都存在一个共同的问题，即每个共享文件都有几个文件名。换言之，每增加一条链接，就增加一个文件名。这实质上是每个用户都使用自己的路径名去访问共享文件。当我们试图去遍历整个文件系统时，将会多次遍历到该共享文件。  
硬链接和软链接都是文件系统中的静态共享方法，在文件系统中还存在着另外的共享需求，即两个进程同时对同一个文件进行操作，这样的共享称为动态共享。  
文件共享，“软”“硬”兼施。硬链接就是多个指针指向同一个索引结点，保证只要还有一个指针指向索引结点，索引结点就不能被删除；软链接就是把到达共享文件的路径记录下来，当要访问文件时，根据路径寻找文件。硬链接的速度比软链接的查找速度要快。**软链接的路径一般是以软链接所在目录，相对路径访问共享文件的路径。**  

### 文件保护  
为了防止文件共享可能导致文件被破坏或未经核准的用户修改文件，文件系统必须控制用户对文件的存取，即解决对文件读、写、执行的许可问题。为此，必须在文件系统中建立相应的文件保护机制。  
文件保护通过口令保护、加密保护和访问控制等方式实现。其中，口令保护和加密保护是为了防止用户文件被他人存取或窃取，而访问控制则用于控制用户对文件的访问方式。  
1. 访问类型  
对文件的保护可从限制对文件的访问类型中出发。可加以控制的访问类型主要有以下几种。  
+ 读。从文件中读。  
+ 写。向文件内写。  
+ 执行。将文件装入内存并执行。  
+ 添加。将新信息添加到文件结尾部分。  
+ 删除。删除文件、释放空间。  
+ 列表清单。列出文件名和文件属性。  
此外还可以对文件的重命名、复制、编辑等加以控制。这些高层的功能可以通过吃系统程序调用低层系统调用来实现。保护可以只在低层提供。  
2. 访问控制  
解决访问控制最常用的方法是根据用户身份进行控制。而实现基于身份访问的最为普通的方法是，为每个文件和目录增加一个访问控制列表（Access-Control List, ACL），以规定每个用户名及其所允许的访问类型。  
这种方法的优点是可以使用复杂的访问方法，缺点是长度无法预计并且可能导致复杂的空间管理，使用精简的访问列表可以解决这个问题。  
精简的用户访问列表采用拥有者、组和其他三种用户类型(user-group-others)。  
+ 拥有者。创建文件的用户。  
+ 组。一组需要共享文件且具有类似访问的用户。  
+ 其他。系统内的所有其他用户。  
这样，只需要三个域即可列出访问表中这三类用户的访问权限。文件拥有者在创建文件时，说明创建者用户名及所在的组名，系统在创建文件时也将文件主的名字。所属组名列在该文件的FCB中。用户访问该文件时，按照拥有者所拥有的权限访问文件，若用户和拥有者在同一个组，则按照同组权限访问，否则只能按照其他用户权限访问。UNIX操作系统采用的就是这种方法。  
口令和密码是另外两种访问控制的方法：  
口令指用户在建立一个文件时提供一个口令，系统为其建立FCB时附上相应口令，同时告诉允许共享该文件的其他用户。用户请求访问时必须提供相应的口令。这种方法时间和空间的开销不多，缺点是口令直接存在系统内部，不够安全。  
密码指用户对文件进行加密，文件被访问时需要使用秘钥。这种方法保密性强，节省了存储空间，不过编码和译码要花费一定的时间。  
口令和密码都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型。  
注意两个问题：  
+ 现代操作系统常用的文件保护方法是，将访问控制列表与用户、组和其他成员访问控制方案一起组合使用。  
+ 对于多级目录结构而言，不仅需要保护单个文件，而且需要保护子目录内的文件，即需要提供目录保护机制。目录操作与文件操作并不相同，因此需要不同的保护机制。  

---
## 文件系统实现  
### 文件系统层次结构  
现代操作系统有多种文件系统类型（如FAT32、NTFS、ext2、ext3、ext4等），因此文件系统的层次结构也不尽相同。  
1. 文件调用接口  
文件系统为用户提供与文件及目录有关的调用，如新建、打开、读写、关闭、删除文件，建立、删除目录等。此层由若干程序模块组成，每个模块对应一条系统调用，用户发出系统调用时，控制即转入相应的模块。  
2. 文件目录系统  
文件目录系统的主要功能是管理文件目录，其任务有管理活跃文件目录表、管理读写状态信息表、管理用户进程的打开文件表、管理与组织存储设备上的文件目录结构、调用下一级存取控制模块。  
3. 存取控制验证  
实现文件保护主要由该级软件完成，他把用户的访问要求与FCB中指示的访问控制权限进行比较，以确认访问的合法性。  
4. 逻辑文件系统与文件信息缓冲区  
逻辑文件系统与文件信息缓冲区的主要功能是，根据文件的逻辑结构将用户要读写的逻辑记录转换成文件逻辑结构内的相应块号。  
5. 物理文件系统  
物理文件系统的主要功能是把逻辑记录所在的相对块号转换成实际的物理地址。  
6. 辅助分配模块  
分配模块的主要功能是管理辅存空间，即负责分配辅存空闲空间和回收辅存空间。  
7. 设备管理程序模块  
设备管理程序模块的主要功能是分配设备、分配设备读写缓冲区、磁盘调度、启动设备、设备处理中断、释放设备读写缓冲区、释放设备等。  

### 目录实现  
在读文件前，必须先打开文件。打开文件时，操作系统利用路径名找到相应目录项，目录项中提供了查找文件磁盘块所需要的信息。目录实现的基本方法有线性列表和哈希表两种，要注意目录的实现就是为了查找，因此线性列表实现对应线性查找，哈希表的实现对应散列表。  
1. 线性列表  
最简单的目录实现方法是使用存储文件名和数据块指针的线性表。创建新文件时，必须首先搜索目录表以确定有没有同名的文件存在，然后在目录表后增加一个目录项。删除文件则根据给定的文件名搜索目录表，接着释放分配给它的空间。重用目录项有许多方法：可以将目录项标记为不再使用，或给它加到空闲目录项表上，还可以将目录表中的最后一个目录项复制到空闲位置，并降低目录表长度。采用链表结构可以减少删除文件的时间，其优点在于实现简单，不过由于线性表的特殊性，比较费时。  
2. 哈希表  
哈希表根据文件名得到一个值，并返回一个指向线性列表中元素的指针。这种方法的优点是查找非常迅速，插入和删除也较简单，不过需要一些预备措施来避免冲突。最大的困难是哈希表长度固定以及哈希函数对表长的依赖性。  
目录查询是通过在磁盘上反复搜索完成的，需要不断地进行I/O操作，开销较大。所以如前所述，为了减少I/O操作，把当前使用的文件目录复制到内存，以后要使用该文件时只需要在内存中操作，因此降低了磁盘操作次数，提高了系统速度。  
### 文件实现  
文件的实现就是研究文件的物理结构，即文件数据在物理存储设备上是如何分配和组织的。同一个问题有两个方面的回答：一是文件的分配方式，讲的是对磁盘非空闲块的管理；二是文件存储空间管理，讲的是磁盘空闲块的管理。  
1. 文件分配方式  
文件分配对应于文件的物理结构，是指如何为文件分配磁盘块。常用的磁盘空间分配方法有三种：连续分配、链接分配和索引分配。  
+ 连续分配  
连续分配方法要求每个文件在磁盘上占有一组连续的块。磁盘地址定义了磁盘上的一个线性序列。这种排序使得作业访问磁盘所需要的寻道数和寻道时间最小。  
文件的连续分配方式可以用第一块的磁盘地址和连续块的数量来定义。一个文件的目录条目包括开始块的位置和该文件所分配区域的长度。  
连续分配支持顺序访问和直接访问。其优点是实现简单。存储速度快。缺点是侵犯米黄石不宜动态增加，因为一个文件末尾后的盘块可能已分配给其他文件，一旦需要增加，就需要大量移动盘块。此外，反复增删文件后会产生外部碎片，且很难确定一个文件需要的空间大小，因而只适用于长度固定的文件。  
+ 链接分配  
链接分配采用离散分配的方式，消除了外部碎片，因而显著提高了磁盘空间的利用率；又因为根据文件的当前需求为其分配必需的盘块，当文件动态增长时，可以动态地再为它分配盘块，因此无须事先知道文件的大小。此外，对文件的增、删、改也非常方便。链接分配方式又分为隐式链接和显式链接两种形式。  




