# 网络层  
---  
### 网络层的功能  
### 异构网络互联  
要在全球范围内把数以百万计的网络互联起来，并且能够互相通信，是一项非常复杂的任务，此时需要解决许多问题，比如不同的寻址方案、不同的网络接入机制、不同的差错处理方法、不同的路由选择机制等。用户的需求是多样的，没有一种单一的网络能适应所有用户的需求。网络层所要完成的任务之一就是使这些异构的网络实现互联。  
所谓网络互联，是指将两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备（即中间设备）相互连接起来，以构成更大的网络系统。中间设备又称中间系统或中继系统。  
根据所在的层次，中继系统分为以下4种：  
+ 物理层中继系统：中继器，集线器Hub  
+ 数据链路层中继系统：网桥或交换机  
+ 网络层中继系统：路由器  
+ 网络层以上的中继系统：网关  

使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称之为网络互联。因此网络互联通常是指用路由去进行网络互联和路由选择。路由器是一台专用计算机，用于在互联网中进行路由选择。  
TCP/IP体系在网络互联上采用的做法是在网络层(IP层)采用标准化协议，但相互连接的网络可以是异构的。  
虚拟互联网络也就是逻辑互联网络，即互联起来的各种物理网络的异构性本来是客观存在的，但是通过使用IP就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络。这种使用IP的虚拟互联网络可简称为IP网络。  
使用虚拟互联网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互联的具体的网络异构细节（如具体的编址方案、路由选择协议）。  

### 路由与转发  
路由器主要完成两个功能：一是路由选择（确定哪一条路径），二是分组转发（当一个分组到达时所采取的动作）。前者是根据特定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换里有信息而不断地更新和维护路由表。后者处理通过路由器的数据流，关键操作是转发表查询、转发及相关的队列管理和任务调度等。  
+ 路由选择。指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。  
+ 分组转发。指路由器根据转发表将用户的IP数据报从合适的端口发送出去。  

路由表是根据路由选择算法得出的，而转发表是从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要对网络拓扑变化的计算最优化。  

### 拥塞控制  
在通信子网中，因出现过量的分组而引起网络性能下降的现象称为拥塞。例如，某个路由器所在的链路的带宽为R B/s，如果IP分组只从它的某个端口进入，那么其速率为r<sub>in</sub> B/s。当r<sub>in</sub> = R时，可能看起来是件“好事”，因为链路带宽被充分利用。但是，当分组到达路由器的速率接近R时，平均时延急剧增加，并且会有大量的分组被丢弃（路由器端口的缓冲区是有限的），整个网络的吞吐量会骤降，源与目的地之间的平均时延也会变得近乎无穷大。  
判断网络是否进入拥塞状态的方法是，观察网络的吞吐量与网络负载的关系：如果随着网络负载的增加，网络的吞吐量明显小于正常的吞吐量，那么网络就可能已进入“轻度拥塞”状态；如果网络的吞吐量随着网络负载的增大而下降，那么网络就可能已进入拥塞状态；如果网络的负载继续增大，而网络的吞吐量下降到零，那么网络就可能已进入死锁状态。  
为避免拥塞现象的出现，要采用能防止拥塞的一系列方法对子网进行拥塞控制。拥塞控制主要解决的问题是如何获取网络中发生拥塞的信息，从而利用这些信息进行控制，以避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络死锁的现象。  
拥塞控制的作用是确保子网能够承载所达到的流量，这是一个全局性的过程，设计各方面的行为：主机、路由器及路由器内部的转发处理过程等。单一地增加资源并不能解决拥塞。  
流量控制和拥塞控制的区别：流量控制往往是指在发送端和接收端之间的点对点通信量的控制。流量控制所要做的是抑制发送端发送数据的速率，以便接收端来得及接收。而拥塞控制必须保证通信子网能够传送待传送的数据，是一个全局性的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素。  
拥塞控制的方法有两种： 
+ 开环控制。在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。这是一种静态的预防方法。一旦整个系统启动并运行，中途就不再需要修改。开环控制手段包括确定何时可接收新流量、何时可丢弃分组即丢弃哪些分组，确定何种调度决策等。所有这些手段的共性是，在决定时不考虑当前网络的状态。  
+ 闭环控制。事先不考虑有关发生拥塞的各种因素，采用监测网络系统去监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。闭环控制是基于反馈环路的概念，是一种动态的方法。  

---  
## 路由算法  
### 静态路由与动态路由  
路由器转发分组是通过路由表转发的，而路由表是通过各种算法得到的。从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可分为如下两大类。  
静态路由算法（又称非自适应路由算法）。指由网络管理员手工配置的路由信息。当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手动去修改路由表中相关的静态路由信息。大型和复杂的网络环境通常不宜采用静态路由。一方面，网络管理员难以全面了解整个网络的拓扑结构；另一方面，当网络的拓扑结构和链路状态发生变化时，路由表中的静态路由信息需要大范围地调整，这一工作的难度和复杂度非常高。  
动态路由算法（又称自适应路由算法）。指路由器上的路由表项是通过互相连接的路由器之间彼此交换信息，然后根据一定的算法优化出来的，而这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，随时获得最优的寻路效果。  
静态路由算法的优点是简便、可靠，在负荷稳定、拓扑变化不大的网络中运行效果很好，因此仍广泛用于高度安全的军事系统和较小的商业网络。动态路由算法能改善网络的性能并有助于流量管理；但算法复杂，会增加网络的负担，有时因动态变化的反应太快而引起振荡，或反应太慢而影响网络路由的一致性，因此要仔细设计动态路由算法，以发挥其优势。常用的动态路由算法可分为两类：距离-向量路由算法和链路状态路由算法。  

### 距离-向量路由算法  
在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点。这种路由选择表包含：  
+ 每条路径的目的地  
+ 路径的代价  

在这种算法中，所有结点都必须参与距离向量交换，有保证路由的有效性和一致性，也就是说，所有的结点都监听来自其他结点传来的路由选择更新信息，并在下列情况下更新它们的路由选择表：  
+ 被通告一条新的路由，该路由在本结点的路由表中不存在，此时本地系统加入这条新的路由。  
+ 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，有较短的距离。此种情况下，就用经过发送路由信息的结点的新路由替换路由表中到达那个目的地的现有路由。  

距离-向量路由算法的实质是，迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短通路。它要求每个结点在每次更新时都将它的全部路由表发送给所有相邻的结点。显然，更新报文的大小与通信子网的结点个数成正比，大的通信子网将导致很大的更新报文。由于更新报文发给直接相邻的结点，所以所有结点都将参加路由选择信息交换。基于这些原因，在通信子网上传送的路由选择信息的数量很容易变得非常大。  
最常见的距离-向量路由算法是RIP算法，它采用“跳数”作为距离的度量。  

### 链路状态路由算法  
链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑信息，它们执行下述两项任务。第一，主动测试所有邻接结点的状态。两个共享一条链路的结点是相邻结点，它们连接到同一条链路，或者连接到同一广播型物理网络。第二，定期地将链路状态传播给所有其他结点（或称路由结点）。典型的链路状态算法是OSPF算法。  
在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的所有其他结点，而不是仅送给那些直接相连的结点。每个结点都用这种方式从网上所有其他的结点接收包含直接链路状态的路由选择信息。  
每当链路状态报文到达时，路由结点便使用这些状态信息去更新自己的网络拓扑和状态“视野图”，一旦链路状态发生变化，结点就对更新的网络图利用Dijkstra最短路径算法重新计算路由，从单一的源出发计算到达所有目的结点的最短路径。  
链路状态路由算法主要有三个特征：  
+ 向本自治系统中所有路由器发送信息，这里使用的方法是泛洪法，即路由器通过所有端口向所有相邻的路由器发送信息。而每个相邻路由器又将此信息发往其所有相邻路由器（但不再发送给刚刚发来信息的那个路由器）。  
+ 发送的信息是与路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓“链路状态”，是指说明本路由器与哪些路由器相邻及该链路的“度量”。对于OSPF算法，链路状态的“度量”主要用来表示费用、距离、时延带宽等。  
+ 只有当链路状态发生变化时，路由器才向所有路由器发送此消息。 

由于一个路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接关系，因此链路状态路由算法可以用于大型的或路由变化聚敛的互联网环境。  
链路状态路由算法的主要优点是，每个路由结点都使用同样的原始状态数据独立地计算路径，而不依赖中间结点的计算；链路状态报文不加改变地传播，因此采用该算法易于查找故障。当一个结点从所有其他结点接收到报文时，它可以在本地立即计算正确的通路，保证一步汇聚。最后，由于链路状态报文仅运载来自单个结点关于直接链路的消息，其大小与网络中的路由结点数目无关，因此链路状态算法比距离-向量算法有更好的规模可伸展性。  
距离-向量路由算法与链路状态路由算法的比较：在距离-向量算法中，每个结点仅与它的直接邻居交谈，它为它的邻居提供从自己到网络中其他所有结点的最低费用估计。在链路状态路由算法中，每个结点通过广播的方式与其他所有结点交谈，但它仅告诉它们与它直接相连的链路的费用。相较之下，距离-向量路由算法有可能遇到路由环路等问题。  

### 层次路由  
当网络规模扩大时，路由器的路由表成比例地增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要用更多CPU时间来扫描路由表，用过多的带宽来交换路由状态信息。因此路由选择必须按照层次的方式进行。  
因特网将整个互联网划分为许多较小的自治系统，每个自治系统有权自主地决定本系统内应采用何种路由选择协议。如果两个自治系统需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异。据此，因特网把路由选择协议划分为两大类：  
+ 一个自治系统内部所使用的路由选择协议称为内部网关协议IGP，也称域内路由选择，具体的协议有RIP和OSPF等。  
+ 自治系统之间所使用的路由选择协议称为外部网关协议EGP，也称域间路由选择，用在不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径。具体的协议有BGP。  

使用层次路由时，OSPF将一个自治系统再划分为若干区域，每个路由器都知道在本区域内如何把分组路由到目的地的细节，但不用知道其他区域的内部结构。  
采用分层次划分区域的方法虽然会使得交换信息的种类增多，但也会使OSPF协议更加复杂。但这样做却能使每个区域内部交换路由信息的通信量大大减小，因而使OSPF协议能够用于规模很大的自治系统中。  

---  
## IPv4  
### IPv4分组  
IPv4即现在普遍使用的IP（版本4）。IP定义数据传送的基本单元——IP分组及其确切的数据格式。IP也包括一套规则，指明分组如何处理、错误怎样控制。特别是IP还包含非可靠投递的思想，以及与此关联的分组路由选择的思想。  

#### IPv4分组的格式  
![IP数据报的格式](IPv4分组格式.png)  

一个IP分组由首部和数据两部分组成。首部前一部分的长度是固定的，共20B，是所有IP分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提示错误检测及安全等机制。  
IP首部的部分重要字段含义如下：  
+ 版本。指IP的版本，目前广泛使用的版本号为4。  
+ 首部长度。占4位。**以32位为单位**，最大值为60B(15×4B)。最常用的首部长度是20B，此时不使用任何选项（即可选字段）。  
+ 总长度。占16位。指首部和数据之和的长度，**单位为字节**，因此数据报的最大长度为2<sup>16</sup>-1B = 65535B。以太网帧的最大传送单元MTU为1500B，因此当一个IP数据报封装成帧时，数据报的总长度（首部加数据）一定不能超过下面数据链路层的MTU值。  
+ 标识。占16位。它是一个计数器，每产生一个数据报就加1，并赋值给标识字段。但它不是“序号”（**IP是无连接服务**）。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重装成原来的数据报。  
+ 标志。占3位。标志字段的最低位为MF，`MF = 1`表示后面还有分片，`MF = 0`表示最后一个分片。标志字段中间的一位是DF，只有`DF = 0`时才允许分片。  
+ 片偏移。占13位。它指出较长的分组在分片后，某片在原分组中的相对位置。片偏移**以8个字节为偏移单位**，即每一个分片的长度一定是8B的整数倍。  
+ 首部校验和。占16位。IP数据报的首部校验和**只校验分组的首部**，而不校验数据部分。  
+ 生存时间TTL。占8位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。路由器在转发分组前，先把TTL减1。若TTL被减为0，则该分组必须丢弃。  
+ 协议。占8位。指出分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输层协议，如TCP、UDP等。其中值为6表示TCP，值为17表示UDP。  
+ 源地址字段。占4B，标识发送方的IP地址。  
+ 目的地址字段。占4B，标识接收方的IP地址。  

#### IP数据报分片  
一个链路层数据报能承载的最大数据量称为最大传送单元MTU。因为IP数据报被封装在链路层数据报中，因此链路层的MTU严格地限制着IP数据报的长度，而且在IP数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU。例如，以太网的MTU为1500B，而许多局域网的MTU不超过576B。当数据报的总长度大于链路MTU时，就需要将IP数据报中数据分装在两个或多个较小的IP数据报中，这些较小的数据报称为片。  
片在目的地的网络层被重新组装。目的主机使用IP首部中的标识、标志和片偏移来完成对片的重组。创建一个IP数据报时，源主机为该数据报加上一个标识号。当一个路由器需要将一个数据包分片时，形成的每个数据报（即片）都具有原始数据报的标识号。当目的主机收到来自同一发送主机的一批数据报时，它可以通过检查数据报的标识号来确定哪些数据报属于同一个原始数据报的片。IP首部中的标志位有3比特，但只有后2比特有意义，分别是MF(More Fragment)和DF(Don't Fragment)。只有当DF = 0时，该数据报才可以被分片。MF则用来告知目的主机该IP数据报是否为原始数据报的最后一个片。当MF = 1时，表示相应的原始数据报还有后续的片；当MF = 0时，表示该数据报是相应原始数据报的最后一个片。目的主机在对片进行重组时，使用片偏移字段来确定片应放在原始IP数据报的哪个位置。  
IP分片涉及一定的计算。计算时需要注意的是片偏移的单位是8B。  

#### 网络层转发分组的流程  
网络层路由器执行的分组转发算法如下：  
+ 从数据报的首部提取目的地址的IP地址D，得出目的网络地址N。  
+ 若网络N与此路由器直接相连，则把数据报直接交付给目的主机D，这称为路由器的直接交付；否则是间接交付，执行下一步骤。  
+ 若路由表中有目的地址为D的特定主机路由（对特定的目的地址指明一个特定的路由，通常是为了控制或测试网络，或处于安全考虑才采用的），则把数据报传送给路由表中所指明的下一跳路由器；否则执行下一步。 
+ 若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行下一步。  
+ 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行下一步。  
+ 报告转发分组出错。  

**得到下一跳路由器的IP地址后并不是直接把该地址填入待发送的数据报，而是将该IP地址转换成MAC地址（通过ARP），将其放到MAC帧首部中，然后根据这个MAC地址找到下一跳路由器。在不同网络中传送时，MAC帧的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址。**  

### IPv4地址和NAT  
#### IPv4地址  
连接到因特网上的每台主机（或路由器）都分配一个32比特的全球唯一标识符，即IP地址。**传统的IP地址是分类的地址**，分为A、B、C、D、E五类。  
无论哪类IP地址，都由网络号和主机号两部分组成。即IP地址::={<网络号>，<主机号>}。其中网络号标识主机（或路由器）所连接到的网络。一个网络号在整个因特网范围内必须是唯一的。主机号标识该主机（或路由器）。一个主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个IP地址在整个因特网范围内是唯一的。  

![IP分类](IPv4分类.png)  

在各类IP地址中，有些IP地址具有特殊用途，不得做主机的IP地址：  
+ 主机号全为0表示网络本身。  
+ 主机号全为1表示本网络的广播地址，又称直接广播地址。  
+ 127.0.0.1保留为环路自检(Loopback Test)地址，此地址表示任意主机本身，目的地址为环回地址IP数据报永远不会出现在任何网络上。  
+ 32位全为0，即0.0.0.0表示本网络上的本主机。  
+ 32位全为1，即255.255.255.255表示整个TCP/IP网络的广播地址，又称受限广播地址。实际使用时，由于路由器对广播域的隔离，255.255.255.255等效为本网络的广播地址。  

常见的三类IP地址的使用范围如下：  
|网络类别|最大可用网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中的最大主机数|  
|:---:|:---:|:---:|:---:|:---:|  
|A|2<sup>7</sup>-2|1|126|2<sup>24</sup>-2|  
|B|2<sup>14</sup>-1|128.1|191.255|2<sup>16</sup>-2|  
|C|2<sup>21</sup>-1|192.0.1|223.255.255|2<sup>8</sup>-2|  

表中，A类地址的网络书减2的原因是：第一，网络号字段全为0的IP地址是保留地址，意思是“本网络”；第二，网络号为127的IP地址是环回测试地址。B类地址的可用网络数减1的原因是128.0这个网络号是不可指派的。C类地址的可用网络数减一的原因是网络号为192.0.0的网络是不可指派的。  
IP地址有以下重要特点：  
+ 每个IP地址都由网络号和主机号两部分组成，因此IP地址是一种分等级的地址结构。分等级的好处是：  
  - IP地址管理机构在分配IP地址时只分配网络号（第一级），而主机号（第二级）则由得到该网络的单位自行分配，方便了IP地址的管理。  
  - 路由器仅根据目的主机所连接的网络号来转发分组，从而减小了路由表所占的存储空间。  

+ IP地址是标志一台主机（或路由器）和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的IP地址，每个IP地址的网络号必须与所在网络的网络号相同，且这两个IP地址的网络号是不同的。因此IP网络上的一个路由器必然至少具有两个IP地址（路由器每个端口至少分配一个IP地址）。  
+ 用转发器或桥接器（网桥等）连接的若干LAN仍然是同一个网络（同一个广播域），因此该LAN中所有主机的IP地址的网络号必须相同，但主机号必须不同。  
+ 在IP地址中，所有分配到网络号的网络（无论是LAN还是WAN）都是平等的。  
+ 在同一个局域网上的主机或路由器的IP地址的网络号必须是一样的。路由器总是具有两个或两个以上的IP地址，路由器的每个端口都有一个不同网络号的IP地址。  

#### 网络地址转换  
网络地址转换NAT是指通过将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。它使得整个专用网只需要一个全球IP地址就可以与因特网连通，由于专用网本地IP地址是可重用的，所以NAT大大节省了IP地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络收到攻击的风险。  
此外，为了网络安全，划出了部分IP地址为私有IP地址。私有IP地址只用于LAN，不用于WAN连接，并且允许私有IP地址被LAN重复使用。这有效解决了IP地址不足的问题。私有IP地址网段如下：  
+ A类。1个A类网段，即**10**.0.0.0-**10**.255.255.255  
+ B类。16个B类网段，即**172.1**.0.0-**172.31**.255.255  
+ C类。256个C类网段，即**192.168.0**.0-**192.168.255**.255  

在因特网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发。这种采用私有地址的互联网称为专用互联网或本地互联网。私有IP地址也称可重用地址。  
使用NAT时需要在专用网连接到因特网的路由器上安装NAT软件，NAT路由器至少有一个有效的外部全球地址。使用本地地址的主机和外界通信时，NAT路由器使用NAT转发表将本地地址转换为全球地址，或将全球地址转换成本地地址。NAT转换表中存放着{本地IP地址：端口}到{全球IP地址：端口}的映射。通过{IP地址：端口}这样的映射方式，可让多个私有地址映射到同一个全球IP地址。  
普通路由器在转发IP数据报时，不改变其源IP地址和目的IP地址。而NAT路由器在转发IP数据报时，一定要更换其IP地址（转换源IP地址或目的IP地址）。普通路由器仅工作在网络层，而NAT路由器转发数据报时需要查看和转换传输层的端口号。  
