# 文件管理  
## 文件系统基础  
### 文件的概念  
1. 文件的定义  
文件是操作系统中的一个重要概念。文件是以计算机硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、程序等。在系统运行时，计算机以进程为基本单位进行资源的调度和分配；而在用户进行的输入、输出中，则以文件为基本单位。大多数应用程序的输入都是通过文件来实现的，其输出也都保存在文件中，以便信息的长期存储及将来的访问。当用户将文件用于应用程序的输入、输出时，还希望可以访问文件、修改文件和保存文件等，实现对文件的维护管理，这就需要系统提供一个文件管理系统，操作系统中文件系统就是用于实现用户的这些管理要求的。  
文件的组成：  
首先，文件中肯定包括一块存储空间，更准确的说，是存储空间中的数据；其次，由于操作系统要管理成千上万的数据，因此必定需要对这些数据进行划分，然后贴上“标签”，以便于分类和索引，所以文件必定包含分类和索引的信息；最后，不同的用户拥有对数据的不同访问权限，因此文件中一定含有一些关于访问权限的信息。  
从用户的角度看，文件系统是操作系统的重要部分之一。用户关心的是如何命名、分类和查找文件，如何保证文件数据的安全性及对文件可以进行哪些操作等，而对其中的细节，如文件如何存储在辅存上、如何管理文件辅存区域等关心甚少。  
文件系统提供了与二级存储相关的资源的抽象，让用户能在不了解文件的各种属性、文件存储介质的特征及文件在存储介质上的具体位置等情况下，方便快捷地使用文件。  
用于通过文件系统建立文件，提供应用程序的输入、输出，对资源进行管理。首先了解文件的结构，文件自底向上的定义如下：  
+ 数据项。数据项是文件系统中最低级的数据组织形式，可分以下两种类型。  
  - 基本数据项。用于描述一个对象的某种属性的一个值，如姓名、日期或证件号等，是数据中可命名的最小逻辑数据单位，即原子数据。  
  - 组合数据项。由多个基本数据项组成。  
+ 记录。记录是一组相关的数据项的集合，用于描述一个对象在某方面的属性。  
+ 文件。文件是指由创建者所定义的一组相关信息的集合，逻辑上可分为有结构文件和无结构文件两种。  
  - 有结构文件。文件由一组相似的记录组成，又称记录式文件。  
  - 无结构文件。无结构文件被视为一个字符流，又称流式文件。  
2. 文件的属性  
文件具有一定的属性，系统不同，属性也会有所不同，但通常都包括如下属性：  
+ 名称。文件名称唯一，以容易读取的形式保存。  
+ 标识符。标识文件系统内文件的唯一标签，通常为数字，是对人不可读的一个内部名称。  
+ 类型。被支持不同类型的文件系统所使用。  
+ 位置。指向设备和设备上文件的指针。  
+ 大小。文件当前大小（用字节、字或块表示），也可包含文件允许的最大值。  
+ 保护。对文件进行保护的访问控制信息。  
+ 时间、日期和用户标识。文件创建、上次修改和上次访问的相关信息，用于保护和跟踪文件的使用。  
**所有文件的信息都被保存在目录结构中，而目录结构保存在外存上。文件信息在需要时才调入内存。通常，目录条目包括文件名称及其唯一的标识符，而标识符定位其他属性的信息。**  
3. 文件的基本操作  
文件属于抽象数据类型。为了恰当地定义文件，需要考虑有关文件的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、删除和截断等操作。  
+ 创建文件。  
创建文件有两个必要步骤:  
  - 在文件系统中为文件找到空间  
  - 在目录中为新文件创建条目，该条目记录文件名称、在文件系统的位置及其他可能的信息。  
+ 写文件  
为了写文件，执行一个系统调用，指明文件名称和要写入文件的内容。对应给定文件名称，系统搜索目录以查找文件位置。系统必须为该文件维护一个写位置的指针。每当发生写操作时，便更新写指针。  
+ 读文件  
为了读文件，执行一个系统调用，指明文件名称和要读入文件块的内存位置。同时，需要搜索目录以找到相关的目录项，系统维护一个读位置的指针。每当发生读操作时，更新读指针。一个进程通常只对一个文件读或写，因此当前操作系统位置可作为每个进程当前文件位置的指针。由于读和写操作都使用了同一指针，因此节省了空间，也降低了系统复杂度。  
+ 文件重定位（文件寻址）  
按某条件搜索目录项，将当前文件位置设为给定值，并且不会读、写文件。  
+ 删除文件  
先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件所占用的存储空间。  
+ 截断文件  
允许文件所有属性不变，并删除文件内容，即将其长度设为0并释放其空间。  
这6个基本操作可以组合起来执行其他文件操作。  
4. 文件的打开与关闭  
因为许多文件操作都涉及为给定文件搜索相关目录条目，因此许多系统要求在首次使用文件时，使用系统调用open指明文件的属性（包括该文件在外存上的物理位置）从外存复制到内存打开文件表的一个表目中，并将该表目的编号（也称索引）返回给用户。操作系统维护一个包含所有打开文件信息的表（打开文件表，open-file table）。当用户需要一个文件操作时，可以通过该表的一个索引指定文件，因此忽略了搜索环节。当文件不再使用时，进程可以关闭它，操作系统从打开文件表中删除这一条目。  
大部分操作系统要求在文件使用之前就被显式地打开。操作open会根据文件名搜索目录，并将目录条目复制到打开文件表。若调用open的请求（创建、只读、读写、添加等）得到允许，则进程就可打开文件，而open通常返回一个指向打开文件表中的一个条目的指针。通过该指针进行所有I/O操作，以简化步骤并节省资源。  
**在open调用完成后，操作系统对该文件的任何操作都不再需要文件名，而只需要通过open调用返回的指针。**  
整个系统表包含进程相关信息，如文件在磁盘的位置、访问日期和大小。一个进程打开一个文件，系统打开文件表就会为打开的文件增加相应的条目。当另一个进程执行open时，只不过是在其进程打开表中增加一个条目，并指向整个系统表的相应条目。通常，系统打开文件表的每个文件时，还用一个文件打开计数器（open count），以记录多少进程打开了该文件。每个关闭操作close使count递减，当打开计数器为0时，表示该文件不再被使用，系统将回收分配给该文件的内存空间等资源。若文件被修改过，则将文件写回外存，并将系统打开文件表中的相应条目删除，最后释放文件的文件控制块FCB。  
每个打开文件都有如下关联信息：  
+ 文件指针  
系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。  
+ 系统打开计数  
文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间会不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。计数器跟踪打开和关闭的数量，计数为0时，系统关闭文件，删除该条目。  
+ 文件磁盘位置  
绝大多数文件操作都要求系统修改文件数据。该信息保存在内存中，以免每个操作都从磁盘中取出。  
+ 访问权限  
每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）。该信息保存在进程的打开文件表中，以便操作系统能够运行或拒绝之后的I/O请求。  

### 文件的逻辑结构  
文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构（又称文件的存储结构）是从实现观点出发看到的文件在外存上的存储组织形式。文件的逻辑结构与存储介质特性无关，但文件的物理结构与存储介质的特性有很大关系。文件的逻辑结构实际上是指在文件的内部，数据逻辑上是如何组织起来的。  
按逻辑结构，文件可划分为无结构文件和有结构文件两种。  
1. 无结构文件（流式文件）  
无结构文件是最简单的文件组织形式。无结构文件将数据按顺序组织成记录并几类、保存，它是有序相关信息项的集合，以字节为单位。由于无结构文件没有结构，而面对记录的访问只能通过穷举搜索的办法，故这种文件形式对大多数应用不适用。但字符流的无结构文件管理简单，用户可以方便对其进行操作。所以，那些对于基本信息单位操作不多的文件较适于采用字符流的无结构方式，如原程序文件、目标代码文件等。  
2. 有结构文件（记录式文件）  
有结构文件按记录的组织形式可以分为如下几种：  
+ 顺序文件  
文件中的记录一个接一个地顺序排列，记录通常是定长的，可以顺序存储或以链表形式存储，在访问时需要顺序搜索文件。顺序文件有以下两种结构：第一种是串结构，记录之间的顺序与关键字无关。通常的办法是由时间决定，即按存入时间的先后排列，最先存入的记录为第一条记录，其次存入的为第二条记录，以此类推。第二种是顺序结构，指文件中所有记录按关键字顺序排列。  
在对记录进行批量操作，即每次要读或写一大批记录时，顺序文件的效率是所有逻辑文件中最高的；此外，也只能顺序文件才能存储在磁带上，并能有效地工作，但顺序文件对查找、修改、增加和删除单条记录的操作比较困难。  
+ 索引文件  
对于定长记录文件，要查找第i条记录，可直接通过计算得出第i条记录相对于第一条记录的地址`Ai = i × L`，然而，对于可变长记录的文件，要查找第i条记录，必须顺序地查找前i-1条记录，从而获得相应记录的长度，进而算出第i条记录的首址。  
变长记录文件只能顺序查找，系统开销较大。为此，可以建立一张索引表以加快检索速度，**索引表本身是定长记录的顺序文件**。在记录很多或访问要求很高的文件中，需要引入索引以提供有效的访问。实际中，通过索引可以成百上千倍地提高访问速度。  
+ 索引顺序文件  
索引顺序文件是顺序和索引两种组织形式的结合。索引顺序文件将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中为每组中的第一条记录建立一个索引项，其中含有该记录关键字值和指向该记录的指针。  
对于含有N条记录的顺序文件，查找某关键字值的记录时，评价需要查找N/2次。在索引顺序文件中，假设N条记录分为N^(1/2)组，索引表中有N^(1/2)个表项，每组有N^(1/2)条记录，在查找某关键字值的记录时，先顺序查找索引表，需查找N^(1/2)/2次，然后在主文件中对应的组中顺序查找，也需要查找N^(1/2)/2次，因此共需要查找N^(1/2)次。显然，索引顺序文件提高了查找效率，若查找记录甚多，则可采用两级或多级索引。  
+ 直接文件或散列文件  
给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址。这种映射结构不同于顺序文件或索引文件，没有顺序的特性。散列文件有很高的存取速度，但是会存在冲突，即不同关键字的散列函数值相同。  
### 目录结构  
与文件管理系统和文件集合相关联的是文件目录，**它包含有关文件的信息如属性、位置和所有权等**，这些信息主要由操作系统进行管理。目录管理的基本要求：从用户角度看，目录在用户（应用程序）所需要的文件名和文件之间提供一种映射，所以目录管理要实现“按名存取”；目录存取的效率直接影响到系统的性能，所以要提高对目录的检索速度；在共享系统中，目录还需要提供用于用于控制访问文件的信息。此外，文件允许重名也是用户的合理和必然要求，目录管理通过树形结构来解决和实现。  
1. 文件控制块和索引节点  
与进程管理一样，为实现目录管理，操作系统中引入了文件控制块的数据结构。  
+ 文件控制块FCB  
文件控制块是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。  
FCB主要包含以下信息：  
  - 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。  
  - 存取控制信息，如文件存取权限等。  
  - 使用信息，如文件建立时间、修改时间等。  
+ 索引结点  
**在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项读出该文件的物理地址**。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需要调入内存。因此有的系统采用了文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为索引节点的数据结构，简称i结点。在文件目录中的每个目录项仅由文件名和指向该文件所对应的i结点的指针构成。  
存放在磁盘的索引结点称为磁盘索引结点，UNIX中的每个文件都有一个唯一的磁盘索引结点，主要包括以下几个方面：  
  - 文件主标识符，拥有该文件的个人或小组的标识符。  
  - 文件类型，包括普通文件、目录文件和特别文件。  
  - 文件存取权限，各类用户对该文件的存取权限。  
  - 文件物理地址，每个索引结点中含有13个地址项，即iaddr(0)~iaddr(12)，它们以直接或间接方式给出数据文件所在盘块的编号。  
  - 文件长度，以字节为单位。  
  - 文件链接计数，在本文件系统中所有指向该文件的文件名的指针计数。  
  - 文件存取时间，本文件最近被进程存取的时间、最近被修改的时间及索引结点最近被修改的时间。  
  文件被打开时，磁盘索引结点复制到内存的索引结点中，以便于使用。在内存索引结点中又增加了以下内容：  
  - 索引节点编号，用于标志内存索引结点。  
  - 状态，指示i节点是否上锁或被修改。  
  - 访问计数，每当有一进程要访问此i结点时，计数加1，访问结束减1。  
  - 逻辑设备号，文件所属文件系统的逻辑设备号。  
  - 链接指针，设置分别指向空闲链表和散列队列的指针。  
2. 目录结构  
+ 目录这个层次上所需要执行的操作：  
  - 搜索  
  当用户使用一个文件时，需要搜索目录，以找到该文件的对应目录项。  
  - 创建文件  
  当创建一个新文件时，需要在目录中增加一个目录项。  
  - 删除文件  
  当删除一个文件时，需要在目录中删除相应的目录项。  
  - 显示目录  
  用户可以请求显示目录的内容，如显示该用户目录中的所有文件及属性。  
  - 修改目录  
  某些文件属性保存在目录中，因而这些属性的变化需要改变相应的目录项。  
+ 操作时，考虑以下几种目录结构：  
  - 单级目录结构  
  在整个系统中只建立一张目录表，每个文件占一个目录项。当访问一个文件时，先按文件名在该目录中查找到相应的FCB，经合法性检查后执行相应的操作。当建立一个新文件时，必须先检索所有目录项以确保没有“重名” 的情况，然后在目录中增设一项，把FCB的全部信息保存在该项中。当删除一个文件时，先从该目录中找到该文件的目录项，回收该文件所占用的存储空间，然后清除该目录项。  
  单级目录结构实现了“按名存取”，但是存在查找速度缓慢、文件不允许重名的文件、不便于文件共享等缺点，而且对于多用户的操作系统显然是不适用的。  
  - 两级目录结构  
  单级目录很容易造成文件名称混淆的情况，因此可以采用两级方案，将文件目录分为主文件目录(Master File Directory)和用户文件目录(User File Directory)两级。  
  主文件目录项记录用户名及相应用户文件目录所在的存储位置。用户文件目录项记录该用户文件的FCB信息。当某用户欲对其文件进行访问时，只需搜索该用户对应的UFD，这既解决了不同用户文件的重名问题，又一定程度上保证了文件的安全。  
  两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但是两级目录结构缺乏灵活性，不能对文件分类。  
  

