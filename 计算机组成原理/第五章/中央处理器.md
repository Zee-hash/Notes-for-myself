# 中央处理器  
---  
## CPU的功能和基本结构  
### CPU的功能  
中央处理器CPU由运算器和控制器组成。其中，控制器的功能是负责协调并控制计算机各部件执行程序的指令序列，包括取指令、分析指令和执行指令；运算器的功能是对数据进行加工。CPU的具体功能包括：  
+ 指令控制。完成取指令、分析指令和执行指令的操作，即程序的顺序控制。  
+ 操作控制。一条指令的功能往往由若干操作信号的组合来实现。CPU管理并产生由内存取出的每条指令的操作信号，把各种操作信号送往相应的部件，从而控制这些部件按指令的要求进行动作。  
+ 时间控制。对各种操作加以时间上的控制。时间控制要为每条指令按时间顺序提供应有的控制信号。  
+ 数据加工。对数据进行算术和逻辑运算。  
+ 中断处理。对计算机运行过程中出现的异常情况和特殊情况进行处理。  

### CPU的基本结构  
在计算机系统中，中央处理器主要由运算器和控制器两大部分组成。  
#### 运算器  
运算器接收从控制器送来的命令并执行相应的动作，对数据进行加工和处理。运算器是计算机对数据进行加工处理的中心，它主要由算术逻辑单元ALU、暂存寄存器、累加寄存器ACC、通用寄存器组、程序状态字寄存器PSW、移位器、计数器CT等组成。  
+ 算术逻辑单元。主要功能是进行算术和逻辑运算。  
+ 暂存寄存器。用于暂存从主存读来的数据，该数据不能存放在通用寄存器中，否则会被破坏其原有内容。**暂存寄存器对应用程序员是透明的。**  
+ 累加寄存器。它是一个通用寄存器，用于暂时存放ALU运算的结果信息，可以作为加法运算的一个输入端。  
+ 通用寄存器组。如AX、BX、CX、DX、SP等，用于存放操作数（包括源操作数、目的操作数及中间结果）和各种地址信息等。SP是堆栈指针，用于指示栈顶的地址。  
+ 程序状态字寄存器。保留由算术逻辑运算指令或测试指令而建立的各种状态信息，如溢出标志OF、符合标志SF、零标志ZF、进位标志CF等。PSW中的这些位参与并决定微操作的形成。  
+ 移位器。对操作数或运算结果进行移位运算。  
+ 计数器。控制乘除运算的操作步数。  

#### 控制器  
控制器是整个系统的指挥中枢，在控制器的控制下，运算器、存储器和输入/输出设备等功能部件构成一个有机的整体，根据指令的要求指挥全机协调工作。控制器的基本功能是执行指令，每条指令的执行是由控制器发出的一组微操作实现的。  
控制器有硬布线控制器和微程序控制器两种类型。  
控制器由程序计数器PC、指令寄存器IR、指令译码器、存储器地址寄存器MAR、存储器数据寄存器MDR、时序系统和微操作信号发生器等组成。  
+ 程序计数器。用于指出下一条指令在主存中的存放地址。CPU根据PC的内容去主存中取指令。因程序中指令（通常）是顺序执行的，所以PC有自增功能。  
+ 指令寄存器。用于保存当前正在执行的那条指令。  
+ 指令译码器。仅对操作码字段进行译码，向控制器提供特定的操作信号。  
+ 存储器地址寄存器。用于存放要访问的主存单元的地址。  
+ 存储器数据寄存器。用于存放向主存写入的信息或从主存读出的信息。  
+ 时序系统。用于产生各种时序信号，它们都由统一时钟CLOCK分频得到。  
+ 微操作信号发生器。根据IR的内容（指令）、PSW的内容（状态信息）及时序信号，产生控制整个计算机系统所需的各种控制信号，其结构有组合逻辑型和存储逻辑型两种。  

控制器的工作原理是，根据指令操作码、指令的执行步骤（微操作序列）和条件信号来形成当前计算机各部件要用到的控制信号。计算机整机各硬件系统在这些控制信号的控制下协同运行，产生预期的执行结果。  

---  
## 指令执行过程  
### 指令周期  
CPU从主存中取出并执行一条指令的时间称为指令周期，不同指令的指令周期可能不同。指令周期常用若干机器周期来表示，一个机器周期又包含若干时钟周期（也称节拍或T周期，它是CPU操作的最基本单位）。每个指令周期内的机器周期数可以不等，每隔机器周期内的节拍数也可以不等。  
对于无条件转移指令`JMP X`，在执行时不需要访问主存，只包含取指阶段（包含取指和分析）和执行阶段，所以其指令周期仅包含取指周期和执行周期。  
对于间接寻址的指令，为了取操作数，需要先访问一次主存，取出有效地址，然后访问主存，取出操作数，所以还需包括间址周期。间址周期介于取指周期和执行周期之间。  
当CPU采用中断方式实现主机和I/O设备的信息交换时，CPU在每条指令执行结束前，都要发中断查询信号，若有中断需求，则CPU进入中断响应阶段，又称中断周期。一个完整的指令周期应包括**取指、间址、执行和中断**4个周期。  

|取指周期|间址周期|执行周期|中断周期|  
|---|---|---|---|  

上述4个工作周期都有CPU访存操作，只是访存的目的不同。取指周期是为了取指令，间址周期是为了取有效地址，执行周期是为了取操作数，中断周期是为了保存程序断点。  
**为了区分不同的工作周期，在CPU内设置4个标志触发器FE、IND、EX和INT，它们分别对应取指、间址、执行和中断周期，并以“1”状态表示有效，分别由1->FE、1->IND、1->EX和1->INT这4个信号控制。**  
### 指令周期的数据流  
数据流是根据指令要求依次访问的数据序列。在指令执行的不同阶段，要求依次访问的数据序列是不同的。而且对于不同的指令，它们的数据流往往也是不同的。  
#### 取指周期  
取指周期的任务是根据PC中的内容从主存中取出指令代码并存放在IR中。  
PC中存放的是指令的地址，根据此地址从内存单元中取出的是指令，并放在指令寄存器IR中，取指令的同时，PC加1。  
取指周期的数据流向如下：  
+ PC->MAR->地址总线->主存  
+ CU发出控制信号->控制总线->主存  
+ 主存->数据总线->MDR->IR  
+ CU发出读命令->PC内容加1  

#### 间址周期  
间址周期的任务是**取操作数的有效地址**（执行周期才取实际的操作数）。一次间址的过程：将指令中的地址码送到MAR并送至地址总线，此后CU向存储器发读命令，以获取有效地址并存至MDR。  
间址周期的数据流向如下：  
+ Ad(IR)（或MDR）->MAR->地址总线->主存（取指周期结束后指令在MDR中也有一份）  
+ CU发出读命令->控制总线->主存  
+ 主存->数据总线->MDR(存放有效地址)  

其中，Ad(IR)表示取出IR中存放的指令字的地址字段。  
#### 执行周期  
执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果。不同指令的执行周期操作不同，因此没有统一的数据流向。  
#### 中断周期  
中断周期的任务是处理中断请求。假设程序断点存入堆栈中，并用SP指示栈顶地址，而且进栈操作是先修改栈顶指针，后存入数据（不同的数据结构定义规则对应的操作不一样）。  
中断周期的数据流向如下：  
+ CU控制将SP减1,SP->MAR->地址总线->主存  
+ CU发出写命令->控制总线->主存  
+ PC->MDR->数据总线->主存(程序断点存入主存)  
+ CU（中断服务程序的入口地址）->PC  

### 指令执行方案  
一个指令周期通常要包括几个时间段（执行步骤），每个步骤完成指令的一部分功能，几个一次执行的步骤完成这条指令的全部功能。由于性能和硬件成本等考虑，可以选用3种不同的方案来安排指令的执行步骤。  
#### 单指令周期  
对所有指令都选用相同的执行时间来完成，称为单指令周期方案。此时每条指令都在固定的时钟周期内完成，指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。因此，指令周期取决于执行时间最长的指令的执行时间。对于那些本来可以在更短时间内完成的指令，要使用这个较长的周期来完成，会降低整个系统的运行速度。  
#### 多指令周期  
对不同类型的指令选用不同的执行步骤来完成，称为多指令周期方案。指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。但可选用不同个数的时钟周期来完成不同指令的执行过程，指令需要几个周期就为其分配几个周期，而不再要求所有指令占用相同的执行时间。  
#### 流水线方案  
指令之间可以是并行执行的方案，称为流水线方案，其追求的目标是力争在每个时钟脉冲周期完成一条指令的执行过程（只在理想状态下才能达到该效果）。这种方案通过在每个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。  

---  
## 数据通路的功能和基本结构  
### 数据通路的功能  
数据在功能部件之间传送的路径称为数据通路。路径上的部件称为数据通路部件，如ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等。数据通路描述了信息从什么地方开始，中间经过哪些寄存器或多路开关，最后传送到哪个寄存器，这些都需要加以控制。  
数据通路中专门进行数据运算的部件称为执行部件或功能部件。数据通路由控制部件控制。数据通路的功能是实现CPU内部的运算器与寄存器及寄存器之间的数据交换。  
### 数据通路的基本结构  
数据通路的基本结构主要有以下几种：  
+ CPU内部单总线方式  
  将所有寄存器的输入端和输出端都连接到一条公共通路上，这种结果比较简单，但数据传输存在较多的冲突现象，性能较低。连接各部件的总线只有一条时，称为单总线结构；CPU中有两条或更多的总线时，构成双总线结构或多总线结构。  
+ CPU内部三总线方式  
  将所有寄存器的输入端和输出端都连接到多条公共通路上，相比之下单总线中一个时钟只允许传一个数据，因而指令执行效率很低，因此采用多总线方式，同时在多个总线上传送不同的数据，提高效率。  
+ 专用数据通路方式  
  根据指令的执行过程中的数据和地址的流动方向安排连接线路，避免使用共享的总线，性能较高，但硬件量大。  

#### 寄存器之间的数据传送  
寄存器之间的数据传送可通过CPU内部总线完成。某寄存器AX的输出和输入分别由AXout和AXin控制。若把PC内容传至MAR，实现传送操作的流程和控制信号为：  
`PC->Bus`PCout有效，PC内容送总线  
`Bus->MAR`MARin有效，总线内容送MAR  
#### 主存和CPU之间的数据传送  
主存和CPU之间的数据传送也要借助CPU内部总线完成。现以CPU从主存读取说指令为例说明数据在数据通路中的传送过程。实现传送操作的流程及控制信号为：  
`PC->Bus->MAR`PCout和MARin有效，现行指令地址->MAR  
`1->R`CU发出读命令  
`MEM(MAR)->MDR`MDRin有效  
`MDR->Bus->IR`MDRout和IRin有效，现行指令->IR  
#### 执行算术或逻辑运算  
执行算术或逻辑操作时，由于ALU本身是没有任何内部存储功能的组合电路，因此如要执行加法运算，相加的两个数必须在ALU的两个输入端同时有效。暂存器Y即用于该目的。先将一个操作数经CPU内部总线送入暂存器Y保存，Y的内容在ALU的左输入端始终有效，再将另一个操作数经总线直接送到ALU的右输入端。这样两个操作数都送入了ALU，运算结果暂存在暂存器Z中。  
`Ad(IR)->Bus->MAR`MDRout和MARin有效  
`1->R`CU发读命令  
`MEM->数据线->MDR`操作数从存储器->数据线->MDR  
`MDR->Bus->Y`MDRout和Yin有效，操作数->Y  
`(ACC)+(Y)->Z`ACCout和ALUin有效，CU向ALU发加命令，结果->Z  
`Z->ACC`Zout和ACCin有效，结果->ACC  
数据通路结构直接影响CPU内各种信息的传送路径，数据通路不同，指令执行过程的微操作序列的安排也不同，它关系着微操作信号形成部件的设计。  

---  
## 控制器的功能和工作原理  
### 控制器的结构和功能  
计算机硬件系统的主要部件和连接关系：  
+ 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据。  
+ 输入设备和输出设备通过接口电路与总线相连接。  
+ 内存储器、输入设备和输出设备从地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其他部件传送数据。  
+ 控制器部件从数据总线接收指令信息，从运算器部件接收指令转移地址，送出指令地址到地址总线，还要向系统中的部件提供它们运行所需要的控制信息。  

控制器是计算机系统的指挥中心，控制器的主要功能有：  
+ 从主存中取出一条指令，并指出下一条指令在主存中的位置。  
+ 对指令进行译码或测试，产生相应的操作控制信号，以便启动规定的动作。  
+ 指挥并控制CPU、主存、输入和输出设备之间的数据流动方向。  

根据控制器产生微操作控制信号的方式的不同，控制器可分为硬布线控制器和微程序控制器，两类控制器中的PC和IR是相同的，但确定和表示执行步骤的方法以及给出控制各部件运行所需要的控制信号的方案时不同的。  
### 硬布线控制器  
硬布线控制器的基本原理是根据指令的要求、当前的时序及外部和内部的状态，按时间的顺序发送一系列微操作控制信号。它由复杂的组合逻辑门电路和一些触发器构成，因此又称组合逻辑控制器。  
#### 硬布线控制单元  
指令的操作码是决定控制单元发出不同操作命令（控制信号）的关键。为了简化控制单元（CU）的逻辑，将指令的操作码译码和节拍发生器从CU分离出来。  
CU的输入信号来源如下：  
+ 经指令译码器译码产生的指令信息。现行指令的操作码决定了不同指令在执行周期所需完成的不同操作，因此指令的操作码字段时控制单元的输入信号，它和时钟配合产生不同的控制信号。  
+ 时序系统产生的机器周期信号和节拍信号。为了使控制单元按一定的先后顺序、一定的节奏发出各个控制信号，控制单元必须受时钟控制，即一个时钟脉冲使控制单元发送一个操作命令，或发送一组需要同时执行的操作命令。  
+ 来自执行单元的反馈即标志。控制单元有时需要依赖CPU当前所处的状态产生控制信号。  
个别指令的操作不仅受操作码控制，还受状态标志控制，因此CU的输入来自操作码译码电路ID、节拍发生器及状态标志，其输出到CPU内部或外部控制总线上。  
#### 硬布线控制器的时序系统及微操作  
+ 时钟周期  
  用时钟信号控制节拍发生器，可以产生节拍，每个节拍的宽度正好对应一个时钟周期。在每个节拍内机器可以完成一个或几个需同时执行的操作。  
+ 机器周期  
  机器周期可视为所有指令执行过程中的一个基准时间。不同指令的操作不同，指令周期也不同。访问一次存储器的时间是固定的，因此通常以存取周期为基准时间，即内存中读取一个指令字的最短时间作为机器周期。在存储字长等于指令字长的前提下，取指周期也可视为机器周期。  
  在一个机器周期里可完成若干微操作，每个微操作都需一定的时间，可用时钟信号来控制产生每个微操作命令。  
+ 指令周期  
#### CPU的控制方式  
控制单元控制一条指令执行的过程，实质上是依次执行一个确定的微操作序列的过程。由于不同指令所对应的微操作数及复杂程度不同，因此每条指令和每隔微操作所需的执行时间也不同。主要有以下3种控制方式：  
+ 同步控制方式  
  所谓同步控制方式，是指系统有一个统一的时钟，所有的控制信号均来自这个同一的时钟信号。通常以最长的微操作序列和最烦琐的微操作作为标准，采取完全统一的、具有相同时间间隔和相同数目的节拍作为机器周期来运行不同的指令。  
+ 异步控制方式  
  异步控制方式不存在基准时标信号，各部件按自身固有的速度工作，通过应答方式进行联络。  
  异步控制方式的优点是运行速度快，缺点是控制电路比较复杂。  
+ 联合控制方式  
  联合控制方式是介于同步、异步之间的一种折中。这种方式对各种不同的指令的微操作实现大部分采用同步控制方式、小部分采用异步控制的方法。  
### 微程序控制器  
微程序控制器采用存储逻辑实现，也就是把微操作信号代码化，使每条机器指令转化称为一段微程序并存入一个专门的存储器（控制存储器）中，微操作控制信号由微指令产生。  
#### 微程序控制的基本概念  
**微程序设计思想就是将每条机器指令编写成一个微程序，每隔微程序包含若干微指令，每条微指令对应一个或几个微操作命令。** 这些微程序可以存放到一个控制存储器中，用寻址用户程序机器指令的办法来寻址每隔微程序中的微指令。目前，大多数计算机都采用微程序设计技术。  
微程序设计技术涉及的基本术语如下：  
+ 微命令与微操作  
  一条机器指令可以分解成一个微操作序列，这些微操作是计算机中最基本的、不可再分解的操作。在微程序控制的计算机中，将控制部件向执行部件发出的各种控制命令称为微命令，它是构成控制序列的最小单位。微命令和微操作是一一对应的，微命令是微操作的控制信号，微操作是微命令的执行过程。  
  微命令有相容性和互斥性之分。相容性微命令是指那些可以同时完成、共同完成某一些微操作的微命令；而互斥性微命令是指在在机器中不允许同时出现的微命令相容和互斥都是相对的，一个微命令可以和一些微命令相容，和另一些微命令互斥。  
+ 微指令与微周期  
  微指令是若干微命令的集合。存放微指令的控制存储器的单元地址称为微地址。一条微指令通常至少包含两大部分信息：  
  - 操作控制字段，又称微操作码字段，用于产生某一步操作所需的各种操作控制信号。  
  - 顺序控制字段，又称微地址码字段，用于控制产生下一条要执行的微指令地址。  
  微周期通常指从控制存储器中读取一条微指令并执行相应的微操作所需的时间。  
+ 主存储器与控制存储器  
  主存储器用于存放程序和数据，在CPU外部，用RAM实现；控制存储器CM用于存放微程序，在CPU内部，用ROM实现。  
+ 程序和微程序  
  程序是指令的有序集合，用于完成特定的功能；微程序时微指令的有序集合，一条指令的功能是由一段微程序来实现的。  

微程序和程序是两个不同的概念。微程序是由微指令组成的，用于描述机器指令。微程序实际上是机器指令的实时解释器，是由计算机设计者事先编制好并存放在控制存储器中的，一般不提供给用户。对于程序员来说，计算机系统中微程序的结构和功能是透明的，无须知道。而程序最终由机器指令组成，是由软件设计人员事先编制好并存放在主存或辅存中的。  
#### 微程序控制器组成和工作过程  
1. 微程序控制器的基本组成  
   微程序控制器主要包括以下部件：  
   + 控制存储器。它是微程序控制器的核心部件，用于存放各指令对应的微程序，控制存储器可用只读存储器ROM构成。  
   + 微指令寄存器。用于存放从CM中取出的微指令，它的位数同微指令字长相等。  
   + 微地址形成部件。用于产生初始微地址和后续微地址，以保证微指令的连续执行。  
   + 微地址寄存器。接收微地址形成部件送来的微地址，为在CM中读取微指令作准备。  
2. 微程序控制器的工作过程  
微程序控制器的工作过程实际上就是在微程序控制器的控制下计算机执行机器指令的过程，这个过程可以描述如下：  
   + 执行取微指令公共操作。具体的执行是：在机器开始运行时，自动将取指微程序的入口地址送入CMAR，并从CM中读出相应的微指令送入CMDR。取指微程序的入口地址一般为CM的0号单元，当取指微指令执行完后，从主存中取出的机器指令就已存入指令寄存器中。  
   + 由机器指令的操作码字段通过微地址形成部件产生该机器指令对应的微程序的入口地址，并送入CMDR。  
   + 从CM中逐条取出对应的微指令并执行。  
   + 执行完对应一条机器指令的一个微程序后，又回到取指微程序的入口地址，继续执行第一步，以完成取下一条机器指令的公共操作。  
以上是一条机器指令的执行过程，如此周而复始，直至整个程序执行完毕。  
3. 微程序和机器指令  
   通常，一个机器指令对应一个微程序。由于任何一条机器指令的取指令操作都是相同的，因此可将取指令操作的微命令统一编成一个微程序，这个微程序只负责将指令从主存单元中取出来送至指令寄存器。  
   此外，也可编出对应间址周期的微程序和中断周期的微程序。这样，控制存储器中的微程序的个数应为机器指令数再加上对应取指、间址和中断周期等共用的微程序数。  
#### 微指令的编码方式  
微指令的编码方式又称微指令的控制方式，是指如何对微指令的控制字段进行编码，以形成控制信号。编码的目标是在保证速度的情况下，尽量缩短微指令字长。  
1. 直接编码（直接控制）方式  
   直接编码法无须进行译码，微指令的微命令字段每位都代表一个微命令。设计微命令时，选用或不选用某个微命令，只要将表示该微命令的对应位设置成1或0即可。每个微命令对应并控制数据通路中的一个微操作。  
这种编码的优点是简单、直观，执行速度快，操作并行性好；缺点是微指令字长过长，n个微命令就要求微指令的操作字段有n位，造成控制存储器容量极大。  
2. 字段直接编码方式  
   将微指令的微命令字段分成若干小字段，把互斥性微命令组合在同一个字段中，把相容性微命令组合在不同字段中，每个字段独立编码，每种编码代表一个微命令且各字段编码含义单独定义，与其他字段无关，这就是字段直接编码方式。  
   这种方式可以缩短微指令字长，但因为要通过译码电路后再发出微命令，因此比直接编码方式慢。  
   微命令字段分段的原则：  
   + 互斥性微命令分在同一段中，相容性微命令分在不同段中。  
   + 每个小段中包含的信息位不能太多，否则将增加译码线路的复杂性和译码时间。  
   + **一般每隔小段还要留出一个状态，表示本字段不发出任何微命令。** 因此，当某字段的长度为3位时，最多只能表示7个互斥的微命令，通常用`000`表示不操作。  
3. 字段间接编码方式  
   一个字段的某些微命令需要由另一个字段中的某些微命令来解释，由于不是靠字段直接译码发出的微命令，因此称为字段间接编码，又称隐式编码。这种方式可进一步缩短微指令字长，但因削弱了微指令的并行控制能力，由此通常作为字段直接编码方式的一种辅助手段。  
#### 微指令的地址形成方式  
后继微地址的形成主要有以下两大基本类型：  
+ 直接由微指令的下地址字段指出。微指令格式中设置一个下地址字段，由微指令的下地址字段直接指出后继微指令的地址，这种方式又称断定方式。  
+ 根据机器指令的操作码形成。机器指令取至指令寄存器后，微指令的地址由操作码经微地址形成部件形成。  

实际上，微指令序列地址的形成方式还有以下几种：  
+ 增量计数器法。即(CMDR)+1->(CMAR)，适用于后继微指令的地址连续的情况。  
+ 根据各种标志决定微指令分支转移的地址。  
+ 通过网络测试形成。  
+ 由硬件直接产生微程序入口地址。  

电源加电后，第一条微指令的地址可由专门的硬件电路产生，也可由外部直接向CMAR输入微指令的地址，这个地址即为取指周期微程序的入口地址。  
#### 微指令的格式  
微指令格式与微指令的编码方式有关，通常分为水平型微指令和垂直型微指令两种。  
+ 水平型微指令  
  从编码方式看，直接编码、字段直接编码、字段间接编码和混合编码都属于水平型微指令。指令字中的一位对应一个控制信号，有输出时为1，否则为0。一条水平型微指令定义并执行集中并行的基本操作。  
  水平型微指令的优点是微程序短，执行速度快；缺点是微指令长，编写微程序较麻烦。  
+ 垂直型微指令
  垂直型微指令的特点是采用类似机器指令操作码的方式，在微指令中设置微操作码字段，采用微操作码编译法，由微操作码规定微指令的功能。一条垂直型微指令只能定义并执行一种基本操作。  
  垂直型微指令格式的优点是微指令短、简单、规整。便于编写微程序；缺点是微程序长，执行速度慢，工作效率低。  
+ 混合型微指令  
  在垂直型的基础上增加一些不太复习的并行操作。微指令较短，仍便于编写；微程序也不长，执行速度加快。  
+ 水平型微指令和垂直型微指令的比较如下：  
  - 水平型微指令并行操作能力强、效率高、灵活性强；垂直型微指令则较差。  
  - 水平型微指令执行一条指令的时间短；垂直型微指令执行的时间长。  
  - 由水平型微指令解释指令的微程序，具有微指令字较长但微程序短的特点；垂直型微指令则与之相反，其微指令字较短而微程序长。  
  - 水平型微指令用户难以掌握，而垂直型微指令与指令比较类似，相对容易掌握。  

---  
## 指令流水线  
### 指令流水线的基本概念  
计算机的流水线把一个重复的过程分解为若干子过程，每个子过程与其他子过程并行执行。由于采用流水线技术只需增加少量硬件就能把计算机的运算速度提高几倍，因此成为计算机普遍使用的一种并行处理技术。  
#### 指令流水的定义  
一条指令的执行过程可分为多个阶段（或过程）。根据计算机的不同，具体的分法也不同。一条指令的执行过程可划分为如下三个阶段：

|取指|分析|执行|  
|---|---|---|  

取指：根据PC内容访问主存储器，取出一条指令送到IR中。  
分析：对指令操作码进行译码，按照给定的寻址方式和地址字段中的内容形成操作数的有效地址EA，并从有效地址EA中取出操作数。  
执行。  
执行：根据操作码字段，完成指令规定的功能，即把运算结果写到通用寄存器或主存中。  
当多条指令在处理器中执行时，可以采用以下三种方式：  
+ 顺序执行方式  
  指令按顺序执行，前一条指令执行完后，才启动下一条指令。设取指、分析、执行三个阶段的时间都相等，用t表示，顺序执行n条指令所用时间  
  `T=3nt`  
  传统冯·诺依曼机采用顺序执行方式，又称串行执行方式。其优点是控制简单，硬件代价小；缺点是执行指令的速度较慢，在任何时刻，处理机中只有一条指令在执行，各部件的利用率很低。例如取指时内存是忙碌的，而指令执行部件是空闲的。  
+ 一次重叠执行方式  
  这种方式同时进行第k条指令的执行阶段和第k+1条指令的取指阶段。采用此种方式时，执行n条指令所用的时间为  
  `T=(1+2n)t`  
  采用一次重叠执行方式的优点是，程序的执行时间缩短了1/3，各功能部件的利用率明显提高。但为此需要付出硬件上较大开销的代价，控制过程也比顺序执行复杂。  
+ 二次重叠执行方式  
  为了进一步提高指令的执行速度，可以把取k+1条指令提前到分析第k条指令的期间完成，而将分析第k+1条指令与执行第k条指令同时进行。采用此种方式时，执行n条指令所用的时间为  
  `T=(2+n)t`  
  与顺序执行相比，采用二次重叠执行方式能够使指令的执行时间缩短近2/3。这是一种理想的指令执行方式，在这种情况下，处理机中同时有三条指令在执行。  

若某条指令需要通过m个执行步骤完成，则可以采用m-1次重叠执行方式。  
#### 流水线的表示方式  
通常用时空图来直观地描述流水线的工作过程。  
在时空图中，横坐标表示时间，即输入流水线中的各个任务在流水线中所经过的时间。流水线中各个流水段的执行时间都相等时，横坐标就被分割成长度相等的时间段。纵坐标表示空间，即流水线的每个流水段（对应各执行部件）。  
#### 流水线方式的特点  
与传统的串行执行方式相比，采用流水线方式具有如下特点：  
+ 把一个任务（一条指令或一个操作）分解为几个有联系的子任务，每个子任务由一个专门的功能部件来执行，并依靠多个功能部件并行工作来缩短程序的执行时间。  
+ 流水线每个功能段部件后面都要有一个缓冲寄存器，或称锁存器，其作用是保存本流水段的执行结果，供给下一流水段使用。  
+ 流水线中各功能段的时间应尽量相等，否则将引起堵塞、断流。  
+ 只有连续不断地提供同一种任务时才能发挥流水线的效率，所以在流水线中处理的必须是连续任务。在采用流水线方式工作的处理机中，要在软件和硬件设计等多方面尽量为流水线提供连续的任务。  
+ 流水线需要有装入时间和排空时间。装入时间是指第一个任务进入流水线到输出流水线的时间。排空时间是指最后一个任务进入流水线到输出流水线的时间。  

### 流水线的分类  
根据不同的分类标准，可以把流水线分成多种不同的种类。下面从几个不同的角度介绍流水线的基本分类方法。  
#### 部件功能级、处理机级和处理机间级流水线  
+ 部件功能级
  部件功能级流水将复杂的算术逻辑单元运算组成流水线工作方式。例如，可将浮点加法操作分成求阶差、对阶、尾数相加及结果规格化等4个子过程。  
+ 处理机级  
  处理机级流水把一条指令解释过程分成多个子过程，如取指、译码、执行、访存和写回5个过程。  
+ 处理机间级  
  处理机间级流水是一种宏流水，其中每个处理机完成某一专门任务，各个处理机得到的结果需存放在与下一个处理机共享的存储器中。  
#### 单功能流水线和多功能流水线  
+ 单功能流水线  
  只能完成一种固定功能的专门功能的流水线。  
+ 多功能流水线  
  通过各段间的不同连接方式可以同时或不同时地实现多种功能的流水线。  
#### 动态流水线和静态流水线  
+ 静态流水线  
  在同一时间内，流水线的各段只能按同一种功能的连接方式工作。  
+ 动态流水线  
  在同一时间内，当某些段正在实现某种运算时，另一些段却正在进行另一种运算。这样对提高流水线的效率很有好处，但会使流水线控制变得很复杂。  
#### 线性流水线和非线性流水线  
+ 线性流水线  
  从输入到输出，每个功能段只允许经过一次，不存在反馈回路。  
+ 非线性流水线  
  存在反馈回路，从输入到输出的过程中，某些功能段将数次通过流水线，这种流水线适合进行线性递归的运算。  

流水线的每个子过程都由专门的功能段实现，各功能所需的时间段应尽尽量相等。否则，时间长的功能段将成为流水线的瓶颈。  

### 影响流水线的因素  
影响流水线性能的因素主要有两方面：资源冲突和相关问题。  
由于多条指令在同一时刻争用同一资源而形成的冲突称为资源冲突，有以下两个解决办法：  
+ 前一指令访存时，使后一条相关指令（以及其后续指令）暂停一个时钟周期。  
+ 单独设置数据存储器和指令寄存器，使两项操作各自在不同的存储器中进行。  
#### 数据冲突（数据冒险）  
在一个程序中，下一条指令会用到这一条指令计算出的结果，此时这两条指令即为数据冒险。当多条指令重叠时就会发生冲突，解决的办法有以下几种：  
+ 把遇到数据相关的指令及其后续指令都暂停一至几个时钟周期，直到数据相关问题消失后再继续执行，可分为硬件阻塞(stall)和软件插入”NOP“指令两种方法。  
+ 设置相关专用通路，即不等前一条指令把计算结果写回寄存器组，下一条指令也不再读寄存器组，而直接把前一条指令的ALU的计算结果作为自己的输入数据开始计算过程，使本来需要暂停的操作变得可以继续执行，这称为数据旁路技术。  
+ 通过编译器对数据相关的指令编译优化的方法，调整指令顺序来解决数据相关。  
#### 控制冲突（控制冒险）  
一条指令要确定下一条指令的位置，例如在执行转移、调用或返回等指令时会改变PC值，而造成断流，会引起控制冒险。解决的办法有以下几种：  
+ 对转移指令进行分支预测，尽早生成转移目标地址。分支预测分为简单（静态）预测和动态预测。静态预测总是预测条件不满足，即继续执行分支指令的后续指令。动态预测根据程序执行的历史情况，进行动态预测调整，有较高的预测准确率。  
+ 预测转雨成功和不成功两个控制流方向上的目标指令。  
+ 加快和提前形成条件码。  
+ 提高转移方向的猜准率。