# 文件管理  
## 文件系统基础  
### 文件的概念  
1. 文件的定义  
文件是操作系统中的一个重要概念。文件是以计算机硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、程序等。在系统运行时，计算机以进程为基本单位进行资源的调度和分配；而在用户进行的输入、输出中，则以文件为基本单位。大多数应用程序的输入都是通过文件来实现的，其输出也都保存在文件中，以便信息的长期存储及将来的访问。当用户将文件用于应用程序的输入、输出时，还希望可以访问文件、修改文件和保存文件等，实现对文件的维护管理，这就需要系统提供一个文件管理系统，操作系统中文件系统就是用于实现用户的这些管理要求的。  
文件的组成：  
首先，文件中肯定包括一块存储空间，更准确的说，是存储空间中的数据；其次，由于操作系统要管理成千上万的数据，因此必定需要对这些数据进行划分，然后贴上“标签”，以便于分类和索引，所以文件必定包含分类和索引的信息；最后，不同的用户拥有对数据的不同访问权限，因此文件中一定含有一些关于访问权限的信息。  
从用户的角度看，文件系统是操作系统的重要部分之一。用户关心的是如何命名、分类和查找文件，如何保证文件数据的安全性及对文件可以进行哪些操作等，而对其中的细节，如文件如何存储在辅存上、如何管理文件辅存区域等关心甚少。  
文件系统提供了与二级存储相关的资源的抽象，让用户能在不了解文件的各种属性、文件存储介质的特征及文件在存储介质上的具体位置等情况下，方便快捷地使用文件。  
用于通过文件系统建立文件，提供应用程序的输入、输出，对资源进行管理。首先了解文件的结构，文件自底向上的定义如下：  
+ 数据项。数据项是文件系统中最低级的数据组织形式，可分以下两种类型。  
  - 基本数据项。用于描述一个对象的某种属性的一个值，如姓名、日期或证件号等，是数据中可命名的最小逻辑数据单位，即原子数据。  
  - 组合数据项。由多个基本数据项组成。  
+ 记录。记录是一组相关的数据项的集合，用于描述一个对象在某方面的属性。  
+ 文件。文件是指由创建者所定义的一组相关信息的集合，逻辑上可分为有结构文件和无结构文件两种。  
  - 有结构文件。文件由一组相似的记录组成，又称记录式文件。  
  - 无结构文件。无结构文件被视为一个字符流，又称流式文件。  
2. 文件的属性  
文件具有一定的属性，系统不同，属性也会有所不同，但通常都包括如下属性：  
+ 名称。文件名称唯一，以容易读取的形式保存。  
+ 标识符。标识文件系统内文件的唯一标签，通常为数字，是对人不可读的一个内部名称。  
+ 类型。被支持不同类型的文件系统所使用。  
+ 位置。指向设备和设备上文件的指针。  
+ 大小。文件当前大小（用字节、字或块表示），也可包含文件允许的最大值。  
+ 保护。对文件进行保护的访问控制信息。  
+ 时间、日期和用户标识。文件创建、上次修改和上次访问的相关信息，用于保护和跟踪文件的使用。  
**所有文件的信息都被保存在目录结构中，而目录结构保存在外存上。文件信息在需要时才调入内存。通常，目录条目包括文件名称及其唯一的标识符，而标识符定位其他属性的信息。**  
3. 文件的基本操作  
文件属于抽象数据类型。为了恰当地定义文件，需要考虑有关文件的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、删除和截断等操作。  
+ 创建文件。  
创建文件有两个必要步骤:  
  - 在文件系统中为文件找到空间  
  - 在目录中为新文件创建条目，该条目记录文件名称、在文件系统的位置及其他可能的信息。  
+ 写文件  
为了写文件，执行一个系统调用，指明文件名称和要写入文件的内容。对应给定文件名称，系统搜索目录以查找文件位置。系统必须为该文件维护一个写位置的指针。每当发生写操作时，便更新写指针。  
+ 读文件  
为了读文件，执行一个系统调用，指明文件名称和要读入文件块的内存位置。同时，需要搜索目录以找到相关的目录项，系统维护一个读位置的指针。每当发生读操作时，更新读指针。一个进程通常只对一个文件读或写，因此当前操作系统位置可作为每个进程当前文件位置的指针。由于读和写操作都使用了同一指针，因此节省了空间，也降低了系统复杂度。  
+ 文件重定位（文件寻址）  
按某条件搜索目录项，将当前文件位置设为给定值，并且不会读、写文件。  
+ 删除文件  
先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件所占用的存储空间。  
+ 截断文件  
允许文件所有属性不变，并删除文件内容，即将其长度设为0并释放其空间。  
这6个基本操作可以组合起来执行其他文件操作。  
4. 文件的打开与关闭  
因为许多文件操作都涉及为给定文件搜索相关目录条目，因此许多系统要求在首次使用文件时，使用系统调用open指明文件的属性（包括该文件在外存上的物理位置）从外存复制到内存打开文件表的一个表目中，并将该表目的编号（也称索引）返回给用户。操作系统维护一个包含所有打开文件信息的表（打开文件表，open-file table）。当用户需要一个文件操作时，可以通过该表的一个索引指定文件，因此忽略了搜索环节。当文件不再使用时，进程可以关闭它，操作系统从打开文件表中删除这一条目。  
大部分操作系统要求在文件使用之前就被显式地打开。操作open会根据文件名搜索目录，并将目录条目复制到打开文件表。若调用open的请求（创建、只读、读写、添加等）得到允许，则进程就可打开文件，而open通常返回一个指向打开文件表中的一个条目的指针。通过该指针进行所有I/O操作，以简化步骤并节省资源。  
**在open调用完成后，操作系统对该文件的任何操作都不再需要文件名，而只需要通过open调用返回的指针。**  
整个系统表包含进程相关信息，如文件在磁盘的位置、访问日期和大小。一个进程打开一个文件，系统打开文件表就会为打开的文件增加相应的条目。当另一个进程执行open时，只不过是在其进程打开表中增加一个条目，并指向整个系统表的相应条目。通常，系统打开文件表的每个文件时，还用一个文件打开计数器（open count），以记录多少进程打开了该文件。每个关闭操作close使count递减，当打开计数器为0时，表示该文件不再被使用，系统将回收分配给该文件的内存空间等资源。若文件被修改过，则将文件写回外存，并将系统打开文件表中的相应条目删除，最后释放文件的文件控制块FCB。  
每个打开文件都有如下关联信息：  
+ 文件指针  
系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。  
+ 系统打开计数  
文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间会不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。计数器跟踪打开和关闭的数量，计数为0时，系统关闭文件，删除该条目。  
+ 文件磁盘位置  
绝大多数文件操作都要求系统修改文件数据。该信息保存在内存中，以免每个操作都从磁盘中取出。  
+ 访问权限  
每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）。该信息保存在进程的打开文件表中，以便操作系统能够运行或拒绝之后的I/O请求。  

### 文件的逻辑结构  
文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构（又称文件的存储结构）是从实现观点出发看到的文件在外存上的存储组织形式。文件的逻辑结构与存储介质特性无关，但文件的物理结构与存储介质的特性有很大关系。文件的逻辑结构实际上是指在文件的内部，数据逻辑上是如何组织起来的。  
按逻辑结构，文件可划分为无结构文件和有结构文件两种。  
1. 无结构文件（流式文件）  
无结构文件是最简单的文件组织形式。无结构文件将数据按顺序组织成记录并几类、保存，它是有序相关信息项的集合，以字节为单位。由于无结构文件没有结构，而面对记录的访问只能通过穷举搜索的办法，故这种文件形式对大多数应用不适用。但字符流的无结构文件管理简单，用户可以方便对其进行操作。所以，那些对于基本信息单位操作不多的文件较适于采用字符流的无结构方式，如原程序文件、目标代码文件等。  
2. 有结构文件（记录式文件）  
有结构文件按记录的组织形式可以分为如下几种：  
+ 顺序文件  
文件中的记录一个接一个地顺序排列，记录通常是定长的，可以顺序存储或以链表形式存储，在访问时需要顺序搜索文件。顺序文件有以下两种结构：第一种是串结构，记录之间的顺序与关键字无关。通常的办法是由时间决定，即按存入时间的先后排列，最先存入的记录为第一条记录，其次存入的为第二条记录，以此类推。第二种是顺序结构，指文件中所有记录按关键字顺序排列。  
在对记录进行批量操作，即每次要读或写一大批记录时，顺序文件的效率是所有逻辑文件中最高的；此外，也只能顺序文件才能存储在磁带上，并能有效地工作，但顺序文件对查找、修改、增加和删除单条记录的操作比较困难。  
+ 索引文件  
对于定长记录文件，要查找第i条记录，可直接通过计算得出第i条记录相对于第一条记录的地址`Ai = i × L`，然而，对于可变长记录的文件，要查找第i条记录，必须顺序地查找前i-1条记录，从而获得相应记录的长度，进而算出第i条记录的首址。  
变长记录文件只能顺序查找，系统开销较大。为此，可以建立一张索引表以加快检索速度，**索引表本身是定长记录的顺序文件**。在记录很多或访问要求很高的文件中，需要引入索引以提供有效的访问。实际中，通过索引可以成百上千倍地提高访问速度。  
+ 索引顺序文件  
索引顺序文件是顺序和索引两种组织形式的结合。索引顺序文件将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中为每组中的第一条记录建立一个索引项，其中含有该记录关键字值和指向该记录的指针。  
对于含有N条记录的顺序文件，查找某关键字值的记录时，评价需要查找N/2次。在索引顺序文件中，假设N条记录分为N^(1/2)组，索引表中有N^(1/2)个表项，每组有N^(1/2)条记录，在查找某关键字值的记录时，先顺序查找索引表，需查找N^(1/2)/2次，然后在主文件中对应的组中顺序查找，也需要查找N^(1/2)/2次，因此共需要查找N^(1/2)次。显然，索引顺序文件提高了查找效率，若查找记录甚多，则可采用两级或多级索引。  
+ 直接文件或散列文件  
给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址。这种映射结构不同于顺序文件或索引文件，没有顺序的特性。散列文件有很高的存取速度，但是会存在冲突，即不同关键字的散列函数值相同。  
### 目录结构  
与文件管理系统和文件集合相关联的是文件目录，**它包含有关文件的信息如属性、位置和所有权等**，这些信息主要由操作系统进行管理。目录管理的基本要求：从用户角度看，目录在用户（应用程序）所需要的文件名和文件之间提供一种映射，所以目录管理要实现“按名存取”；目录存取的效率直接影响到系统的性能，所以要提高对目录的检索速度；在共享系统中，目录还需要提供用于用于控制访问文件的信息。此外，文件允许重名也是用户的合理和必然要求，目录管理通过树形结构来解决和实现。  
1. 文件控制块和索引节点  
与进程管理一样，为实现目录管理，操作系统中引入了文件控制块的数据结构。  
+ 文件控制块FCB  
文件控制块是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。为了创建一个新文件，系统将分配一个FCB并存放在文件目录中，成为目录项。  
FCB主要包含以下信息：  
  - 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。  
  - 存取控制信息，如文件存取权限等。  
  - 使用信息，如文件建立时间、修改时间等。  
+ 索引结点  
**在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项读出该文件的物理地址**。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需要调入内存。因此有的系统采用了文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为索引节点的数据结构，简称i结点。在文件目录中的每个目录项仅由文件名和指向该文件所对应的i结点的指针构成。  
存放在磁盘的索引结点称为磁盘索引结点，UNIX中的每个文件都有一个唯一的磁盘索引结点，主要包括以下几个方面：  
  - 文件主标识符，拥有该文件的个人或小组的标识符。  
  - 文件类型，包括普通文件、目录文件和特别文件。  
  - 文件存取权限，各类用户对该文件的存取权限。  
  - 文件物理地址，每个索引结点中含有13个地址项，即iaddr(0)~iaddr(12)，它们以直接或间接方式给出数据文件所在盘块的编号。  
  - 文件长度，以字节为单位。  
  - 文件链接计数，在本文件系统中所有指向该文件的文件名的指针计数。  
  - 文件存取时间，本文件最近被进程存取的时间、最近被修改的时间及索引结点最近被修改的时间。  
  文件被打开时，磁盘索引结点复制到内存的索引结点中，以便于使用。在内存索引结点中又增加了以下内容：  
  - 索引节点编号，用于标志内存索引结点。  
  - 状态，指示i节点是否上锁或被修改。  
  - 访问计数，每当有一进程要访问此i结点时，计数加1，访问结束减1。  
  - 逻辑设备号，文件所属文件系统的逻辑设备号。  
  - 链接指针，设置分别指向空闲链表和散列队列的指针。  
2. 目录结构  
+ 目录这个层次上所需要执行的操作：  
  - 搜索  
  当用户使用一个文件时，需要搜索目录，以找到该文件的对应目录项。  
  - 创建文件  
  当创建一个新文件时，需要在目录中增加一个目录项。  
  - 删除文件  
  当删除一个文件时，需要在目录中删除相应的目录项。  
  - 显示目录  
  用户可以请求显示目录的内容，如显示该用户目录中的所有文件及属性。  
  - 修改目录  
  某些文件属性保存在目录中，因而这些属性的变化需要改变相应的目录项。  
+ 操作时，考虑以下几种目录结构：  
  - 单级目录结构  
  在整个系统中只建立一张目录表，每个文件占一个目录项。当访问一个文件时，先按文件名在该目录中查找到相应的FCB，经合法性检查后执行相应的操作。当建立一个新文件时，必须先检索所有目录项以确保没有“重名” 的情况，然后在目录中增设一项，把FCB的全部信息保存在该项中。当删除一个文件时，先从该目录中找到该文件的目录项，回收该文件所占用的存储空间，然后清除该目录项。  
  单级目录结构实现了“按名存取”，但是存在查找速度缓慢、文件不允许重名的文件、不便于文件共享等缺点，而且对于多用户的操作系统显然是不适用的。  
  - 两级目录结构  
  单级目录很容易造成文件名称混淆的情况，因此可以采用两级方案，将文件目录分为主文件目录(Master File Directory)和用户文件目录(User File Directory)两级。  
  主文件目录项记录用户名及相应用户文件目录所在的存储位置。用户文件目录项记录该用户文件的FCB信息。当某用户欲对其文件进行访问时，只需搜索该用户对应的UFD，这既解决了不同用户文件的重名问题，又一定程度上保证了文件的安全。  
  两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但是两级目录结构缺乏灵活性，不能对文件分类。  
  - 多级目录结构（树形目录结构）  
  将两级目录结构的层次关系加以推广，就形成了多级目录结构，即树形目录结构。  
  用户要访问某个文件时，用文件的路径名标识文件，文件路径名是个字符串，由从根目录出发到所找文件通路上所有目录名与数据文件名用“/”链接而成。从根目录出发的路径称为绝对路径。当层次较多时，每次从根目录查询会浪费时间，于是加入了当前目录，进程对各文件的访问都是相对于当前目录进行的。当用户要访问某个文件时，使用相对路径标识文件，相对路径由从当前目录出发到所找文件通路上所有目录名与数据文件名用文件分隔符“/”链接而成。  
  树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够有效地进行文件的管理和保护。但是，在树形目录中查找一个文件时，需要按照路径名逐级访问中间结点，这就增加了磁盘访问次数，无疑将影响查询速度。  
  - 无环图目录结构  
  树形目录结构能便与实现文件分类，但不便于实现文件共享，为此在树形目录结构的基础上增加了一些指向同一结点的有向边，使整个目录成为一个有向无环图。引入无环图目录结构是为了实现文件共享。  
  当用户要求删除一个共享结点时，若系统只是简单地将它删除，则当另一共享用户需要访问时，会因无法找到这个文件而发生错误。为此，可为每个共享节点设置一个共享计数器，每当图中增加对该结点的共享链时，计数器加1；每当某用户提出删除结点时，计数器减1.每当共享计数器为0时，才真正删除该结点，否则仅删除请求用户的共享链。共享文件，只存在一个真正的文件，任何改变都会被其他用户所看见。  
  无环图目录结构方便地实现了文件的共享，但是的系统的管理变得更加复杂。  

### 文件共享  
文件共享使多个用户（进程）共享同一个文件，系统中只需要保留该文件的一个副本。若系统不能提供共享功能，则每个需要该文件的用户都要有各自的副本，会造成对存储空间的极大浪费。随着计算机技术的发展，文件共享的范围已由单机系统发展到多机系统，进而通过网络扩展到全球。这些文件的分享是通过分布式文件系统、远程文件系统、分布式信息系统实现的。这些系统允许多个客户通过C/S模型共享网络中的服务器文件。  
现代常用的两种文件共享方法如下：  
1. 基于索引结点的共享方式（硬链接）  
在树形结构的目录中，当有两个或多个用户要共享一个子目录或文件时，必须将共享文件或子目录链接到两个或多个用户的目录中，才能方便地找到该文件。  
在这种共享方式中，诸如文件的物理地址及其他的文件属性等信息，不再放在目录项中，而是放在索引节点当中。在文件目录中只设置文件名及指向索引结点的指针。在索引结点中还应有一个链接计数count，用于表示链接到本索引结点（即文件）上的用户目录项的数目。当count=2时，表示有两个用户目录项链接到本文件上，或者说有两个共享此文件。  
用户A创建一个新文件时，它便是该文件的所有者，只是将count置为1.用户B要共享此文件时，在用户B的目录中增加一个目录项，并设置一个指针指向该文件的索引结点。此时，文件主仍然是用户A，count=2。用户A不再需要此文件，不能将文件直接删除。因为所删除了文件，则必然也删除了该文件的索引结点，这样便会使用户B的指针悬空，而用户B可能正在此文件上执行写操作，此时用户B会无法访问到文件。因此用户A不能删除文件，只是将该文件的count减1，然后删除自己目录中相应的目录项。用户B仍然可以使用该文件。当count=0时，表示没有用户使用该文件，系统将负责删除该文件。  
2. 利用符号链实现文件共享（软链接）  
为使用户B能够共享用户A的一个文件F，可以由系统创建一个LINK类型的新文件，也取名为F，并将文件F写入用户B的目录中，以实现用户B的目录与文件F的链接。在新文件中包含被链接文件F的路径名，这样的链接方法被称为符号链接。  
新文件中的路径名只被视为符号链，当用户B要访问链接的文件F且正要读LINK类新文件时，操作系统根据新文件中的路径名去读该文件，从而实现用户B对文件F的共享。  
在利用符号链实现文件共享时，只有文件的拥有者才能拥有指向其索引结点的指针。而共享该文件的其他用户只有该文件的路径名，并不拥有指向其索引结点的指针。测氧，也就不会发生在文件主删除一个共享文件后留下一个悬空指针的情况。当文件的拥有者把一个共享文件删除后，其他用户通过符号链去访问它时，会出现访问失败，于是将符号链删除，此时不会产生任何影响。  
当然，利用符号链实现文件共享时仍然存在问题。当用户删除文件后再新建同名的文件，仍然可以被访问到，但访问的文件已经改变，从而导致错误。  
在符号链的共享方式中，当其他用户读共享文件时，需要根据文件路径名逐个地查找目录，直至找到该文件的索引结点。因此，每次访问时，都可能要多次的读盘，使得访问文件的开销变大并增加了启动磁盘的频率。此外，符号链的索引结点也要耗费一定的存储空间。  
**符号链接有一个很大的优点，即网络共享只需要提供该文件所在机器的网络地址及该机器中的文件路径。**  
上述两种链接方式都存在一个共同的问题，即每个共享文件都有几个文件名。换言之，每增加一条链接，就增加一个文件名。这实质上是每个用户都使用自己的路径名去访问共享文件。当我们试图去遍历整个文件系统时，将会多次遍历到该共享文件。  
硬链接和软链接都是文件系统中的静态共享方法，在文件系统中还存在着另外的共享需求，即两个进程同时对同一个文件进行操作，这样的共享称为动态共享。  
文件共享，“软”“硬”兼施。硬链接就是多个指针指向同一个索引结点，保证只要还有一个指针指向索引结点，索引结点就不能被删除；软链接就是把到达共享文件的路径记录下来，当要访问文件时，根据路径寻找文件。硬链接的速度比软链接的查找速度要快。**软链接的路径一般是以软链接所在目录，相对路径访问共享文件的路径。**  

### 文件保护  
为了防止文件共享可能导致文件被破坏或未经核准的用户修改文件，文件系统必须控制用户对文件的存取，即解决对文件读、写、执行的许可问题。为此，必须在文件系统中建立相应的文件保护机制。  
文件保护通过口令保护、加密保护和访问控制等方式实现。其中，口令保护和加密保护是为了防止用户文件被他人存取或窃取，而访问控制则用于控制用户对文件的访问方式。  
1. 访问类型  
对文件的保护可从限制对文件的访问类型中出发。可加以控制的访问类型主要有以下几种。  
+ 读。从文件中读。  
+ 写。向文件内写。  
+ 执行。将文件装入内存并执行。  
+ 添加。将新信息添加到文件结尾部分。  
+ 删除。删除文件、释放空间。  
+ 列表清单。列出文件名和文件属性。  
此外还可以对文件的重命名、复制、编辑等加以控制。这些高层的功能可以通过吃系统程序调用低层系统调用来实现。保护可以只在低层提供。  
2. 访问控制  
解决访问控制最常用的方法是根据用户身份进行控制。而实现基于身份访问的最为普通的方法是，为每个文件和目录增加一个访问控制列表（Access-Control List, ACL），以规定每个用户名及其所允许的访问类型。  
这种方法的优点是可以使用复杂的访问方法，缺点是长度无法预计并且可能导致复杂的空间管理，使用精简的访问列表可以解决这个问题。  
精简的用户访问列表采用拥有者、组和其他三种用户类型(user-group-others)。  
+ 拥有者。创建文件的用户。  
+ 组。一组需要共享文件且具有类似访问的用户。  
+ 其他。系统内的所有其他用户。  
这样，只需要三个域即可列出访问表中这三类用户的访问权限。文件拥有者在创建文件时，说明创建者用户名及所在的组名，系统在创建文件时也将文件主的名字。所属组名列在该文件的FCB中。用户访问该文件时，按照拥有者所拥有的权限访问文件，若用户和拥有者在同一个组，则按照同组权限访问，否则只能按照其他用户权限访问。UNIX操作系统采用的就是这种方法。  
口令和密码是另外两种访问控制的方法：  
口令指用户在建立一个文件时提供一个口令，系统为其建立FCB时附上相应口令，同时告诉允许共享该文件的其他用户。用户请求访问时必须提供相应的口令。这种方法时间和空间的开销不多，缺点是口令直接存在系统内部，不够安全。  
密码指用户对文件进行加密，文件被访问时需要使用秘钥。这种方法保密性强，节省了存储空间，不过编码和译码要花费一定的时间。  
口令和密码都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型。  
注意两个问题：  
+ 现代操作系统常用的文件保护方法是，将访问控制列表与用户、组和其他成员访问控制方案一起组合使用。  
+ 对于多级目录结构而言，不仅需要保护单个文件，而且需要保护子目录内的文件，即需要提供目录保护机制。目录操作与文件操作并不相同，因此需要不同的保护机制。  

---
## 文件系统实现  
### 文件系统层次结构  
现代操作系统有多种文件系统类型（如FAT32、NTFS、ext2、ext3、ext4等），因此文件系统的层次结构也不尽相同。  
1. 文件调用接口  
文件系统为用户提供与文件及目录有关的调用，如新建、打开、读写、关闭、删除文件，建立、删除目录等。此层由若干程序模块组成，每个模块对应一条系统调用，用户发出系统调用时，控制即转入相应的模块。  
2. 文件目录系统  
文件目录系统的主要功能是管理文件目录，其任务有管理活跃文件目录表、管理读写状态信息表、管理用户进程的打开文件表、管理与组织存储设备上的文件目录结构、调用下一级存取控制模块。  
3. 存取控制验证  
实现文件保护主要由该级软件完成，他把用户的访问要求与FCB中指示的访问控制权限进行比较，以确认访问的合法性。  
4. 逻辑文件系统与文件信息缓冲区  
逻辑文件系统与文件信息缓冲区的主要功能是，根据文件的逻辑结构将用户要读写的逻辑记录转换成文件逻辑结构内的相应块号。  
5. 物理文件系统  
物理文件系统的主要功能是把逻辑记录所在的相对块号转换成实际的物理地址。  
6. 辅助分配模块  
分配模块的主要功能是管理辅存空间，即负责分配辅存空闲空间和回收辅存空间。  
7. 设备管理程序模块  
设备管理程序模块的主要功能是分配设备、分配设备读写缓冲区、磁盘调度、启动设备、设备处理中断、释放设备读写缓冲区、释放设备等。  

### 目录实现  
在读文件前，必须先打开文件。打开文件时，操作系统利用路径名找到相应目录项，目录项中提供了查找文件磁盘块所需要的信息。目录实现的基本方法有线性列表和哈希表两种，要注意目录的实现就是为了查找，因此线性列表实现对应线性查找，哈希表的实现对应散列表。  
1. 线性列表  
最简单的目录实现方法是使用存储文件名和数据块指针的线性表。创建新文件时，必须首先搜索目录表以确定有没有同名的文件存在，然后在目录表后增加一个目录项。删除文件则根据给定的文件名搜索目录表，接着释放分配给它的空间。重用目录项有许多方法：可以将目录项标记为不再使用，或给它加到空闲目录项表上，还可以将目录表中的最后一个目录项复制到空闲位置，并降低目录表长度。采用链表结构可以减少删除文件的时间，其优点在于实现简单，不过由于线性表的特殊性，比较费时。  
2. 哈希表  
哈希表根据文件名得到一个值，并返回一个指向线性列表中元素的指针。这种方法的优点是查找非常迅速，插入和删除也较简单，不过需要一些预备措施来避免冲突。最大的困难是哈希表长度固定以及哈希函数对表长的依赖性。  
目录查询是通过在磁盘上反复搜索完成的，需要不断地进行I/O操作，开销较大。所以如前所述，为了减少I/O操作，把当前使用的文件目录复制到内存，以后要使用该文件时只需要在内存中操作，因此降低了磁盘操作次数，提高了系统速度。  
### 文件实现  
文件的实现就是研究文件的物理结构，即文件数据在物理存储设备上是如何分配和组织的。同一个问题有两个方面的回答：一是文件的分配方式，讲的是对磁盘非空闲块的管理；二是文件存储空间管理，讲的是磁盘空闲块的管理。  
1. 文件分配方式  
文件分配对应于文件的物理结构，是指如何为文件分配磁盘块。常用的磁盘空间分配方法有三种：连续分配、链接分配和索引分配。  
+ 连续分配  
连续分配方法要求每个文件在磁盘上占有一组连续的块。磁盘地址定义了磁盘上的一个线性序列。这种排序使得作业访问磁盘所需要的寻道数和寻道时间最小。  
文件的连续分配方式可以用第一块的磁盘地址和连续块的数量来定义。一个文件的目录条目包括开始块的位置和该文件所分配区域的长度。  
连续分配支持顺序访问和直接访问。其优点是实现简单。存储速度快。缺点是侵犯米黄石不宜动态增加，因为一个文件末尾后的盘块可能已分配给其他文件，一旦需要增加，就需要大量移动盘块。此外，反复增删文件后会产生外部碎片，且很难确定一个文件需要的空间大小，因而只适用于长度固定的文件。  
+ 链接分配  
链接分配采用离散分配的方式，消除了外部碎片，因而显著提高了磁盘空间的利用率；又因为根据文件的当前需求为其分配必需的盘块，当文件动态增长时，可以动态地再为它分配盘块，因此无须事先知道文件的大小。此外，对文件的增、删、改也非常方便。链接分配方式又分为隐式链接和显式链接两种形式。  
  - 隐式链接  
  每个文件对应一个磁盘块的链表；磁盘块分布在磁盘的任何地方，除最后一个盘块外，每个盘块都有指向下一个盘块的指针，这些指针对用户是透明的。目录包括文件第一块的指针和最后一块的指针。  
  创建文件时，目录中增加一个新条目。每个目录项都有一个指向文件首块的指针。该指针初始化为NULL以表示空文件，大小字段为0。写文件会通过空闲空间管理找到空闲块，将该块链接到文件的尾部，以便写入。读文件则通过块到块的指针顺序读块。  
  隐式链接分配的缺点是无法直接访问盘块，只能通过指针顺序访问文件，且盘块指针会消耗一定的存储空间。隐式链接分配的稳定性也是一个问题，系统在运行过程中由于软件或硬件错误导致链表文件的指针丢失或损坏，会导致文件数据的丢失。  
  - 显式链接  
  显式链接是把用于链接文件各物理块的指针，从每个磁盘块的块末尾中提取出来，显式地存放在内存的一张链接表中。该表在整个磁盘仅设置一张，每个表项中存放对应块的下一个链接指针，即下一个盘块号。在该表中，凡是属于某一个文件的第一个盘块号，或每条链的链首指针所对应的盘块号，均作为文件地址被填入相应文件的FCB的“物理地址”字段。当某文件要查找当前块的下一块地址时，只需找到链接表中相应的位置，即可找到下一块的指针。  
  由于查找的过程是在内存中进行的，因而不仅显著地提高了检索速度，而且大大减少了访问磁盘的次数。由于分配给文件的所有盘块号都放在该表中，故称该表为文件分配表。  
+ 索引分配  
索引分配解决了连续分配的外部碎片和文件大小管理的问题。但是，链接分配不能有效支持直接访问（FAT除外）。索引分配解决了这个问题，它把每个文件的所有的盘块号都集中放在一起构成索引块（表）。  
每个文件都有其索引块，这是一个磁盘块地址的数组。索引块的第i个条目指向文件的第i个块。目录条目包括索引块的地址。要读第i块，通过索引块的第i个条目的指针来查找和读入所需的块。  
创建文件时，索引块的指针都设为空。首次写入第i块时，先从空闲空间中取得一个块，再将其地址写到索引块的第i个条目。索引分配支持直接访问，且没有外部碎片问题。其缺点是由于索引块的分配，增加了系统存储空间的开销。索引块的大小是一个重要的问题，每个文件必须有一个索引块，因此索引块应尽可能的小，但索引块太小就无法支持大文件。可以采用以下的机制来解决这个问题。  
  - 链接方案  
  一个索引块通常为一个磁盘块，因此它本身能直接读写。为了处理大文件，可以将多个索引块链接起来。  
  - 多层索引  
  多层索引使第一层索引块指向第二层的索引块，第二层索引块再指向文件块。这种方法根据最大文件大小的要求，可以继续到第三层或第四层。  
  - 混合索引  
  将多种索引分配方式相结合的分配方式。  
  此外，访问文件需要两次访问外存——首先要读取索引块的内容，然后访问具体的磁盘块，因而降低了文件的存取速度。为了解决这一问题，通常将文件的索引块读入内存的缓冲区中，以加快文件的访问速度。  
2. 文件存储空间管理  
+ 文件存储器空间的划分与初始化  
一般来说，一个文件存储在一个文件卷中。文件卷可以是物理盘的一部分，也可以是整个物理盘，支持超大型的文件卷也可由多个物理盘组成。  
在一个文件卷中，文件数据信息的空间（文件区）和存放文件控制信息FCB的空间（目录区）是分离的。由于存在很多种类的文件表示和存放格式，所以现代操作系统中一般有很多不同的文件管理模块，通过它们可以访问不同格式的逻辑卷中的文件。逻辑卷在提供文件服务前，必须由对应的文件程序进行初始化，划分好目录和分区，建立空闲空间管理表格及存放逻辑卷信息的超级块。  
+ 文件存储器空间管理  
文件存储设备分成许多大小相同的物理块，并以块为单位交换信息，因此，文件存储设备的管理实质上是对空闲块的组织和管理，它包括空闲块的组织、分配和回收等问题。  
  - 空闲表法  
  空闲表法属于连续分配方式，它与内存的动态分配方案相似，为每个文件分配一块连续的存储空间。系统为外存上的所有空闲区建立一张空闲盘块表，每个空闲区对应一个空闲表项，其中包括表项序号、该空闲区是第一个盘块号、该区的空闲盘块数等信息。再将所有空闲区按其起始盘块号递增的次序排列。  
  空闲盘块的分配与内存的动态分配相似，同样采用首次适应算法、循环首次适应算法等。  
  系统在对用户所释放的存储空间进行回收时，也采取类似于内存回收的方法，即要考虑回收区是否与空闲表中插入点的前区和后区相邻接，对邻接的予以合并。  
  - 空闲链表法  
  将所有空闲盘块拉成一条空闲链，根据构成链所有的基本元素不同，可把链表分成两种形式：空闲盘块链和空闲盘区链。  
  空闲盘块链将磁盘上的所有空闲分区以盘块为单位拉成一条链。当用户因创建文件而请求分配存储空间时，系统从链首开始，依次摘下适当数目的空闲盘块分配给用户。当用户因删除文件而释放存储空间时，系统将回收的盘块依次插入空闲盘块链的末尾。这种方法的优点是分配和回收一个盘块的过程非常简单，但在为一个文件分配盘块时可能要重复多次操作。  
  空闲盘区链将磁盘上的所有空闲盘区（每个盘区可包含若干盘块）拉成一条链。在每个盘区中除含有用于指示下一个空闲盘区的指针外，还应有能指明盘区大小（盘块数）的信息。分配盘区的方法与内存的动态分区分配类似，通常采用首次适应算法。在回收盘块时，同样也要将回收区与相邻接的空闲盘区合并。  
  - 位示图法  
  位示图利用二进制的一位来表示磁盘中一个盘块的使用情况，磁盘上所有的盘块都有一个二进制位与之对应。当其值为“0”时，标识对应的盘块空闲；当其值为“1”时，表示对应的盘块已分配。  
  盘块的分配过程：①顺序扫描位示图，从中找出满足条件的一个或一组值为“0”的二进制位。②将找到的二进制位转为为与之对应的盘块号。③修改位示图。  
  盘块的回收过程：①将回收盘块的盘块号转换成位示图中的行号和列号。②修改位示图。  
  - 成组链接法  
  空闲表法和空闲链表法都不适用于大型文件系统，因为这会使空闲表或空闲链表太大。在UNIX系统中采用的成组链接法，这种方法结合了空闲表和空闲链表两种方法，克服了表太大的缺点。其大致思想是：把顺序的n个空闲扇区地址保存在第一个空闲扇区内，其后一个空闲扇区内则保存另一个顺序空闲扇区的地址，如此继续，直至所有空闲扇区均予以链接。系统只需保存指向第一个空闲扇区的指针。通过这种方式可以迅速找到大批空闲块地址。  
  表示文件存储器空闲空间的“位向量”表或第一个成组链接块，以及卷中的目录区、文件区划分信息都需要存放在辅存储器中，一般放在卷头位置，在UNIX系统中称为超级块。在对卷中的文件进行操作前，超级块需要预先读入系统空闲的主存，并且经常保持主存超级块与辅存卷中超级块的一致性。  

  ---
  ## 磁盘组织与管理  
  ### 磁盘的结构  
  磁盘是由表面涂有磁性物质的金属或塑料构成的圆形盘片，通过一个称为磁头的导体线圈从磁盘存取数据。在读/写操作期间，磁头固定，磁盘在下面高速旋转。磁盘盘面上数据存储在一组同心圆中，称为磁道。每个磁道与磁头一样宽，一个盘面有上千个磁道。磁道有划分为几百个扇区，每个扇区固定存储大小，一个扇区称为一个盘块。相邻磁道及相邻扇区间通过一定的间隙分隔开，以避免精度错误。注意，由于扇区按固定圆心角度划分，所以密度从最外道向里道增加，磁盘的存储能力受限于最内道的最大记录密度。  
  磁盘安装在一个磁盘驱动器中，它由磁头臂、用于旋转磁盘的主轴和用于数据输入输出的电子设备组成。多个盘片垂直堆叠，组成磁盘组，每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心的距离相同且一起移动。所有盘片上相对位置相同的磁道组成柱面。按照这种物理结构组织，扇区就是磁盘可寻址的最小存储单元，磁盘地址用“柱面号-盘面号-扇区号（或块号）”表示。  
  磁盘按照不同的方式可分为若干类型：磁头相对于盘片径向方向固定的，称为固定头磁盘，每个磁道一个磁头；磁头可移动的，称为活动头磁盘，磁头臂可来回伸缩定位磁道；磁盘永久固定在磁盘驱动器内的，称为固定盘磁头；可移动和替换的，称为可换盘磁头。  
### 磁盘调度算法  
一次磁盘读写操作的时间由寻找（寻道）时间、延迟时间和传输时间决定。  
+ 寻找时间Ts  
活动头磁盘在读写信息之前，将磁头移动到指定磁道所需要的时间。这个时间除跨越n条磁道的时间外，还包括启动磁臂的时间s，即  
**Ts = m × n + s**  
式中，m是与磁盘驱动器速度有关的常数，约为0.2ms，磁臂的启动时间约为2ms。  
+ 延迟时间Tr  
磁头定位到某一磁道的扇区（块号）所需要的时间，设磁盘的旋转速度为r，则  
**Tr = (1/2) * (1/r) = 1/2r**  
+ 传输时间Tt  
从磁盘读出或向磁盘写入数据所经历的时间，这个时间取决于每次所读写的字节数b和磁盘的旋转速度  
**Tt = (b/N) × (1/r) = b/rN**  
式中，r为磁盘每秒的转数，N为一个磁道上的字节数。  
常用的磁盘调度算法：
1. 先来先服务算法First Come First Served  
根据进程请求访问磁盘的先后顺序进行调度。该算法具有公平性。若只有少量进程需要访问，且大部分请求都是访问簇聚的文件扇区，则有望达到较好的性能；若有大量进程竞争使用磁盘，则这种算法在性能上往往接近于随机调度。所以，实际磁盘调度中会考虑更为复杂的调度算法。  
2. 最短寻找时间优先算法Shortest Seek Time First  
SSTF算法选择调度处理的磁道是与当前磁头所在磁道距离最近的磁道，以便每次的寻找时间最短。当然，总是选择最短寻找时间并不能保证平均寻找时间最小，但能提供比FCFS更好的性能。这种算法会导致“饥饿”现象。  
3. 扫描SCAN算法（电梯调度算法）  
SCAN算法在磁头当前移动方向上选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象，实际上就是在最短寻找时间优先的算法的基础上规定了磁头运动的方向，由于磁头移动规律与电梯运行相似，故又称电梯调度算法。**SCAN算法对最近扫描过的区域不公平，因此它在访问局部性方面不如FCFS算法和SSTF算法好。**  
4. 循环扫描(Circular Scan, C-SCAN)算法  
在扫描算法的基础上规定磁头单向来回提供服务，回返时直接快速移动至始端而不服务任何请求。由于SCAN算法偏向于处理那些接近最里层或最外层的磁道访问请求，所以改进型的C-SCAN算法来避免这个问题。  
采用SCAN和C-SCAN算法时，磁头总是严格地遵循从盘面的一端到另一端，显然，在实际使用时还可以改进，即磁头移动只需要到达最远端的一个请求即可返回，不许哭到达磁盘端点。这种形式的SCAN算法和C-SCAN算法称为LOOK调度和C-LOOK调度，因为它们在朝一个方向移动前会查看是否有请求。  
### 磁盘的管理  
1. 磁盘初始化  
一个新的磁盘只是一个含有磁性记录材料的空白盘。在磁盘能存储数据之前，它必须分成扇区以便磁盘控制器能进行读写操作，这个过程称为低级格式化（物理分区）。低级格式化为磁盘的每个扇区采用特别的数据结构。每个扇区的数据结构通常由头、数据区域和尾部组成。头部和尾部包含了一些磁盘控制器所使用的信息。  
为了使用磁盘存储文件，操作系统还需要将自己的数据结构记录在磁盘上：第一步将磁盘分为由一个或多个柱面组成的分区；第二步对物理分区进行逻辑格式化（创建文件系统），操作系统将初始的文件系统数据存储到磁盘上，这些数据结构包括空闲和已分配的空间及一个初始为空的目录。  
2. 引导块  
计算机启动时需要运行一个应用程序（自举程序），它初始化CPU、寄存器、设备管理器和内存等，接着启动操作系统。为此，该自举程序应找到磁盘上的操作系统内核，装入内存，并转到起始地址，从而开始操作系统的运行。  
自举程序通常保存在ROM中，为了避免改变自举代码而需要改变ROM硬件的问题，故只在ROM中保留很小的自举装入程序，将完整功能的自居程序保存在硬盘的启动块上，启动块位于磁盘的固定位。拥有启动分区的磁盘称为启动磁盘或系统磁盘。  
3. 坏块  
由于磁盘有移动部件且容错能力弱，因此容易导致一个或多个扇区顺损坏。部分磁盘甚至从出厂时就有坏扇区。根据所使用的磁盘和控制器，对这些块有多种处理方式。  
对于简单磁盘，如电子集成驱动器（IDE），坏扇区可手工处理，如MS-DOS的Format命令执行逻辑格式化时便会扫描硬盘以检查坏扇区。坏扇区在FAT表上会标明，因此程序不会使用。  
对于复杂的磁盘，如小型计算机系统接口SCSI，其控制器维护一个磁盘损坏块链表。该链表在出厂前进行低级格式化时就已初始化，并在磁盘的整个使用过程中不断更新。低级格式化将一些块保留作为备用，对操作系统透明。控制器可用备用块来逻辑地替代坏块，这种方案称为扇区备用。  
对坏块的处理实质上就是用某种机制，使系统不去使用坏块。坏块属于硬件故障，操作系统是不能修复坏块的。  