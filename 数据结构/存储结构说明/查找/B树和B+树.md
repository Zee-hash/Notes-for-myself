## B树和B+树  
### B树及其基本操作  
B树，又称多路平衡二叉树，B树中的所有结点的孩子个数的最大值称为B树的阶，通常用m表示。一棵m阶B树或为空树，或为满足如下特性的m叉树：  
+ 树中每个结点至多有m棵子树，即至多含有m-1个关键字。  
+ 若根结点不是终端结点，则至少有两棵子树。  
+ 除根结点外的所有非叶结点至少有⎡m/2⎤棵子树，即至少含有⎡m/2⎤ - 1个关键字。  
+ 所有非叶结点的结构如下：  

|n|P<sub>0</sub>|K<sub>1</sub>|P<sub>1</sub>|K<sub>2</sub>|P<sub>2</sub>|···|K<sub>n</sub>|P<sub>n</sub>|  
|---|---|---|---|---|---|---|---|---|  

其中，K<sub>i</sub>(i = 1,2,···,n)为结点的关键字，且满足K<sub>1</sub> < K<sub>2</sub> < ··· < K<sub>n</sub>；P<sub>i</sub>(i = 0,1,···,n)为指向子树根结点的指针，且指针P<sub>i-1</sub>所指子树中所有结点的关键字均小于K<sub>i</sub>，P<sub>i</sub>所指子树中所有结点的关键字均大于K<sub>i</sub>，n(⎡m/2⎤ - 1 ≤ n ≤ m -1)为结点中关键字的个数。  
+ 所有的叶结点都出现在同一层次上，并且不带信息。  

B树是所有结点的平衡因子均等于0的多路平衡查找树。  
#### B树的高度  
B树的大部分操作所需的磁盘存取次数与B树的高度称正比。  
下面分析B树在不同情况下的高度。  
若n≥1，则对任意一棵包含n个关键字、高度为h、阶数为m的B树：  
+ 因为B树中每个结点最多有m棵子树，m-1个关键字，所以在一棵高度为h的m阶B树中关键字的个数应满足n≤(m-1)(1+m+m<sup>2</sup>+···+m<sup>h-1</sup>) = m<sup>h</sup>-1，因此有h≥log<sub>m</sub>(n+1)。  
+ 若让每个结点中的关键字个数达到最少，则容纳同样多关键字的B树的高度达到最大。由B树的定义：第一层至少有1个结点；第二层至少有2个结点；除根结点外的每个非终端结点至少有⎡m/2⎤棵子树，则第三层至少有2⎡m/2⎤个结点······第h+1层至少有2(⎡m/2⎤)<sup>h-1</sup>个结点，注意到第h+1层是不包含任何信息的叶结点。对于关键字个数为n的B树，叶结点即查找不成功的结点为n+1，由此由n+1≥2(⎡m/2⎤)<sup>h-1</sup>，即为h≤log<sub>⎡m/2⎤</sub>((n+1)/2)+1。  

#### B树的查找  
在B树上进行查找与二叉查找树很相似，只是每个结点都是多个关键字的有序表，在每个结点上所做的不是两路分支决定，而是根据该结点的子树所做的多路分支决定。  
B树的查找包含两个基本操作：  
+ 在B树中找结点  
+ 在结点内找关键字  

由于B树常存储在磁盘上，因此前一个查找操作是在磁盘上进行的，而后一个查找操作是在内存中进行的，即在找到目标结点后，先将结点信息存入内存，然后在结点内采用顺序查找法或折半查找法。  
在B树上查找到某个结点后，先在有序表中进行查找，若找到则查找成功，否则按照对应的指针信息到所指的子树去查找。查找到叶结点时（对应指针为空），则说明树中没有对应的关键字，查找失败。  

#### B树的插入  
与二叉查找树的插入操作相比，B树的插入操作要复杂得多。在二叉查找树中，仅需查找到需插入的终端结点的位置。但是，在B树中找到插入的位置后，并不能简单地将其添加到终端结点中，因此此时可能会导致整棵树不再满足B树定义中要求。将关键字key插入B树的过程如下：  
+ 定位。利用前述的B树查找算法，找出插入该关键字的最低层中的某个非叶结点（在B树中查找Key时，会找到表示查找失败的叶结点，这样就确定了最底层非叶结点的插入位置。**插入位置一定是最低层中某个非叶结点**）  
+ 插入。在B树中，每个非失败结点的关键字个数都在区间[⎡m/2⎤-1, m-1]内、插入后节目关键字的个数小于m，可以直接插入；插入后检查被插入结点内关键字的个数，当插入后结点关键字个数大于m-1时。必须对结点进行分裂。  

分裂的方法是：取一个新结点，将插入key后的原结点从中间位置（⎡m/2⎤）将其中的关键字分为两部分，左部分包含的关键字放在原结点中，右部分包含的关键字放到新结点中，中间位置（⎡m/2⎤）的结点插入原结点的父结点。若此时导致其父结点的关键字个数也超过了上限，则继续进行这种分裂操作，直至这个过程传到根结点位置，进而导致B树高度增1。  

#### B树的删除  
B树的删除操作与插入操作类似，但要稍微复杂一些，即要使得删除后的结点中关键字个数≥⎡m/2⎤-1，因此将涉及结点的“合并”问题。  
当被删关键字k不在终端结点（最低层非叶结点）中时，可以用k的前驱（或后继）k<sup>'</sup>来替代k，然后在相应的结点中删除k<sup>'</sup>，关键字k<sup>'</sup>必定落在某个终端结点中，则转换成了被删除关键字在终端结点中的情形。  
当被删关键字在终端结点（最低层非叶结点）中时，有3种情况：  
+ 直接删除关键字。若被删除关键字所在结点的关键字个数≥⎡m/2⎤，表明删除该关键字后仍满足B树的定义，则直接删去该关键字。  
+ 兄弟够借。若被删除关键字所在结点删除前的关键字个数=⎡m/2⎤-1，且与此结点相邻的右（或左）兄弟结点的关键字个数≥⎡m/2⎤，则需要调整该结点、右（或左）兄弟结点及其双亲结点（父子换位法），以达到新的平衡。  
+ 兄弟不够借。若被删除关键字所在结点删除前的关键字个数=⎡m/2⎤-1，且此时与该结点相邻的左、右兄弟结点的关键字个数均=⎡m/2⎤-1，则将关键字删除后与左（或右）兄弟结点及双亲结点中的关键字进行合并。  
在合并过程中，双亲结点中的关键字个数会减1。若其双亲结点是根结点且关键字个数减少至0（根结点关键字个数为1时，有两棵子树），则直接将根结点删除，合并后的新结点成为根；若双亲结点不是根结点，且关键字个数减少到⎡m/2⎤-2.则又要与它自己的兄弟结点进行调整或合并操作，并重复上述步骤，直至符合B树的要求为止。  

### B+树的基本概念  
B+树是应数据库所需而出现的一种B树的变形树。  
一棵m阶的B+树需满足下列条件：  
+ 每个分支结点最多有m棵子树（孩子结点）  
+ 非叶根结点至少有两棵子树，其他每个分支结点至少有⎡m/2⎤棵子树  
+ 结点的子树个数与关键字个数相等  
+ 所有叶结点包含全部关键字及指向相应记录的指针，叶结点将关键字按大小顺序排列，并且相邻叶结点按大小顺序相互链接起来。  
+ 所有分支结点（可视为索引的索引）中仅包含它的各个子结点（即下一级的索引块）中关键字的最大值及指向其子结点的指针。  

m阶的B+树和m阶的B树的主要差异如下：  
+ 在B+树中，具有n个关键字的结点只含有n棵子树，即每个关键字对于一棵子树；而在B树中，具有n个关键字的结点含有n+1棵子树  
+ 在B+树中，每个结点（非根内部结点）的关键字个数n的范围是⎡m/2⎤≤n≤m(根结点：1≤n≤m)；在B树中，每个结点（非根内部结点）的关键字个数n的范围是⎡m/2⎤-1≤n≤m-1(根结点：1≤n≤m-1)  
+ 在B+树中，叶结点包含信息，所有非叶结点仅起索引作用，非叶结点中的每个索引项只含有对应子树的最大关键字和指向该子树的指针，不含有该关键字对应记录的存储地址  
+ 在B+树中，叶结点包含了全部关键字，即在非叶结点中出现的关键字也会出现在叶结点中；而在B树中，叶结点包含的关键字和其他节点包含的关键字是不重复的。  

通常在B+树中有两个头指针：一个指向根结点，另一个指向关键字最小的叶结点。因此，可以对B+树进行两种查找运算：一种是从最小关键字开始的顺序查找，另一种是从根结点开始的多路查找。  
B+树的查找、插入和删除操作和B树的基本类似。只是在查找过程中，非叶结点上的关键字值等于给定值时并不终止，而是继续向下查找，直到叶结点上的该关键字位置。所以，在B+树中查找时，无论查找成功与否，每次查找都是一条从根结点到叶结点的路径。  