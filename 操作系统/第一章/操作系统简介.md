# 计算机系统概述
---
## 什么是操作系统？
- 操作系统是指控制和管理整个计算机系统的硬件和软件资源，合理地组织、调度计算机的工作与资源的分配，进而为用户和其他软件提供方便接口与环境的程序合集。它是计算机系统中最基本的系统软件。  
## 操作系统的特征
1. 并发Concurrence  
并发是指在一个时间间隔内，有两个或多个事情发生。对于单处理机来说，在一段时间内，宏观上来看有许多程序在同时运行，但从微观上来看，在这一段时间内的任意一个时刻都只有一个程序在执行。它们通过分时来实现并发。
2. 共享Sharing  
资源共享，是指计算机中的资源可供内存中多个并发执行的程序使用。共享分为以下两种方式：  
  + 互斥共享方式  
  在一段时间内只允许一个进程访问的资源称为临界资源或独占资源，进程在对这类资源进行访问时，需要互斥访问。打印机、磁带机等设备，如果不互斥共享将产生不可预估的后果。
  + 同时访问方式  
  这类资源允许一段时间内有多个进程“同时”访问,可允许多个进程同时访问的典型设备是磁盘设备。  
- **并发**和**共享**是操作系统两个最基本的特征。两者之间互为条件：  
  + 资源共享以并发为条件，若系统不允许程序并发执行，那么也不用考虑资源共享问题。  
  + 若系统不能对资源共享实施有效管理，则必将影响程序的并发执行，甚至无法并发执行。  
3. 虚拟Virtual  
虚拟是指把一个物理上的实体变成若干个逻辑上的对应物。用于实现虚拟的技术，被称为虚拟技术。操作系统中利用了多种虚拟技术来实现虚拟处理器、虚拟内存和虚拟外部设备等。  
操作系统的虚拟技术可归纳为：时分复用技术（如虚拟处理器）、空分复用技术（如虚拟存储器）。  
4. 异步Asynchronism  
多道程序环境允许多个程序并发执行，但由于资源有限，进程的执行并不是一贯到底的，而是走走停停的，它以不可预知的速度向前推进，这就是进程的异步性。  
异步性使得操作系统运行处在一种随机的环境下，可能导致进程产生与时间有关的错误。然而，只要运行环境相同，操作系统就须保证多次运行进程后能获得相同的结果。  
## 操作系统的目标和功能
1. 操作系统作为计算机系统的资源管理者
+ 处理机管理  
在多道程序环境下，处理机的分配和运行都以进程（或线程）为基本单位，因而对处理机的管理可归结为对进程的管理。并发是指在计算机内同时运行多个进程，因此进程何时创建、何时撤销、如何管理、如何避免冲突、合理共享就是进程管理最主要的任务。**进程管理最主要的功能包括进程控制、进程同步、进程通信、死锁处理、处理机调度等**。  
+ 存储器管理  
存储器管理是为了给多道程序的运行提供良好的环境，方便用户使用及提供内存的利用率，主要包括**内存分配、地址映射、内存保护与共享和内存扩充等功能**。  
+ 文件管理  
计算机中的信息都是以文件的形式存在的，操作系统中负责文件管理的部分称为*文件系统*。文件管理包括**文件存储空间的管理、目录管理及文件读写管理和保护等**。  
+ 设备管理  
设备管理的主要任务是完成用户的I/O请求，方便用户使用各种设备，并提高设备的利用率，主要包括**缓冲管理、设备分配、设备处理和虚拟设备等**。  
2. 操作系统作为用户与计算机硬件系统之间的接口  
操作系统提供的接口主要分为两类。一类是命令接口，用户利用这些操作命令来组织和控制作业的执行；另一类是程序接口，编程人员可以使用它们来请求操作系统服务。  
+ 命令接口  
  - 联机命令接口（交互式命令接口）：适用于实时或分时系统的接口。用户每输入一条命令，就将控制权转给操作系统的命令解释程序，然后命令解释程序解释并执行输入的命令，完成指定的功能。之后，控制权转回控制台或终端，此时用户又可输入下一条命令。
  - 脱机命令接口（批处理命令接口）：适用于批处理操作系统，它由一组作业控制命令（作业控制语句）组成。脱机用户不能直接干预作业的运行，而应事先用相应的作业控制命令写成一份作业操作说明书，连同作业一起提交给系统。系统调度该作业时，由系统的命令解释程序逐条解释执行作业说明书上的命令或作业控制语句，从而间接地控制作业的运行。  
+ 程序接口  
程序接口由一组系统调用命令（简称系统调用，也称**广义指令**）组成。用户通过在程序中使用这些命令调用命令来请求操作系统为其提供服务。用户在程序中可以直接使用这组系统调用命令向系统提出各种服务要求，如使用各种外部设备、进行有关磁盘文件的操作、申请分配和收回内存及其他各种控制要求。  
3. 操作系统用作扩充机器  
没有任何软件支持的计算机称作*裸机*，它仅构成计算机系统的物质基础，而实际呈现在用户面前的计算机系统是经过若干层软件改造的计算机。裸机在最里层，其外面是操作系统。操作系统所提供的资源管理功能和方便用户的各种服务功能，将裸机改造成功能更强、使用更方便的机器。通常将覆盖了软件的机器称为*扩充机器*或*虚拟机*。

---
## 操作系统的发展与分类
### 手工操作阶段（无操作系统）
### 批处理阶段（操作系统开始出现）  
为了解决人机矛盾及CPU和I/O设备之前速度不匹配的矛盾，出现了批处理系统。　　
### 单道批处理系统  
  系统对作业的处理是成批进行的，但内存中始终保持一道作业。单道处理系统是在**解决人机矛盾及CPU和I/O设备速率不匹配的矛盾**中形成的。单道批处理系统的主要特征：  
    + 自动性：顺利的情况下，磁带上的一批作业能自动地逐个运行，而无须人工干预。  
    + 顺序性：磁带上的作业顺序地进入内存，各道作业的完成顺序与它们进入内存的顺序在正常情况下应完全相同。即先调入内存的作业先完成。
    + 单道性：内存中仅有一道程序运行，即监督程序每次从磁带上只调入一道程序进入内存运行，当该程序完成或发生异常情况时，才换入其后继程序进入内存运行。  
  **问题：每次主机内仅存放一道作业，每当它在*运行期间*发出输入/输出请求后，高速的CPU便处于等待低速的I/O完成状态。为了进一步提高资源利用率和系统的吞吐量，引入了多道程序技术**。  
### 多道批处理系统  
  多道程序设计技术允许多个程序同时进入内存并允许它们在CPU中交替的运行，这些程序共享系统中的各种软硬件资源。当一道程序因I/O请求而暂停运行时，CPU便立即转去执行另一道程序。多道程序设计的特点是多道、宏观上并行、微观上串行。  
    + 多道：计算机内存中同时存放多道相互独立的程序
    + 宏观上并行：同时进入系统的多道程序都处于运行当中，及他们先后开始各自的运行，但都未运行完毕。
    + 微观上串行：内存中的程序轮流占有CPU，交替执行。  
  多道程序设计技术的实现需要解决下列问题：  
    + 如何分配处理器
    + 多道程序的内存分配问题
    + I/O设备如何分配
    + 如何组织和存放大量的程序和数据，以方便用户使用并保证其安全性与一致性。  
    **在批处理系统中采用多道程序设计技术就形成了多道批处理操作系统，该系统把用户提交的作业成批地送入计算机内存，然后由作业调度程序自动选择作业运行。**  
  - 多道批处理操作系统的优缺点：
    + 优点：资源利用率高，多道程序共享计算机资源，从而使各种资源得到充分利用；系统吞吐量大；CPU和其他资源保持“忙碌”状态。
    + 缺点：用户响应的时间较长；不提供人机交互能力，用户既不了解自己的程序的运行情况，也不能控制计算机。  
### 分时操作系统  
在操作系统中**采用分时技术**就形成了分时操作系统。所谓分时技术，是指把处理器的运行时间分成很小的时间片，将时间片轮流把处理器分配给各联机作业使用。若某个作业在分配给它的时间片内不能完成计算，则改作业暂时停止运行，把处理器给其它作业使用，等待下一轮再继续运行。由于处理器速度很快，作业运行轮转得也很快，因此给每个用户的感觉就像是自己独占一台计算机。  
分时操作系统是指**多个用户**通过终端同时共享一台主机，这些终端连接在主机上，用户可以同时与主机进行交互操作而互不干扰。因此，实现分时系统最关键的问题**如何使用户自己能与自己的作业进行交互**，即当用户在自己的终端上输入命令时，系统应能及时接收并及时处理该命令，再将结果返回给用户。**分时系统也是支持多道程序设计技术**的系统，但它不同于多道批处理操作系统，多道批处理是实现作业自动控制而无需人工干预的系统，而**分时系统是实现人机交互的系统**，这使得分时系统具有与批处理系统不同的特征。分时系统的主要特征如下：  
  + 同时性：同时性也称多路性，指允许多个终端用户同时使用一台计算机，即一台计算机与若干台终端相连，终端上的用户可以同时使用计算机。
  + 交互性：用户能够方便地与系统进行人机对话，即用户通过终端采用人机对话的方式直接控制程序运行，与程序进行交互。
  + 独立性：系统中多个用户可以彼此独立地进行操作，互不干扰，单个用户感觉不到别人也在使用这台计算机，好像只有自己单独使用这台计算机一样。
  + 及时性：用户请求能在很短时间内获得响应。分时操作系统**采用时间片轮转方式**使一台计算机同时为多个终端服务，使用户能够对系统的及时响应感到满意。  
  虽然分时操作系统较好地解决了人机交互的问题，但在一些应用场合，需要系统**能够对外部的信息在规定的时间（小于时间片）内作出处理**，因此，实时系统应运而生。
### 实时操作系统  
为了能在某个时间限制内完成某些紧急任务而不需要时间片排队，诞生了实时操作系统。这里的时间限制可以分为两种情况：若某个动作必须绝对地在规定的时刻（或规定的时间范围）发生，则称为**硬实时系统**,如飞行器的飞行自动控制系统，这类系统必须绝对保证让某个特定的动作在规定的时间内完成。若能够接受偶尔违反时间规定且不会引起任何永久性的损害，则称为**软实时系统**,如飞机订票系统、银行管理系统。  
在实时操作系统的控制下，计算机能够在接收到外部信号后及时进行处理，并在严格的时限内处理完作业。**实时操作系统的主要特点是及时性和可靠性**.  
### 网络操作系统和分布式计算机系统  
网络操作系统把计算机网络中的各台计算机有机地结合起来，提供一种统一的、经济而有效的使用各台计算机的方法，实现各台计算机之间数据的互相传送。网络操作系统最主要的特点是网络中各种资源的共享即各台计算机之间的通信。  
分布式计算机系统是由多台计算机组成并满足以下条件的系统  
  - 系统中的任意两台计算机通过某种通信方式交换信息
  - 系统中的每台计算机具有相同的地位，即没有主机也没有从机
  - 每台计算机上的资源为所有用户所共享
  - 系统中的任意台计算机都可以构成一个子系统，并且还能重构
  - 任何工作都可以分布在几台计算机上，由它们并行工作、协同完成  
  用于管理分布式计算机系统的操作系统称为分布式计算机系统。该系统的主要特点是**分布性和并行性**。**分布式操作系统与网络操作系统的本质不同是，分布式操作系统中的若干计算机相互协同完成同一任务**。
---
## 操作系统的运行环境
### 操作系统的运行机制  
计算机系统中，通常CPU执行两种不同性质的程序：一种是操作系统内核程序，另一种是用户自编程序（应用程序）。在具体实现上，将CPU的状态分成**用户态（目态）和核心态（管态、内核态）**。应用程序运行在用户态，内核程序运行在核心态。  
操作系统的各项功能分别被设置在不同的层次上，一些与硬件关联较紧密的模块，如时钟管理、中断处理、设备驱动等处于最低层。其次是运行频率较高的程序，如进程管理、存储器管理和设备管理等。这两部分构成了操作系统的内核，其指令工作在核心态。  
内核是计算机上配置的底层软件，是计算机功能的延伸。不同的操作系统对内核的定义稍有区别，大多数操作系统的内核包括四个方面的内容：  
+ 时钟管理  
在计算机的各种部件中，时钟是最关键的设备。时钟的第一功能是计时，操作系统需要通过时钟管理，向用户提供标准的系统时间。另外，通过时钟中断的管理，可以实现进程的切换。例如，在分时操作系统中采用时间片轮转调度，在实时系统中按截止时间控制运行，在批处理系统中通过时钟管理来衡量一个作业的运行程序等。
+ 中断机制  
**引入中断机制的初衷是提高多道程序运行环境中的CPU利用率**，而且主要是针对外部设备的。后来逐步得到发展，形成了多种类型，成为操作系统各项操作的基础。例如，键盘或鼠标信息的输入、进程的管理和调度、系统功能的调用、设备驱动、文件访问等，无不依赖于中断机制。**可以说，现代操作系统是靠中断驱动的软件**。  
中断机制中，只有一小部分的功能属于内核，它们负责保护和恢复中断现场的信息，转移控制权到相关的处理程序。这样可以减少中断的处理时间，提高系统的并行处理能力。
+ 原语  
按层次结构设计的操作系统，底层必然是一些可被调用的公用小程序，它们各自完成一个规定的操作。它们的特点如下：  
  - 处于操作系统的最低层，是最接近硬件的部分
  - 这些程序的运行具有原子性，其操作只能一气呵成
  - 这些程序的运行时间都比较短，而且调用频繁  
  通常把具有这些特点的程序叫做原语(Atomic Operation)。**定义原语的直接方法是关闭中断，让其所有的动作不可分割地完成后再打开中断**。  
  系统中的设备驱动、CPU切换、进程通信等功能中的部分操作都可定义成原语，使它们成为内核的组成部分。
+ 系统控制的数据结构及处理  
系统中用来登记状态信息的数据结构很多，如作业控制块、进程控制块、设备控制块、各类链表、消息队列、缓冲区、空闲区登记表、内存分配表等。为了实现有效的管理，系统需要一些基本的操作，常见的操作有以下三种：
  - 进程管理：进程状态管理、进程调度和分配、创建和撤销进程控制块等。
  - 存储器管理：存储器的空间分配和回收、内存信息保护程序、代码对换程序等。
  - 设备管理：缓冲区管理、设备分配和回收等。
### 中断和异常的概念
**CPU运行上层程序时唯一能从用户态进入核心态的途径就是通过中断或异常**。发生中断或异常时，运行用户态的CPU会**立即**进入核心态，这是通过硬件实现的。  
操作系统的发展过程大体上就是一个想法设法不断提高资源利用率的过程，而提高资源利用率就需要在程序并未使用某种资源时，把它对这种资源的占有权释放，而这种行为就需要中断实现。  
**中断Interruption**也称外中断，指来自CPU执行指令以外的事件的发生，如设备发出的I/O结束中断，表示设备输入/输出已经完成，希望处理机能够向设备发下一个输入/输出请求，同时让完成输入/输出后的程序能够继续运行。时钟中断，表示一个固定的时间片已到，让处理机处理计时、启动定时运行的任务等。这一类中断通常是与当前程序运行无关的事件，即它们与当前处理机运行的程序无关。  
**异常Exception**也称内中断、例外或陷入，指源自CPU执行指令内部的事件，如程序的非法操作码、地址越界、算术溢出、虚存系统的缺页及专门的陷入指令等引起的事件。对异常的处理一般要依赖于当前程序的运行现场，而且**异常不能被屏蔽，一旦出现立即处理**。
### 系统调用  
所谓系统调用，是指用户在程序中调用操作系统所提供的一些子功能。在用户程序中，凡是与资源有关的操作（如存储分配、进行I/O传输及管理文件等），都必须通过系统调用的方式向操作系统提出服务请求，并由操作系统代为完成。这些系统调用按功能大致可分为如下几类：
+ 设备管理：完成设备的请求和释放，以及设备启动等功能
+ 文件管理：完成文件的读、写、创建删除等功能
+ 进程控制：完成进程的创建、撤销、阻塞及唤醒等功能
+ 进程通信：完成进程之间的消息传递和信号传递等功能
+ 内存管理：完成内存的分配、回收以及获取作业占用内存区大小及始址等功能  
因为系统调用相关的功能对系统的影响很大，因此必定要使用某些特权指令才能完成，所以系统调用的处理需要由操作系统内核程序负责完成。**用户可以执行陷入指令（访管指令、trap指令）来发起系统调用，请求操作系统提供服务**。这么设计的目的是：用户程序不能直接执行对系统影响非常大的操作，必须通过系统调用的方式让系统代为完成，从而保证系统的稳定性和安全线，防止用户程序随意更改或访问重要的系统资源去影响其他程序的运行。
---
## 操作系统的体系结构
### 大内核和微内核  
大内核系统将操作系统的主要功能模块都作为一个紧密联系的整体运行在核心态，从而为应用提供高性能的系统服务。因为各模块之间共享信息，能够有效利用相互之间的有效特性，所以具有无可比拟的性能优势。  
随着体系结构和应用需求的不断发展，需要操作系统提供的服务越来越多，而且接口的形式越来越复杂，操作系统的设计规模急剧增长，操作系统也面临“软件危机”困境。为此，操作系统设计人员视图按照复杂性、时间常数、抽象级别等因素，将操作系统内核分成基本进程管理、虚存、I/O与设备管理、IPC、文件系统等几个层次，继而定义层次之间的服务结构，提高操作系统内核设计上的模块化。但是，由于层次之间的关系错综复杂，定义清晰的层次接口非常困难，复杂的交互关系也使得层次之间的界限极其模糊。  
为解决操作系统的内核代码难以维护的问题，提出了微内核的体系结构。  
**微内核将内核中最基本的功能保留在内核，而将那些不需要在核心态运行的功能移到用户态执行，从而降低了内核的设计复杂性。而那些移出内核的操作系统的代码根据分层的原则被划分成若干服务程序，它们的执行相互独立，交互则都借助于微内核进行通信。**  
微内核结构有效地分离了内核与服务、服务与服务，使得它们之间的接口更加清晰，维护的代价大大降低，各部分可以独立地优化和演进，从而保证了操作系统的可靠性。
