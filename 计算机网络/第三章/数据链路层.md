# 数据链路层  
---  
## 数据链路层的功能  
数据链路层在物理层提供服务的基础上向网络层提供服务，其主要作用是加强物理层传输原始比特流的功能，将物理层提供的可能出错的物理连接改为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。  
下面具体介绍数据链路层的功能。  
### 为网络层提供服务  
对网络层而言，数据链路层的基本任务是将源机器中来自网络层的数据传输到目标机器的网络层中。数据链路层为网络层提供如下服务：  
+ 无确认的无连接服务。源机器发送数据帧时不需要先建立链路连接，目的机器收到数据帧时不需发回确认。对丢失的帧，数据链路层不负责重发而交给上层处理。适用于实时通信或误码率较低的通信信道，如以太网。  
+ 有确认的无连接服务。源机器发送数据帧时不需要先建立链路连接，但目的机器收到数据帧时必须发回确认。源机器在所规定的时间内未收到确认信号时，就重传丢失的帧，以提高传输的可靠性。该服务适用于误码率较高的通信信道，如无线通信。  
+ 有确认的面向连接服务。帧传输过程分为三个阶段：建立数据链路、传输帧、释放数据链路。目的机器对收到的每一帧都要给出确认，源机器收到确认后才能发送下一条帧，因而该服务的可靠性最高。该服务适用于通信要求（可靠性、实时性）较高的场合。  

### 链路管理  
数据链路层连接的建立、维持和释放过程称为链路管理，它主要用于面向连接的服务。链路两端的结点要进行通信，必须首先确认对方处于就绪状态，并交换一些必要的信息对帧序号初始化，然后才能建立连接，在传输的过程中则要能维持连接，而在传输完毕后要释放该连接。在多个站点共享同一物理信道的情况下（例如在局域网中）如何在要求的站点间分配和管理信道也属于数据链路层管理的范畴。  

### 帧定界、帧同步与透明传输  
两个工作站之间传输信息时，必须将网络层的分组封装成帧，以帧的格式进行传送。将一段数据的前后添加首部和尾部，就构成了帧。首部和尾部中含有很多控制信息，它们的一个重要作用就是确定帧的界限，即帧定界。而帧同步指的是接收方应能从接收到的二进制比特流中区分出帧的起始和终止。如在HDLC通信规程中，用标识位F(01111110)来标识帧的开始和结束。通信过程中，检测到帧标识F即为帧的开始，然后一旦检测到帧标识位F即表示帧的结束。HDLC标准帧格式如下：  
| 标志 | 地址 | 控制 | 信息 | 帧校验序列 | 标志 |  
| --- | --- | --- | --- | --- | --- | --- |  
| F(01111110) | A 8位 | C 8位 | I N位 | FCS 16位 | F(01111110) |  

如果在数据中恰好出现与帧定界符相同的比特组合（会被误认“传输结束”而丢弃后面的数据），那么就要采用有效的措施解决这个问题，即透明传输。更确切地说，透明传输就是不管所传数据是什么样的比特组合，都应当能在链路上传送。  

### 流量控制  
由于收发双方各自的工作速率和缓存空间的差异，可能出现发送方的发送能力大于接收方的接受能力的现象，如若此时不适当限制发送方的发送速率（即链路上信息流量），前面来不及接收的帧将会被后面不断发送来的帧“淹没”，造成帧的丢失而出错。因此，流量控制实际上就是限制发送方的数据流量，使其发送速率不超过接收方的接收能力。  
这个过程需要通过某种反馈机制使发送方知道接收方能否跟得上自己，即需要有一些规则使得发送方知道在什么情况下可以接着发送下一帧，而在什么情况下必须暂停发送，以等待收到某种反馈信号后继续发送。  
流量控制并不是数据链路层特有的功能，许多高层协议中也提供此功能，只不过控制的对象不同而已。对于数据链路层来说，控制的是相邻两结点之间的数据链路上的流量，而对于运输层来说，控制的则是从源端到目的端之间的流量。  

### 差错控制  
由于信道噪声等各种原因，帧在传输过程中可能会出现错误。用以**使发送方确定接收方是否正确收到由其发送的数据的方法称为差错控制**。通常，这些错误可分为位错和帧错。  
位错指帧中某些位出现了差错。通常采用循环冗余校验（CRC）方式发现位错，通过自动重传请求（Automatic Repeat reQuest,ARQ）方式来重传出错的帧。具体做法是：让发送方将要发送的数据帧附加一定的CRC冗余校验码一并发送，接收方则根据检错码对数据帧进行错误检测，若发现错误则丢弃，发送方超时重传该数据帧。这种差错控制方法称为ARQ法。ARQ法只需返回很少的控制信息就可有效地确认所发数据帧是否被正确接收。  
帧错误指帧的丢失、重复或失序等错误。在数据链路层引入定时器和编码机制，以保证每一帧最终都能有且仅有一次正确地交付给目的结点。  

---  
## 组帧  
数据链路层之所以要把比特组合成帧为单位传输，是为了在出错时只重发出错的帧，而不必重发全部数据，从而提高效率。为了使接收方能正确地接收并检查所传输的帧，发送方必须依据一定的规则把网络层递交的分组封装成帧（称为组帧）。组帧主要解决帧定界、帧同步、透明传输等问题。通常有以下4种方法实现组帧。  
### 字符计数法  
字符计数法是指在帧头部使用一个计数字段来标明帧内字符数。目的结点的数据链路层收到字节计数值时，就知道后面跟随的字节数，从而可以确定帧结束的位置（计数字段提供的字节数包含自身所占用的一个字节）。  
这种方法最大的问题在于如果计数字段出错，即失去了帧边界划分的依据，那么接收方就无法判断所传输帧的结束位和下一帧的开始位，收发双方将失去同步，从而造成灾难性的后果。  
### 字符填充的首尾定界符法  
字符填充法使用一些特殊的字符来定界一帧的开始DLE STX与结束DLE ETX。为了使信息位中出现的特殊字符不被误判为帧的首尾定界符，可以在特殊字符前面填充一个转义字符DLE来加以区分，以实现数据的透明传输。接收方收到转义字符后，就知道其后面紧跟的是数据信息，而不是控制信息。  
### 零比特填充的首尾标志法  
零比特填充法允许数据帧包含任意个数的比特，也允许每个字符的编码包含任意个数的比特。它使用一个特定的比特模式，即01111110来标志一帧的开始和结束。为了不使信息位中出现的比特流01111110被误判为帧的首尾标志，发送方的数据链路层在信息位中遇到5个连续的“1”时，将自动在其后插入一个“0”；而接收方做该过程的逆操作，即每收到5个连续的“1”时，自动删除后面紧跟的“0”，以恢复原信息。  
零比特填充法很容易用硬件来实现，性能优于字符填充法。  
### 违规编码法  
在物理层进行比特编码时，通常采用违规编码法。例如，曼彻斯特编码方法将数据比特“1”编码成“高-低”电平对，将数据比特“0”编码成“低-高”电平对，而“高-高”电平对和“低-低”电平对在数据比特中是违规的（即没有采用）。可以借助这些违规编码序列来定界帧的起始和终止。局域网IEEE 802标准就采用了这种方法。  
违规编码法不需要采用任何填充技术，便能实现数据传输的透明性，但它只适用于采用冗余编码的特殊编码环境。  
由于字节计数法中计数字段的脆弱性和字符填充法实现的复杂性和不兼容性，目前较常用的组帧方法是比特填充法和违规编码法。  

---  
## 差错控制  
实际通信链路都不是理想的，比特在传输过程中可能会产生差错，1可能会变成0，0可能会变成1，这就是比特差错。比特差错是传输差错中的一种。  
通常利用编码技术来进行差错控制，主要有两类：自动重传请求ARQ和前向纠错FEC。在ARQ方式中，接收端检测出现差错时，就设法通知发送端重发，直到接收到正确的码字为止。在FEC方式中，接收端不但能发现差错，而且能确定比特串的错误位置，从而加以纠正。因此，差错控制可分为检错编码和纠错编码。  
### 检错编码  
检错编码都采用冗余编码技术，其核心思想是在有效数据（信息位）被发送前，先按某种各系附加一定的冗余位，构成一个符合某一规则的码字后再发送。当要发送的有效数据变化时，相应的冗余位也随着变化，使得码字遵从不变的规则。接收端根据收到的码字是否仍符合原规则来判断是否出错。常见的检错编码有奇偶校验码和循环冗余码。  
+ 奇偶校验码  
  奇偶校验码是奇校验码和偶检验码的统称，是一种最基本的检错码。它由n-1位信息元和1位检验元组成，如果是奇校验码，那么在附加一个校验元后，码长为n的码字中“1”的个数为奇数；如果是偶校验码，那么在附加一个校验元后，码长为n的码字中“1”的个数为偶数。它又分为垂直奇偶校验、水平奇偶校验和水平垂直奇偶校验。  
+ 循环冗余码  
  循环冗余码Cyclic Redundancy Code又称多项式码，任何一个由二进制数位串组成的代码都可以与一个只含有0和1两个系数的多项式建立一一对应关系。一个k位帧可以视为从X<sup>k-1</sup>到X<sup>0</sup>的k次多项式的系数序列，这个多项式的阶数为k-1，高位是X<sup>k-1</sup>项的系数，下一位是X<sup>k-2</sup>的系数，以此类推。  
  给定一个m bit的帧或报文，发送器生成一个r bit的序列，称为帧校验序列FCS。这样所形成的帧将由m+r比特组成。发送方和接收方事先商定一个多项式G(x)（最高位和最低位必须为1），使这个带检验码的帧刚好能被预先确定的多项式G(x)整除。接收方用相同的多项式去除收到的帧，如果无余数，那么认为无差错。  
  假设一个帧有m位，其对应的多项式为M(x)，则计算冗余码的步骤如下：  
  + 加0。假设G(x)的阶为r，在帧的低位端上加上r个0  
  + 模2除。利用模2除法，用G(x)对应的数据串去除上一步计算出的数据串，得到的余数即为冗余码（共r位）  

  多项式以2为模运算。按照模2运算规则，加法不进位，减法不借位，它刚好是异或操作。  

### 纠错编码  
在数据通信过程中，解决差错问题的一种方法是在每个要发送的数据块上附加足够的冗余信息，使接收方能够推导出发送方实际送出的应该是什么样的比特串。最常见的纠错编码是海明码，其实现原理是在有效信息位中加入几个校验位形成海明码，并把海明码的每个二进制位分配到几个奇偶校验组中。当某一位出错后，就会引起有关的几个校验位的值发生变化，这不但可以发现错位，而且能指出错位的位置，为自动纠错提供依据。  
现以数据码1010为例讲述海明码的编码原理和实现过程。  
+ 确定海明码的位数  
  设n为有效信息位数，k为校验位的位数，则信息位n和校验位k应满足  
  *n+k<=2<sup>k</sup>-1*（若要检测两位错，则需要再增加一位校验位，即k+1位）  
  本例中4+3<=2<sup>3</sup>-1成立，则n=4,k=3有效。设信息位为D<sub>4</sub>D<sub>3</sub>D<sub>2</sub>D<sub>1</sub>(1010)，共4位，校验位为P<sub>3</sub>P<sub>2</sub>P<sub>1</sub>，共3位，对应的海明码为H<sub>7</sub>H<sub>6</sub>H<sub>5</sub>H<sub>4</sub>H<sub>3</sub>H<sub>2</sub>H<sub>1</sub>。  
+ 确定校验位的分布  
  规定校验位P<sub>i</sub>在海明位号为2<sup>i-1</sup>的位置上，其余各位为信息位，因此有：  
  P<sub>1</sub>的海明位号为2<sup>i-1</sup>=2<sup>0</sup>=1，即H<sub>1</sub>为P<sub>1</sub>  
  P<sub>2</sub>的海明位号为2<sup>i-1</sup>=2<sup>1</sup>=2，即H<sub>2</sub>为P<sub>2</sub>  
  P<sub>3</sub>的海明位号为2<sup>i-1</sup>=2<sup>2</sup>=4，即H<sub>4</sub>为P<sub>3</sub>  
  将信息位按原来的顺序插入，则海明码各位的分布如下：  

  |H<sub>7</sub>|H<sub>6</sub>|H<sub>5</sub>|H<sub>4</sub>|H<sub>3</sub>|H<sub>2</sub>|H<sub>1</sub>|  
  |---|---|---|---|---|---|---|  
  |D<sub>4</sub>|D<sub>3</sub>|D<sub>2</sub>|P<sub>3</sub>|D<sub>1</sub>|P<sub>2</sub>|P<sub>1</sub>|  

+ 分组形成校验关系  
  每个数据位用多个校验位进行校验，但要满足条件；被校验数据位的海明位号等于校验该数据位的各校验位海明位号之和。另外，校验位不需要再被校验。分组形成的校验关系如下：  
  D<sub>1</sub>所在海明位号3 = 2 + 1  
  D<sub>2</sub>所在海明位号5 = 4 + 1  
  D<sub>3</sub>所在海明位号6 = 4 + 2  
  D<sub>4</sub>所在海明位号7 = 4 + 2 + 1  
+ 校验位取值  
  校验位P<sub>i</sub>的值为第i组（由该校验位校验的数据位）所有位求异或。  
  P<sub>1</sub>=D<sub>1</sub>⊕D<sub>2</sub>⊕D<sub>4</sub>=0⊕1⊕1=0  
  P<sub>2</sub>=D<sub>1</sub>⊕D<sub>3</sub>⊕D<sub>4</sub>=0⊕0⊕1=1  
  P<sub>3</sub>=D<sub>2</sub>⊕D<sub>3</sub>⊕D<sub>4</sub>=1⊕0⊕1=0  
  所以，1010对应的海明码为101**0**0**10**。  
+ 海明码的校验原理  
  每个校验组分别利用校验位和参与形成该校验位的信息位进行奇偶校验检查，构成k个校验方程：  
  S<sub>1</sub> = P<sub>1</sub>⊕D<sub>1</sub>⊕D<sub>2</sub>⊕D<sub>4</sub>  \
  S<sub>2</sub> = P<sub>2</sub>⊕D<sub>1</sub>⊕D<sub>3</sub>⊕D<sub>4</sub>  
  S<sub>3</sub> = P<sub>3</sub>⊕D<sub>2</sub>⊕D<sub>3</sub>⊕D<sub>4</sub>  
  若S<sub>3</sub>S<sub>2</sub>S<sub>2</sub>的值为“000”，则说明无错；否则说明出错，且这个数就是错误位的位号。直接将该位取反就达到了纠错的目的。  

---  
## 流量控制与可靠传输机制  
### 流量控制、可靠传输与滑动窗口机制  
流量控制涉及对链路上的帧的发送速率的控制，以使接收方有足够的缓冲空间来接收每个帧。例如，在面向帧的自动重传请求系统中，当待确认帧的数量增加时，有可能超出缓冲存储空间而造成过载。流量控制的基本方法是由接收方控制发送方发送数据的速率，常见的方式有两种：停止-等待协议和滑动窗口协议。  
#### 停止-等待流量控制基本原理  
发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧；接收方每接收一帧，就要反馈一个应答信号，表示棵接收下一帧，如果接收方不反馈应答信号，那么发送方必须一直等待，每次仅允许发送一帧，然后就陷入等待接收方确认消息的过程中，因而传输效率很低。  
#### 滑动窗口流量控制基本原理  
在任意时刻，发送方都维持一组连续的允许发送的帧的序号，称为发送窗口；同时接收方也维持一组连续的允许接收帧的序号，称为接收窗口。发送窗口用来对发送窗口进行流量控制，而发送窗口的大小W<sub>T</sub>代表还未收到确认信息的情况下发送方最多还可以发送多少个数据帧。同理，在接收端设置接收窗口是为了控制可以接收哪些数据帧和不可以接收哪些数据帧。在接收方，只有收到的数据帧的序号落入接收窗口内时，才允许将该数据帧收下。若接收到的数据帧落在接收窗口之外，则一律将其丢弃。  
发送端每收到一个确认帧，发送窗口就向前滑动一个帧的位置，当发送窗口内没有可以发送的帧（即窗口内帧全部是已发送但未收到确认的帧）时，发送方就会停止发送，直到收到接收方发送的确认帧使窗口移动，窗口内有可以发送的帧后，才开始继续发送。  
接收端收到数据帧后，将窗口向前移动一个位置，并发回确认帧，若收到的数据帧落在接收窗口之外，则一律丢弃。  
滑动窗口有以下重要特性：  
+ 只有接收窗口向前滑动（同时接收方发送了确认帧）时，发送窗口才有可能（只有发送方收到确认帧后才一定）向前滑动。  
+ 从滑动窗口的概念看，停止-等待协议、后退N帧协议和选择重传协议只在发送窗口大小与接收窗口大小上有所差别：  
  - 停止-等待协议：发送窗口大小=1，接收窗口大小=1。  
  - 后退N帧协议：发送窗口大小>1，接收窗口大小=1。  
  - 选择重传协议：发送窗口大小>1，接收窗口大小>1。

+ 接收窗口的大小=1时，可保证帧的有序接收。  
+ 数据链路层的滑动窗口协议中，窗口的大小在传输过程中是固定的。  

#### 可靠传输机制  
数据链路层的可靠传输通常使用确认和超时重传两种机制来完成。确认是一种无数据的控制帧，这种控制帧使得接收方可以让发送方知道哪些内容被正确接收。有些情况下为了提高传输效率，将确认捎带在一个回复帧中，称为捎带确认。超时重传是指发送方在发送某个数据帧后就开启一个计时器，在一定时间内如果没有得到发送的数据帧的确认帧，那么就重新发送该数据帧，直到发送成功为止。  
自动重传请求Auto Repeat reQuest通过接收方请求发送方重传出错的数据帧来恢复出错的帧，是通信中用于处理信道所带来差错的方法之一。传统自动重传请求分为三种，即停止-等待ARQ、后退N帧ARQ和选择性重传ARQ。后两种协议是滑动窗口技术与请求重发技术的结合，由于窗口尺寸开到足够大，帧在线路上可以连续地流动，因此又称其为连续ARQ协议。注意，在数据链路层中流量控制机制和可靠传输机制是交织在一起的。  

### 单帧滑动窗口与停止-等待协议  
在停止等待协议中，源站发送单个帧后必须停止等待，在目的站的回答到达源站之前，源站不能发送其他的数据帧。从滑动窗口机制的角度看，停止-等待协议相当于发送窗口和接收窗口大小均等于1的滑动窗口协议。  
在停止-等待协议中，除数据帧丢失外，还可能出现以下两种差错：  
+ 到达目的站的帧可能已遭到破坏，接收站利用差错检测技术检出之后，简单地将该帧丢弃。为了对付这种可能发生的情况，源站装备了计时器。在一个帧发送之后，源站等待确认，如果在计时器计满时仍未收到确认，那么再次发送相同的帧。如此反复，直到该数据帧无错误地到达为止。  
+ 数据帧正确而确认帧被破坏，此时接收方已收到正确的数据，但发送方收不到确认帧，因此发送方会重传已被接收的数据帧，接收方收到同样的数据帧时会丢弃该帧，并重传一个该帧对应的确认帧。发送的帧交替地使用0和1来标识，肯定确认分别用ACK0和ACK1来表示，收到的确认有误时，重传已经发送的帧。对于停止-等待协议，由于每发送一个数据帧就停止并等待，因此用1bit来编号就已足够。在停止-等待协议中，若连续出现相同发送序号的数据帧，表明发送端进行了超时重传。连续出现相同序号的确认帧时，表明接收端收到了重复帧。  

此外，为了超时重发和判定重复帧的需要，发送方和接收方都需设置一个帧缓冲区。发送端在发送完数据帧时，必须在其发送缓存中保存此数据帧的副本，这样才能在出差错时进行重传。只有在收到对方发来的确认帧ACK时，才清除此副本。  

### 多帧滑动窗口与后退N帧协议GBN  
在后退N帧ARQ中，发送方无须在收到上一个帧的ACK后才能开始发送下一帧，而是可以连续发送帧。当接收方检测出失序的信息帧后，要求发送方重发最后一个正确接收的信息帧之后的所有未被确认的帧；或者当发送方发送了N个帧后，若发现该N个帧的前一个帧在计时器超时后仍未返回其确认信息，则该帧被判为出错或丢失，此时发送方就不得不重传该出错帧及随后的N个帧。  
源站向目的站发送数据帧，源站每发送完一帧就为该帧设置一个超时计时器。由于连续发送了许多帧，所以确认帧必须要指明是对哪一帧进行确认。为了减少开销，GBN协议还规定接收端不一定每收到一个正确的数据帧就必须立即发回一个确认帧，而可以在连续收到好几个正确的数据帧后，才对最后一个数据帧发确认信息，或者可在自己有数据要发送时才将以前正确收到的帧加以捎带确认。这就是说，对某一数据帧的确认就表明该数据帧和此前所有的数据帧均已正确无误地收到。接收端只按序接收数据帧。如：接收端在接收数据帧时，在有差错的2号帧后又收到了几个正确的数据帧，但接收端必须把这些数据帧丢弃。另外，接收端虽然丢弃了这些不按序的无差错帧，但应重复发送已发送的最后一个确认帧ACK1（为了防止已发送的确认帧ACK1丢失，其中ACKn表示对第n帧的确认，即接收方已正确接收到第n号帧及以前的所有帧）。  
后退N帧协议的接收串口为1，可以保证按序接收数据帧。若采用n比特对帧编号，则其发送窗口的尺寸W<sub>T</sub>应满足1<=W<sub>T</sub><=2<sup>n</sup>。若发送窗口的尺寸大于2<sup>n</sup>-1，则会造成接收方无法分辨新帧和旧帧。  
后退N帧协议一方面因连续发送数据帧而提高了信道的利用率，另一方面在重传发面又必须把原来已传送正确的数据帧进行重传，这种做法又使效率降低。由此可见，**若信道传输质量很差导致误码率较大时，后退N帧协议不一定优于停止-等待协议。**